"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _simulatorXcode = require("./simulator-xcode-6");

var _simulatorXcode2 = _interopRequireDefault(require("./simulator-xcode-7"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

var _teen_process = require("teen_process");

var _geolocation = require("./geolocation");

var _appiumSupport = require("appium-support");

var _utils = require("./utils");

const STARTUP_TIMEOUT = 120 * 1000;

const PROCESS_LAUNCH_OK_PATTERN = bundleId => new RegExp(`${bundleId.replace('.', '\\.')}:\\s+\\d+`);

class SimulatorXcode8 extends _simulatorXcode2.default {
  constructor(udid, xcodeVersion) {
    super(udid, xcodeVersion);
    this.isFreshFiles = ['Library/Cookies', 'Library/Preferences/.GlobalPreferences.plist', 'Library/Preferences/com.apple.springboard.plist', 'var/run/syslog.pid'];
    this._idb = null;
    this._locationMenu = 'Debug';
  }

  set idb(value) {
    this._idb = value;
  }

  get idb() {
    return this._idb;
  }

  async killUIClient(opts = {}) {
    let {
      pid,
      signal = 2
    } = opts;
    pid = pid || (await this.getUIClientPid());

    if (!pid) {
      return false;
    }

    _logger.default.debug(`Sending ${signal} kill signal to Simulator UI client with PID ${pid}`);

    try {
      await (0, _teen_process.exec)('kill', [`-${signal}`, pid]);
      return true;
    } catch (e) {
      if (e.code === 1) {
        return false;
      }

      throw new Error(`Cannot kill the Simulator UI client. Original error: ${e.message}`);
    }
  }

  async isAppInstalled(bundleId) {
    try {
      const appContainer = await this.simctl.getAppContainer(bundleId);
      return appContainer.endsWith('.app');
    } catch (err) {
      try {
        const info = await this.simctl.appInfo(bundleId);
        return info.includes('ApplicationType');
      } catch (e) {
        return false;
      }
    }
  }

  get startupTimeout() {
    return STARTUP_TIMEOUT;
  }

  async waitForBoot(startupTimeout) {
    await this.simctl.startBootMonitor({
      timeout: startupTimeout
    });
    this.emit(_simulatorXcode.BOOT_COMPLETED_EVENT);
  }

  async openUrl(url) {
    if (!(await this.isRunning())) {
      throw new Error(`Tried to open '${url}', but Simulator is not in Booted state`);
    }

    const timer = new _appiumSupport.timing.Timer().start();
    let lastError = null;

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        try {
          const stdout = await this.simctl.launchApp(_utils.MOBILE_SAFARI_BUNDLE_ID);

          if (PROCESS_LAUNCH_OK_PATTERN(_utils.MOBILE_SAFARI_BUNDLE_ID).test(stdout)) {
            await this.simctl.openUrl(url);
            return true;
          }
        } catch (err) {
          _logger.default.warn(`Failed to open '${url}' in Safari. Retrying...`);

          lastError = err.stderr || err.message;
        }

        return false;
      }, {
        waitMs: _utils.SAFARI_STARTUP_TIMEOUT,
        intervalMs: 500
      });
    } catch (err) {
      throw new Error(`Safari cannot open '${url}' after ${timer.getDuration().asSeconds.toFixed(3)}s ` + `because of: ${lastError || 'an unknown error'}`);
    }

    _logger.default.debug(`Safari successfully opened '${url}' in ${timer.getDuration().asSeconds.toFixed(3)}s`);
  }

  async cleanSafari(keepPrefs = true) {
    try {
      if (await this.isRunning()) {
        await this.simctl.terminateApp(_utils.MOBILE_SAFARI_BUNDLE_ID);
      }
    } catch (ign) {}

    await super.cleanSafari(keepPrefs);
  }

  async cleanCustomApp(appFile, appBundleId, scrub = false) {
    try {
      await this.simctl.terminateApp(appBundleId);
    } catch (ign) {}

    await super.cleanCustomApp(appFile, appBundleId, scrub);
  }

  async shake() {
    _logger.default.info(`Performing shake gesture on ${this.udid} Simulator`);

    await this.simctl.spawnProcess(['notifyutil', '-p', 'com.apple.UIKit.SimulatorShake']);
  }

  async _activateWindow() {
    if (this.idb) {
      return await this.idb.focusSimulator();
    }

    _logger.default.warn(`Cannot focus Simulator window with idb. Defaulting to AppleScript`);

    return await super._activateWindow();
  }

  async isBiometricEnrolled() {
    const output = await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
        end tell
      end tell
    `);

    _logger.default.debug(`Touch ID enrolled state: ${output}`);

    return _lodash.default.isString(output) && output.trim() === 'true';
  }

  async enrollBiometric(isEnabled = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
          if ${isEnabled ? 'not ' : ''}isChecked then
            click dstMenuItem
          end if
        end tell
      end tell
    `);
  }

  async sendBiometricMatch(shouldMatch = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "${shouldMatch ? 'Matching Touch' : 'Non-matching Touch'}" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          click dstMenuItem
        end tell
      end tell
    `);
  }

  async setGeolocation(latitude, longitude) {
    const locationSetters = [async () => await (0, _geolocation.setLocationWithLyft)(this.udid, latitude, longitude), async () => await (0, _geolocation.setLocationWithIdb)(this.idb, latitude, longitude), async () => await (0, _geolocation.setLocationWithAppleScript)(this, latitude, longitude, this._locationMenu)];
    let lastError;

    for (const setter of locationSetters) {
      try {
        await setter();
        return true;
      } catch (e) {
        _logger.default.info(e.message);

        lastError = e;
      }
    }

    throw lastError;
  }

}

var _default = SimulatorXcode8;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOC5qcyJdLCJuYW1lcyI6WyJTVEFSVFVQX1RJTUVPVVQiLCJQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOIiwiYnVuZGxlSWQiLCJSZWdFeHAiLCJyZXBsYWNlIiwiU2ltdWxhdG9yWGNvZGU4IiwiU2ltdWxhdG9yWGNvZGU3IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwieGNvZGVWZXJzaW9uIiwiaXNGcmVzaEZpbGVzIiwiX2lkYiIsIl9sb2NhdGlvbk1lbnUiLCJpZGIiLCJ2YWx1ZSIsImtpbGxVSUNsaWVudCIsIm9wdHMiLCJwaWQiLCJzaWduYWwiLCJnZXRVSUNsaWVudFBpZCIsImxvZyIsImRlYnVnIiwiZSIsImNvZGUiLCJFcnJvciIsIm1lc3NhZ2UiLCJpc0FwcEluc3RhbGxlZCIsImFwcENvbnRhaW5lciIsInNpbWN0bCIsImdldEFwcENvbnRhaW5lciIsImVuZHNXaXRoIiwiZXJyIiwiaW5mbyIsImFwcEluZm8iLCJpbmNsdWRlcyIsInN0YXJ0dXBUaW1lb3V0Iiwid2FpdEZvckJvb3QiLCJzdGFydEJvb3RNb25pdG9yIiwidGltZW91dCIsImVtaXQiLCJCT09UX0NPTVBMRVRFRF9FVkVOVCIsIm9wZW5VcmwiLCJ1cmwiLCJpc1J1bm5pbmciLCJ0aW1lciIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJsYXN0RXJyb3IiLCJzdGRvdXQiLCJsYXVuY2hBcHAiLCJNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCIsInRlc3QiLCJ3YXJuIiwic3RkZXJyIiwid2FpdE1zIiwiU0FGQVJJX1NUQVJUVVBfVElNRU9VVCIsImludGVydmFsTXMiLCJnZXREdXJhdGlvbiIsImFzU2Vjb25kcyIsInRvRml4ZWQiLCJjbGVhblNhZmFyaSIsImtlZXBQcmVmcyIsInRlcm1pbmF0ZUFwcCIsImlnbiIsImNsZWFuQ3VzdG9tQXBwIiwiYXBwRmlsZSIsImFwcEJ1bmRsZUlkIiwic2NydWIiLCJzaGFrZSIsInNwYXduUHJvY2VzcyIsIl9hY3RpdmF0ZVdpbmRvdyIsImZvY3VzU2ltdWxhdG9yIiwiaXNCaW9tZXRyaWNFbnJvbGxlZCIsIm91dHB1dCIsImV4ZWN1dGVVSUNsaWVudFNjcmlwdCIsIl8iLCJpc1N0cmluZyIsInRyaW0iLCJlbnJvbGxCaW9tZXRyaWMiLCJpc0VuYWJsZWQiLCJzZW5kQmlvbWV0cmljTWF0Y2giLCJzaG91bGRNYXRjaCIsInNldEdlb2xvY2F0aW9uIiwibGF0aXR1ZGUiLCJsb25naXR1ZGUiLCJsb2NhdGlvblNldHRlcnMiLCJzZXR0ZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBSUE7O0FBQ0E7O0FBSUEsTUFBTUEsZUFBZSxHQUFHLE1BQU0sSUFBOUI7O0FBQ0EsTUFBTUMseUJBQXlCLEdBQUlDLFFBQUQsSUFBYyxJQUFJQyxNQUFKLENBQVksR0FBRUQsUUFBUSxDQUFDRSxPQUFULENBQWlCLEdBQWpCLEVBQXNCLEtBQXRCLENBQTZCLFdBQTNDLENBQWhEOztBQUVBLE1BQU1DLGVBQU4sU0FBOEJDLHdCQUE5QixDQUE4QztBQUM1Q0MsRUFBQUEsV0FBVyxDQUFFQyxJQUFGLEVBQVFDLFlBQVIsRUFBc0I7QUFDL0IsVUFBTUQsSUFBTixFQUFZQyxZQUFaO0FBS0EsU0FBS0MsWUFBTCxHQUFvQixDQUNsQixpQkFEa0IsRUFFbEIsOENBRmtCLEVBR2xCLGlEQUhrQixFQUlsQixvQkFKa0IsQ0FBcEI7QUFNQSxTQUFLQyxJQUFMLEdBQVksSUFBWjtBQUlBLFNBQUtDLGFBQUwsR0FBcUIsT0FBckI7QUFDRDs7QUFPRCxNQUFJQyxHQUFKLENBQVNDLEtBQVQsRUFBZ0I7QUFDZCxTQUFLSCxJQUFMLEdBQVlHLEtBQVo7QUFDRDs7QUFLRCxNQUFJRCxHQUFKLEdBQVc7QUFDVCxXQUFPLEtBQUtGLElBQVo7QUFDRDs7QUFpQkQsUUFBTUksWUFBTixDQUFvQkMsSUFBSSxHQUFHLEVBQTNCLEVBQStCO0FBQzdCLFFBQUk7QUFDRkMsTUFBQUEs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UUFBakMsRUFBMkNDLFNBQTNDLEVBQXNELEtBQUt6RSxhQUEzRCxDQUhJLENBQXhCO0FBTUEsUUFBSW9DLFNBQUo7O0FBQ0EsU0FBSyxNQUFNdUMsTUFBWCxJQUFxQkQsZUFBckIsRUFBc0M7QUFDcEMsVUFBSTtBQUNGLGNBQU1DLE1BQU0sRUFBWjtBQUNBLGVBQU8sSUFBUDtBQUNELE9BSEQsQ0FHRSxPQUFPakUsQ0FBUCxFQUFVO0FBQ1ZGLHdCQUFJWSxJQUFKLENBQVNWLENBQUMsQ0FBQ0csT0FBWDs7QUFDQXVCLFFBQUFBLFNBQVMsR0FBRzFCLENBQVo7QUFDRDtBQUNGOztBQUNELFVBQU0wQixTQUFOO0FBQ0Q7O0FBbFMyQzs7ZUFxUy9CM0MsZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJPT1RfQ09NUExFVEVEX0VWRU5UIH0gZnJvbSAnLi9zaW11bGF0b3IteGNvZGUtNic7XG5pbXBvcnQgU2ltdWxhdG9yWGNvZGU3IGZyb20gJy4vc2ltdWxhdG9yLXhjb2RlLTcnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHtcbiAgc2V0TG9jYXRpb25XaXRoTHlmdCxcbiAgc2V0TG9jYXRpb25XaXRoSWRiLFxuICBzZXRMb2NhdGlvbldpdGhBcHBsZVNjcmlwdCB9IGZyb20gJy4vZ2VvbG9jYXRpb24nO1xuaW1wb3J0IHsgdGltaW5nIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQsIFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQgfSBmcm9tICcuL3V0aWxzJztcblxuXG4vLyB0aGVzZSBzaW1zIGFyZSBzbG9vb29vb29vd1xuY29uc3QgU1RBUlRVUF9USU1FT1VUID0gMTIwICogMTAwMDtcbmNvbnN0IFBST0NFU1NfTEFVTkNIX09LX1BBVFRFUk4gPSAoYnVuZGxlSWQpID0+IG5ldyBSZWdFeHAoYCR7YnVuZGxlSWQucmVwbGFjZSgnLicsICdcXFxcLicpfTpcXFxccytcXFxcZCtgKTtcblxuY2xhc3MgU2ltdWxhdG9yWGNvZGU4IGV4dGVuZHMgU2ltdWxhdG9yWGNvZGU3IHtcbiAgY29uc3RydWN0b3IgKHVkaWQsIHhjb2RlVmVyc2lvbikge1xuICAgIHN1cGVyKHVkaWQsIHhjb2RlVmVyc2lvbik7XG5cbiAgICAvLyBsaXN0IG9mIGZpbGVzIHRvIGNoZWNrIGZvciB3aGVuIHNlZWluZyBpZiBhIHNpbXVsYXRvciBpcyBcImZyZXNoXCJcbiAgICAvLyAobWVhbmluZyBpdCBoYXMgbmV2ZXIgYmVlbiBib290ZWQpLlxuICAgIC8vIElmIHRoZXNlIGZpbGVzIGFyZSBwcmVzZW50LCB3ZSBhc3N1bWUgaXQncyBiZWVuIHN1Y2Nlc3NmdWxseSBib290ZWRcbiAgICB0aGlzLmlzRnJlc2hGaWxlcyA9IFtcbiAgICAgICdMaWJyYXJ5L0Nvb2tpZXMnLFxuICAgICAgJ0xpYnJhcnkvUHJlZmVyZW5jZXMvLkdsb2JhbFByZWZlcmVuY2VzLnBsaXN0JyxcbiAgICAgICdMaWJyYXJ5L1ByZWZlcmVuY2VzL2NvbS5hcHBsZS5zcHJpbmdib2FyZC5wbGlzdCcsXG4gICAgICAndmFyL3J1bi9zeXNsb2cucGlkJ1xuICAgIF07XG4gICAgdGhpcy5faWRiID0gbnVsbDtcblxuICAgIC8vIGZvciBzZXR0aW5nIHRoZSBsb2NhdGlvbiB1c2luZyBBcHBsZVNjcmlwdCwgdGhlIHRvcC1sZXZlbCBtZW51IHRocm91Z2ggd2hpY2hcbiAgICAvLyB0aGUgJ0xvY2F0aW9uJyBvcHRpb24gaXMgZm91bmRcbiAgICB0aGlzLl9sb2NhdGlvbk1lbnUgPSAnRGVidWcnO1xuICB9XG5cbiAgLyoqXG4gICAqIElEQiBpbnN0YW5jZSBzZXR0ZXJcbiAgICpcbiAgICogQHBhcmFtIHtJREJ9IHZhbHVlXG4gICAqL1xuICBzZXQgaWRiICh2YWx1ZSkge1xuICAgIHRoaXMuX2lkYiA9IHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm4ge0lEQn0gaWRiIGluc3RhbmNlXG4gICAqL1xuICBnZXQgaWRiICgpIHtcbiAgICByZXR1cm4gdGhpcy5faWRiO1xuICB9XG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IGtpbGxPcHRzXG4gICAqIEBwcm9wZXJ0eSB7P251bWJlcnxzdHJpbmd9IHBpZCAtIFByb2Nlc3MgaWQgb2YgdGhlIFVJIFNpbXVsYXRvciB3aW5kb3dcbiAgICogQHByb3BlcnR5IHtudW1iZXJ8c3RyaW5nfSBzaWduYWwgWzJdIC0gVGhlIHNpZ25hbCBudW1iZXIgdG8gc2VuZCB0byB0aGVcbiAgICogYGtpbGxgIGNvbW1hbmRcbiAgICovXG5cbiAgLyoqXG4gICAqIEtpbGwgdGhlIFVJIGNsaWVudCBpZiBpdCBpcyBydW5uaW5nLlxuICAgKlxuICAgKiBAcGFyYW0gez9raWxsT3B0c30gb3B0c1xuICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBVSSBjbGllbnQgd2FzIHN1Y2Nlc3NmdWxseSBraWxsZWQgb3IgZmFsc2VcbiAgICogICAgICAgICAgICAgICAgICAgaWYgaXQgaXMgbm90IHJ1bm5pbmcuXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzZW5kaW5nIHRoZSBzaWduYWwgdG8gdGhlIGNsaWVudCBwcm9jZXNzIGZhaWxzXG4gICAqL1xuICBhc3luYyBraWxsVUlDbGllbnQgKG9wdHMgPSB7fSkge1xuICAgIGxldCB7XG4gICAgICBwaWQsXG4gICAgICBzaWduYWwgPSAyLFxuICAgIH0gPSBvcHRzO1xuICAgIHBpZCA9IHBpZCB8fCBhd2FpdCB0aGlzLmdldFVJQ2xpZW50UGlkKCk7XG4gICAgaWYgKCFwaWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFNlbmRpbmcgJHtzaWduYWx9IGtpbGwgc2lnbmFsIHRvIFNpbXVsYXRvciBVSSBjbGllbnQgd2l0aCBQSUQgJHtwaWR9YCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBbYC0ke3NpZ25hbH1gLCBwaWRdKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlLmNvZGUgPT09IDEpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qga2lsbCB0aGUgU2ltdWxhdG9yIFVJIGNsaWVudC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgd2hldGhlciB0aGUgcGFydGljdWxhciBhcHBsaWNhdGlvbiBpcyBpbnN0YWxsZWQgb24gU2ltdWxhdG9yLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZUlkIC0gVGhlIGJ1bmRsZSBpZCBvZiB0aGUgYXBwbGljYXRpb24gdG8gYmUgY2hlY2tlZC5cbiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gYXBwbGljYXRpb24gaXMgaW5zdGFsbGVkLlxuICAgKi9cbiAgYXN5bmMgaXNBcHBJbnN0YWxsZWQgKGJ1bmRsZUlkKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFwcENvbnRhaW5lciA9IGF3YWl0IHRoaXMuc2ltY3RsLmdldEFwcENvbnRhaW5lcihidW5kbGVJZCk7XG4gICAgICByZXR1cm4gYXBwQ29udGFpbmVyLmVuZHNXaXRoKCcuYXBwJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBnZXRfYXBwX2NvbnRhaW5lciBzdWJjb21tYW5kIGZhaWxzIGZvciBzeXN0ZW0gYXBwbGljYXRpb25zLFxuICAgICAgLy8gc28gd2UgdHJ5IHRoZSBoaWRkZW4gYXBwaW5mbyBzdWJjb21tYW5kLCB3aGljaCBwcmludHMgY29ycmVjdCBpbmZvIGZvclxuICAgICAgLy8gc3lzdGVtL2hpZGRlbiBhcHBzXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5zaW1jdGwuYXBwSW5mbyhidW5kbGVJZCk7XG4gICAgICAgIHJldHVybiBpbmZvLmluY2x1ZGVzKCdBcHBsaWNhdGlvblR5cGUnKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBtYXggbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIFNpbXVsYXRvciBib290aW5nIGlzIGNvbXBsZXRlZC5cbiAgICovXG4gIGdldCBzdGFydHVwVGltZW91dCAoKSB7XG4gICAgcmV0dXJuIFNUQVJUVVBfVElNRU9VVDtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgd2hldGhlciB0aGUgU2ltdWxhdG9yIGJvb3RpbmcgaXMgY29tcGxldGVkIGFuZC9vciB3YWl0IGZvciBpdFxuICAgKiB1bnRpbCB0aGUgdGltZW91dCBleHBpcmVzLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0dXBUaW1lb3V0IC0gdGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCBib290aW5nIGlzIGNvbXBsZXRlZC5cbiAgICogQGVtaXRzIEJPT1RfQ09NUExFVEVEX0VWRU5UIGlmIHRoZSBjdXJyZW50IFNpbXVsYXRvciBpcyByZWFkeSB0byBhY2NlcHQgc2ltY3RsIGNvbW1hbmRzLCBsaWtlICdpbnN0YWxsJy5cbiAgICovXG4gIGFzeW5jIHdhaXRGb3JCb290IChzdGFydHVwVGltZW91dCkge1xuICAgIGF3YWl0IHRoaXMuc2ltY3RsLnN0YXJ0Qm9vdE1vbml0b3Ioe3RpbWVvdXQ6IHN0YXJ0dXBUaW1lb3V0fSk7XG4gICAgdGhpcy5lbWl0KEJPT1RfQ09NUExFVEVEX0VWRU5UKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVuIHRoZSBnaXZlbiBVUkwgaW4gbW9iaWxlIFNhZmFyaSBicm93c2VyLlxuICAgKiBUaGUgYnJvd3NlciB3aWxsIGJlIHN0YXJ0ZWQgYXV0b21hdGljYWxseSBpZiBpdCBpcyBub3QgcnVubmluZy5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBUaGUgVVJMIHRvIGJlIG9wZW5lZC5cbiAgICovXG4gIGFzeW5jIG9wZW5VcmwgKHVybCkge1xuICAgIGlmICghYXdhaXQgdGhpcy5pc1J1bm5pbmcoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcmllZCB0byBvcGVuICcke3VybH0nLCBidXQgU2ltdWxhdG9yIGlzIG5vdCBpbiBCb290ZWQgc3RhdGVgKTtcbiAgICB9XG4gICAgY29uc3QgdGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcbiAgICBsZXQgbGFzdEVycm9yID0gbnVsbDtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gVGhpcyBpcyB0byBtYWtlIHN1cmUgU2FmYXJpIGlzIGFscmVhZHkgcnVubmluZ1xuICAgICAgICAgIGNvbnN0IHN0ZG91dCA9IGF3YWl0IHRoaXMuc2ltY3RsLmxhdW5jaEFwcChNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCk7XG4gICAgICAgICAgaWYgKFBST0NFU1NfTEFVTkNIX09LX1BBVFRFUk4oTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQpLnRlc3Qoc3Rkb3V0KSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5zaW1jdGwub3BlblVybCh1cmwpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsb2cud2FybihgRmFpbGVkIHRvIG9wZW4gJyR7dXJsfScgaW4gU2FmYXJpLiBSZXRyeWluZy4uLmApO1xuICAgICAgICAgIGxhc3RFcnJvciA9IGVyci5zdGRlcnIgfHwgZXJyLm1lc3NhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSwge3dhaXRNczogU0FGQVJJX1NUQVJUVVBfVElNRU9VVCwgaW50ZXJ2YWxNczogNTAwfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNhZmFyaSBjYW5ub3Qgb3BlbiAnJHt1cmx9JyBhZnRlciAke3RpbWVyLmdldER1cmF0aW9uKCkuYXNTZWNvbmRzLnRvRml4ZWQoMyl9cyBgICtcbiAgICAgICAgYGJlY2F1c2Ugb2Y6ICR7bGFzdEVycm9yIHx8ICdhbiB1bmtub3duIGVycm9yJ31gKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBTYWZhcmkgc3VjY2Vzc2Z1bGx5IG9wZW5lZCAnJHt1cmx9JyBpbiAke3RpbWVyLmdldER1cmF0aW9uKCkuYXNTZWNvbmRzLnRvRml4ZWQoMyl9c2ApO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFuIHVwIHRoZSBkaXJlY3RvcmllcyBmb3IgbW9iaWxlIFNhZmFyaS5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0ga2VlcFByZWZzIC0gV2hldGhlciB0byBrZWVwIFNhZmFyaSBwcmVmZXJlbmNlcyBmcm9tIGJlaW5nIGRlbGV0ZWQuXG4gICAqL1xuICBhc3luYyBjbGVhblNhZmFyaSAoa2VlcFByZWZzID0gdHJ1ZSkge1xuICAgIHRyeSB7XG4gICAgICBpZiAoYXdhaXQgdGhpcy5pc1J1bm5pbmcoKSkge1xuICAgICAgICBhd2FpdCB0aGlzLnNpbWN0bC50ZXJtaW5hdGVBcHAoTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGlnbikge1xuICAgICAgLy8gaWdub3JlIGVycm9yXG4gICAgfVxuICAgIGF3YWl0IHN1cGVyLmNsZWFuU2FmYXJpKGtlZXBQcmVmcyk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW4vc2NydWIgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gb24gU2ltdWxhdG9yLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEZpbGUgLSBBcHBsaWNhdGlvbiBuYW1lIG1pbnVzIFwiLmFwcFwiLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYXBwQnVuZGxlSWQgLSBCdW5kbGUgaWRlbnRpZmllciBvZiB0aGUgYXBwbGljYXRpb24uXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gc2NydWIgLSBJZiBgc2NydWJgIGlzIGZhbHNlLCB3ZSB3YW50IHRvIGNsZWFuIGJ5IGRlbGV0aW5nIHRoZSBhcHAgYW5kIGFsbFxuICAgKiAgIGZpbGVzIGFzc29jaWF0ZWQgd2l0aCBpdC4gSWYgYHNjcnViYCBpcyB0cnVlLCB3ZSBqdXN0IHdhbnQgdG8gZGVsZXRlIHRoZSBwcmVmZXJlbmNlcyBhbmRcbiAgICogICBjaGFuZ2VkIGZpbGVzLlxuICAgKi9cbiAgYXN5bmMgY2xlYW5DdXN0b21BcHAgKGFwcEZpbGUsIGFwcEJ1bmRsZUlkLCBzY3J1YiA9IGZhbHNlKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuc2ltY3RsLnRlcm1pbmF0ZUFwcChhcHBCdW5kbGVJZCk7XG4gICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAvLyBpZ25vcmUgZXJyb3JcbiAgICB9XG4gICAgYXdhaXQgc3VwZXIuY2xlYW5DdXN0b21BcHAoYXBwRmlsZSwgYXBwQnVuZGxlSWQsIHNjcnViKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIFNoYWtlIGdlc3R1cmUgb24gU2ltdWxhdG9yIHdpbmRvdy5cbiAgICovXG4gIGFzeW5jIHNoYWtlICgpIHtcbiAgICBsb2cuaW5mbyhgUGVyZm9ybWluZyBzaGFrZSBnZXN0dXJlIG9uICR7dGhpcy51ZGlkfSBTaW11bGF0b3JgKTtcbiAgICBhd2FpdCB0aGlzLnNpbWN0bC5zcGF3blByb2Nlc3MoW1xuICAgICAgJ25vdGlmeXV0aWwnLFxuICAgICAgJy1wJywgJ2NvbS5hcHBsZS5VSUtpdC5TaW11bGF0b3JTaGFrZSdcbiAgICBdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICogQHByaXZhdGVcbiAgICovXG4gIGFzeW5jIF9hY3RpdmF0ZVdpbmRvdyAoKSB7XG4gICAgaWYgKHRoaXMuaWRiKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5pZGIuZm9jdXNTaW11bGF0b3IoKTtcbiAgICB9XG4gICAgbG9nLndhcm4oYENhbm5vdCBmb2N1cyBTaW11bGF0b3Igd2luZG93IHdpdGggaWRiLiBEZWZhdWx0aW5nIHRvIEFwcGxlU2NyaXB0YCk7XG4gICAgcmV0dXJuIGF3YWl0IHN1cGVyLl9hY3RpdmF0ZVdpbmRvdygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgaXNCaW9tZXRyaWNFbnJvbGxlZCAoKSB7XG4gICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgdGhpcy5leGVjdXRlVUlDbGllbnRTY3JpcHQoYFxuICAgICAgdGVsbCBhcHBsaWNhdGlvbiBcIlN5c3RlbSBFdmVudHNcIlxuICAgICAgICB0ZWxsIHByb2Nlc3MgXCJTaW11bGF0b3JcIlxuICAgICAgICAgIHNldCBkc3RNZW51SXRlbSB0byBtZW51IGl0ZW0gXCJUb2dnbGUgRW5yb2xsZWQgU3RhdGVcIiBvZiBtZW51IDEgb2YgbWVudSBpdGVtIFwiVG91Y2ggSURcIiBvZiBtZW51IDEgb2YgbWVudSBiYXIgaXRlbSBcIkhhcmR3YXJlXCIgb2YgbWVudSBiYXIgMVxuICAgICAgICAgIHNldCBpc0NoZWNrZWQgdG8gKHZhbHVlIG9mIGF0dHJpYnV0ZSBcIkFYTWVudUl0ZW1NYXJrQ2hhclwiIG9mIGRzdE1lbnVJdGVtKSBpcyBcIuKck1wiXG4gICAgICAgIGVuZCB0ZWxsXG4gICAgICBlbmQgdGVsbFxuICAgIGApO1xuICAgIGxvZy5kZWJ1ZyhgVG91Y2ggSUQgZW5yb2xsZWQgc3RhdGU6ICR7b3V0cHV0fWApO1xuICAgIHJldHVybiBfLmlzU3RyaW5nKG91dHB1dCkgJiYgb3V0cHV0LnRyaW0oKSA9PT0gJ3RydWUnO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgZW5yb2xsQmlvbWV0cmljIChpc0VuYWJsZWQgPSB0cnVlKSB7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlVUlDbGllbnRTY3JpcHQoYFxuICAgICAgdGVsbCBhcHBsaWNhdGlvbiBcIlN5c3RlbSBFdmVudHNcIlxuICAgICAgICB0ZWxsIHByb2Nlc3MgXCJTaW11bGF0b3JcIlxuICAgICAgICAgIHNldCBkc3RNZW51SXRlbSB0byBtZW51IGl0ZW0gXCJUb2dnbGUgRW5yb2xsZWQgU3RhdGVcIiBvZiBtZW51IDEgb2YgbWVudSBpdGVtIFwiVG91Y2ggSURcIiBvZiBtZW51IDEgb2YgbWVudSBiYXIgaXRlbSBcIkhhcmR3YXJlXCIgb2YgbWVudSBiYXIgMVxuICAgICAgICAgIHNldCBpc0NoZWNrZWQgdG8gKHZhbHVlIG9mIGF0dHJpYnV0ZSBcIkFYTWVudUl0ZW1NYXJrQ2hhclwiIG9mIGRzdE1lbnVJdGVtKSBpcyBcIuKck1wiXG4gICAgICAgICAgaWYgJHtpc0VuYWJsZWQgPyAnbm90ICcgOiAnJ31pc0NoZWNrZWQgdGhlblxuICAgICAgICAgICAgY2xpY2sgZHN0TWVudUl0ZW1cbiAgICAgICAgICBlbmQgaWZcbiAgICAgICAgZW5kIHRlbGxcbiAgICAgIGVuZCB0ZWxsXG4gICAgYCk7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBzZW5kQmlvbWV0cmljTWF0Y2ggKHNob3VsZE1hdGNoID0gdHJ1ZSkge1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZHN0TWVudUl0ZW0gdG8gbWVudSBpdGVtIFwiJHtzaG91bGRNYXRjaCA/ICdNYXRjaGluZyBUb3VjaCcgOiAnTm9uLW1hdGNoaW5nIFRvdWNoJ31cIiBvZiBtZW51IDEgb2YgbWVudSBpdGVtIFwiVG91Y2ggSURcIiBvZiBtZW51IDEgb2YgbWVudSBiYXIgaXRlbSBcIkhhcmR3YXJlXCIgb2YgbWVudSBiYXIgMVxuICAgICAgICAgIGNsaWNrIGRzdE1lbnVJdGVtXG4gICAgICAgIGVuZCB0ZWxsXG4gICAgICBlbmQgdGVsbFxuICAgIGApO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBjdXN0b20gZ2VvbG9jYXRpb24gcGFyYW1ldGVycyBmb3IgdGhlIGdpdmVuIFNpbXVsYXRvciB1c2luZyBBcHBsZVNjcmlwdC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBsYXRpdHVkZSAtIFRoZSBsYXRpdHVkZSB2YWx1ZSwgd2hpY2ggaXMgZ29pbmcgdG8gYmUgZW50ZXJlZFxuICAgKiAgIGludG8gdGhlIGNvcnJlc3BvbmRpbmcgZWRpdCBmaWVsZCwgZm9yIGV4YW1wbGUgJzM5LDAwMDYnLlxuICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGxvbmdpdHVkZSAtIFRoZSBsb25naXR1ZGUgdmFsdWUsIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGVudGVyZWRcbiAgICogICBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGVkaXQgZmllbGQsIGZvciBleGFtcGxlICcxOSwwMDY4Jy5cbiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIHBhcmFtZXRlcnMgaGF2ZSBjb3JyZWN0IGZvcm1hdCBhbmQgd2VyZSBzdWNjZXNzZnVsbHkgYWNjZXB0ZWQuXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgc2V0dGluZyB0aGUgbG9jYXRpb25cbiAgICovXG4gIGFzeW5jIHNldEdlb2xvY2F0aW9uIChsYXRpdHVkZSwgbG9uZ2l0dWRlKSB7XG4gICAgY29uc3QgbG9jYXRpb25TZXR0ZXJzID0gW1xuICAgICAgYXN5bmMgKCkgPT4gYXdhaXQgc2V0TG9jYXRpb25XaXRoTHlmdCh0aGlzLnVkaWQsIGxhdGl0dWRlLCBsb25naXR1ZGUpLFxuICAgICAgYXN5bmMgKCkgPT4gYXdhaXQgc2V0TG9jYXRpb25XaXRoSWRiKHRoaXMuaWRiLCBsYXRpdHVkZSwgbG9uZ2l0dWRlKSxcbiAgICAgIGFzeW5jICgpID0+IGF3YWl0IHNldExvY2F0aW9uV2l0aEFwcGxlU2NyaXB0KHRoaXMsIGxhdGl0dWRlLCBsb25naXR1ZGUsIHRoaXMuX2xvY2F0aW9uTWVudSksXG4gICAgXTtcblxuICAgIGxldCBsYXN0RXJyb3I7XG4gICAgZm9yIChjb25zdCBzZXR0ZXIgb2YgbG9jYXRpb25TZXR0ZXJzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBzZXR0ZXIoKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy5pbmZvKGUubWVzc2FnZSk7XG4gICAgICAgIGxhc3RFcnJvciA9IGU7XG4gICAgICB9XG4gICAgfVxuICAgIHRocm93IGxhc3RFcnJvcjtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBTaW11bGF0b3JYY29kZTg7XG4iXSwiZmlsZSI6ImxpYi9zaW11bGF0b3IteGNvZGUtOC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
