"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.TEST_APK_PKG = exports.REQUIRED_PARAMS = exports.EspressoRunner = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _package = require("../../package.json");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

const TEST_APK_PATH = _path.default.resolve(__dirname, '..', '..', 'espresso-server', 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');

const TEST_MANIFEST_PATH = _path.default.resolve(__dirname, '..', '..', 'espresso-server', 'AndroidManifest-test.xml');

const TEST_APK_PKG = 'io.appium.espressoserver.test';
exports.TEST_APK_PKG = TEST_APK_PKG;
const REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
const ESPRESSO_SERVER_LAUNCH_TIMEOUT = 30000;
const TARGET_PACKAGE_CONTAINER = '/data/local/tmp/espresso.apppackage';

class EspressoRunner {
  constructor(opts = {}) {
    for (let req of REQUIRED_PARAMS) {
      if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort,
      base: ''
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.modServerPath = _path.default.resolve(this.tmpDir, `${TEST_APK_PKG}_${_package.version}_${this.appPackage}.apk`);
    this.serverLaunchTimeout = opts.serverLaunchTimeout || ESPRESSO_SERVER_LAUNCH_TIMEOUT;
    this.androidInstallTimeout = opts.androidInstallTimeout;
  }

  async isAppPackageChanged() {
    if (!(await this.adb.fileExists(TARGET_PACKAGE_CONTAINER))) {
      _logger.default.debug('The previous target application package is unknown');

      return true;
    }

    const previousAppPackage = (await this.adb.shell(['cat', TARGET_PACKAGE_CONTAINER])).trim();

    _logger.default.debug(`The previous target application package was '${previousAppPackage}'. ` + `The current package is '${this.appPackage}'`);

    return previousAppPackage !== this.appPackage;
  }

  async installServer() {
    const appState = await this.adb.getApplicationInstallState(this.modServerPath, TEST_APK_PKG);
    const shouldUninstallApp = [this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED, this.adb.APP_INSTALL_STATE.NEWER_VERSION_INSTALLED].includes(appState);
    const shouldInstallApp = shouldUninstallApp || [this.adb.APP_INSTALL_STATE.NOT_INSTALLED].includes(appState);

    if (shouldUninstallApp) {
      _logger.default.info(`Uninstalling Espresso Test Server apk from the target device (pkg: '${TEST_APK_PKG}')`);

      try {
        await this.adb.uninstallApk(TEST_APK_PKG);
      } catch (err) {
        _logger.default.warn(`Error uninstalling '${TEST_APK_PKG}': ${err.message}`);
      }
    }

    if (shouldInstallApp) {
      _logger.default.info(`Installing Espresso Test Server apk from the target device (path: '${this.modServerPath}')`);

      try {
        await this.adb.install(this.modServerPath, {
          replace: false,
          timeout: this.androidInstallTimeout
        });

        _logger.default.info(`Installed Espresso Test Server apk '${this.modServerPath}' (pkg: '${TEST_APK_PKG}')`);
      } catch (err) {
        _logger.default.errorAndThrow(`Cannot install '${this.modServerPath}' because of '${err.message}'`);
      }
    }
  }

  async installTestApk() {
    let rebuild = this.forceEspressoRebuild;

    if (rebuild) {
      _logger.default.debug(`'forceEspressoRebuild' capability is enabled`);
    } else if (await this.isAppPackageChanged()) {
      _logger.default.info(`Forcing Espresso server rebuild because of changed application package`);

      rebuild = true;
    }

    if (rebuild && (await _appiumSupport.fs.exists(this.modServerPath))) {
      _logger.default.debug(`Deleting the obsolete Espresso server package '${this.modServerPath}'`);

      await _appiumSupport.fs.unlink(this.modServerPath);
    }

    if (!(await _appiumSupport.fs.exists(this.modServerPath))) {
      await this.buildNewModServer();
    }

    const isSigned = await this.adb.checkApkCert(this.modServerPath, TEST_APK_PKG);

    if (!isSigned) {
      await this.adb.sign(this.modServerPath);
    }

    if ((rebuild || !isSigned) && (await this.adb.uninstallApk(TEST_APK_PKG))) {
      _logger.default.info('Uninstalled the obsolete Espresso server package from the device under test');
    }

    await this.installServer();
  }

  async buildNewModServer() {
    _logger.default.info(`Repackaging espresso server for: '${this.appPackage}'`);

    const packageTmpDir = _path.default.resolve(this.tmpDir, this.appPackage);

    const newManifestPath = _path.default.resolve(this.tmpDir, 'AndroidManifest.xml');

    await _appiumSupport.fs.rimraf(newManifestPath);

    _logger.default.info(`Creating new manifest: '${newManifestPath}'`);

    await (0, _appiumSupport.mkdirp)(packageTmpDir);
    await _appiumSupport.fs.copyFile(TEST_MANIFEST_PATH, newManifestPath);
    await this.adb.compileManifest(newManifestPath, TEST_APK_PKG, this.appPackage);
    await this.adb.insertManifest(newManifestPath, TEST_APK_PATH, this.modServerPath);

    _logger.default.info(`Repackaged espresso server ready: '${this.modServerPath}'`);
  }

  async cleanupSessionLeftovers() {
    _logger.default.debug('Performing cleanup of automation leftovers');

    try {
      const {
        value
      } = await _requestPromise.default.get({
        url: `http://${this.host}:${this.systemPort}/sessions`,
        timeout: 500,
        json: true
      });
      const activeSessionIds = value.map(sess => sess.id);

      if (activeSessionIds.length) {
        _logger.default.debug(`The following obsolete sessions are still running: ${JSON.stringify(activeSessionIds)}`);

        _logger.default.debug('Cleaning up the obsolete sessions');

        await _bluebird.default.all(activeSessionIds.map(id => _requestPromise.default.delete({
          url: `http://${this.host}:${this.systemPort}/session/${id}`
        })));
        await _bluebird.default.delay(1000);
      } else {
        _logger.default.debug('No obsolete sessions have been detected');
      }
    } catch (e) {
      _logger.default.debug(`No obsolete sessions have been detected (${e.message})`);
    }
  }

  async startSession(caps) {
    await this.cleanupSessionLeftovers();
    const cmd = ['shell', 'am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true' ? 'true' : 'false', `${TEST_APK_PKG}/androidx.test.runner.AndroidJUnitRunner`];

    _logger.default.info(`Starting Espresso Server v${_package.version} with cmd: adb ${cmd.join(' ')}`);

    let hasSocketError = false;
    this.instProcess = this.adb.createSubProcess(cmd);
    this.instProcess.on('exit', (code, signal) => {
      _logger.default.info(`Instrumentation process exited with code ${code} from signal ${signal}`);
    });
    this.instProcess.on('die', (code, signal) => {
      _logger.default.error(`Instrumentation process died with code ${code} and signal ${signal}`);
    });
    this.instProcess.on('stream-line', line => {
      if (_lodash.default.isEmpty(line.trim())) {
        return;
      }

      _logger.default.debug(`[Instrumentation] ${line.trim()}`);

      if (line.toLowerCase().includes('java.net.socketexception')) {
        hasSocketError = true;
      }
    });
    await this.instProcess.start((stdout, stderr) => {
      const out = stdout.trim() || stderr.trim();

      if (out.includes('io.appium.espressoserver.EspressoServerRunnerTest:')) {
        return true;
      }

      if (out.toLowerCase().includes('exception')) {
        throw new Error(out);
      }
    }, this.serverLaunchTimeout);

    _logger.default.info('Waiting for Espresso to be online...');

    try {
      await (0, _asyncbox.retryInterval)(20, 1000, async () => {
        await this.jwproxy.command('/status', 'GET');
      });
    } catch (e) {
      if (hasSocketError) {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start due to Socket exception. Espresso Server requires the 'INTERNET' permission to be set in the Android manifest for the app-under-test (<uses-permission android:name="android.permission.INTERNET" />)`);
      } else {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start. Original error: ${e.message}`);
      }
    }

    await this.jwproxy.command('/session', 'POST', {
      capabilities: {
        firstMatch: [caps],
        alwaysMatch: {}
      }
    });
    await this.recordTargetAppPackage();
  }

  async recordTargetAppPackage() {
    await this.adb.shell([`echo "${this.appPackage}" > "${TARGET_PACKAGE_CONTAINER}"`]);

    _logger.default.info(`Recorded the target application package '${this.appPackage}' to ${TARGET_PACKAGE_CONTAINER}`);
  }

  async deleteSession() {
    _logger.default.debug('Deleting Espresso server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation Espresso deleteSession worked; ` + `Error was: ${err}`);
    }

    if (this.instProcess && this.instProcess.isRunning) {
      await this.instProcess.stop();
    }
  }

}

exports.EspressoRunner = EspressoRunner;
var _default = EspressoRunner;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9lc3ByZXNzby1ydW5uZXIuanMiXSwibmFtZXMiOlsiVEVTVF9BUEtfUEFUSCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiVEVTVF9NQU5JRkVTVF9QQVRIIiwiVEVTVF9BUEtfUEtHIiwiUkVRVUlSRURfUEFSQU1TIiwiRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUIiwiVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSIiwiRXNwcmVzc29SdW5uZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJyZXEiLCJ1dGlsIiwiaGFzVmFsdWUiLCJFcnJvciIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwiaG9zdCIsInBvcnQiLCJzeXN0ZW1Qb3J0IiwiYmFzZSIsInByb3h5UmVxUmVzIiwiYmluZCIsIm1vZFNlcnZlclBhdGgiLCJ0bXBEaXIiLCJ2ZXJzaW9uIiwiYXBwUGFja2FnZSIsInNlcnZlckxhdW5jaFRpbWVvdXQiLCJhbmRyb2lkSW5zdGFsbFRpbWVvdXQiLCJpc0FwcFBhY2thZ2VDaGFuZ2VkIiwiYWRiIiwiZmlsZUV4aXN0cyIsImxvZ2dlciIsImRlYnVnIiwicHJldmlvdXNBcHBQYWNrYWdlIiwic2hlbGwiLCJ0cmltIiwiaW5zdGFsbFNlcnZlciIsImFwcFN0YXRlIiwiZ2V0QXBwbGljYXRpb25JbnN0YWxsU3RhdGUiLCJzaG91bGRVbmluc3RhbGxBcHAiLCJBUFBfSU5TVEFMTF9TVEFURSIsIk9MREVSX1ZFUlNJT05fSU5TVEFMTEVEIiwiTkVXRVJfVkVSU0lPTl9JTlNUQUxMRUQiLCJpbmNsdWRlcyIsInNob3VsZEluc3RhbGxBcHAiLCJOT1RfSU5TVEFMTEVEIiwiaW5mbyIsInVuaW5zdGFsbEFwayIsImVyciIsIndhcm4iLCJtZXNzYWdlIiwiaW5zdGFsbCIsInJlcGxhY2UiLCJ0aW1lb3V0IiwiZXJyb3JBbmRUaHJvdyIsImluc3RhbGxUZXN0QXBrIiwicmVidWlsZCIsImZvcmNlRXNwcmVzc29SZWJ1aWxkIiwiZnMiLCJleGlzdHMiLCJ1bmxpbmsiLCJidWlsZE5ld01vZFNlcnZlciIsImlzU2lnbmVkIiwiY2hlY2tBcGtDZXJ0Iiwic2lnbiIsInBhY2thZ2VUbXBEaXIiLCJuZXdNYW5pZmVzdFBhdGgiLCJyaW1yYWYiLCJjb3B5RmlsZSIsImNvbXBpbGVNYW5pZmVzdCIsImluc2VydE1hbmlmZXN0IiwiY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMiLCJ2YWx1ZSIsInJlcXVlc3QiLCJnZXQiLCJ1cmwiLCJqc29uIiwiYWN0aXZlU2Vzc2lvbklkcyIsIm1hcCIsInNlc3MiLCJpZCIsImxlbmd0aCIsIkpTT04iLCJzdHJpbmdpZnkiLCJCIiwiYWxsIiwiZGVsZXRlIiwiZGVsYXkiLCJlIiwic3RhcnRTZXNzaW9uIiwiY2FwcyIsImNtZCIsInByb2Nlc3MiLCJlbnYiLCJFU1BSRVNTT19KQVZBX0RFQlVHIiwiam9pbiIsImhhc1NvY2tldEVycm9yIiwiaW5zdFByb2Nlc3MiLCJjcmVhdGVTdWJQcm9jZXNzIiwib24iLCJjb2RlIiwic2lnbmFsIiwiZXJyb3IiLCJsaW5lIiwiXyIsImlzRW1wdHkiLCJ0b0xvd2VyQ2FzZSIsInN0YXJ0Iiwic3Rkb3V0Iiwic3RkZXJyIiwib3V0IiwiY29tbWFuZCIsImNhcGFiaWxpdGllcyIsImZpcnN0TWF0Y2giLCJhbHdheXNNYXRjaCIsInJlY29yZFRhcmdldEFwcFBhY2thZ2UiLCJkZWxldGVTZXNzaW9uIiwiaXNSdW5uaW5nIiwic3RvcCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxhQUFhLEdBQUdDLGNBQUtDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QixJQUF4QixFQUE4QixJQUE5QixFQUFvQyxpQkFBcEMsRUFBdUQsS0FBdkQsRUFBOEQsT0FBOUQsRUFBdUUsU0FBdkUsRUFBa0YsS0FBbEYsRUFBeUYsYUFBekYsRUFBd0csT0FBeEcsRUFBaUgsMkJBQWpILENBQXRC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dCI6WyJpbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIHV0aWwsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHZlcnNpb24gfSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jb25zdCBURVNUX0FQS19QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2VzcHJlc3NvLXNlcnZlcicsICdhcHAnLCAnYnVpbGQnLCAnb3V0cHV0cycsICdhcGsnLCAnYW5kcm9pZFRlc3QnLCAnZGVidWcnLCAnYXBwLWRlYnVnLWFuZHJvaWRUZXN0LmFwaycpO1xuY29uc3QgVEVTVF9NQU5JRkVTVF9QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2VzcHJlc3NvLXNlcnZlcicsICdBbmRyb2lkTWFuaWZlc3QtdGVzdC54bWwnKTtcbmNvbnN0IFRFU1RfQVBLX1BLRyA9ICdpby5hcHBpdW0uZXNwcmVzc29zZXJ2ZXIudGVzdCc7XG5jb25zdCBSRVFVSVJFRF9QQVJBTVMgPSBbJ2FkYicsICd0bXBEaXInLCAnaG9zdCcsICdzeXN0ZW1Qb3J0JywgJ2RldmljZVBvcnQnLCAnYXBwUGFja2FnZScsICdmb3JjZUVzcHJlc3NvUmVidWlsZCddO1xuY29uc3QgRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUID0gMzAwMDA7XG5jb25zdCBUQVJHRVRfUEFDS0FHRV9DT05UQUlORVIgPSAnL2RhdGEvbG9jYWwvdG1wL2VzcHJlc3NvLmFwcHBhY2thZ2UnO1xuXG5jbGFzcyBFc3ByZXNzb1J1bm5lciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBmb3IgKGxldCByZXEgb2YgUkVRVUlSRURfUEFSQU1TKSB7XG4gICAgICBpZiAoIW9wdHMgfHwgIXV0aWwuaGFzVmFsdWUob3B0c1tyZXFdKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9wdGlvbiAnJHtyZXF9JyBpcyByZXF1aXJlZCFgKTtcbiAgICAgIH1cbiAgICAgIHRoaXNbcmVxXSA9IG9wdHNbcmVxXTtcbiAgICB9XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe3NlcnZlcjogdGhpcy5ob3N0LCBwb3J0OiB0aGlzLnN5c3RlbVBvcnQsIGJhc2U6ICcnfSk7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuandwcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMuandwcm94eSk7XG5cbiAgICB0aGlzLm1vZFNlcnZlclBhdGggPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsIGAke1RFU1RfQVBLX1BLR31fJHt2ZXJzaW9ufV8ke3RoaXMuYXBwUGFja2FnZX0uYXBrYCk7XG5cbiAgICB0aGlzLnNlcnZlckxhdW5jaFRpbWVvdXQgPSBvcHRzLnNlcnZlckxhdW5jaFRpbWVvdXQgfHwgRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUO1xuICAgIHRoaXMuYW5kcm9pZEluc3RhbGxUaW1lb3V0ID0gb3B0cy5hbmRyb2lkSW5zdGFsbFRpbWVvdXQ7XG4gIH1cblxuICBhc3luYyBpc0FwcFBhY2thZ2VDaGFuZ2VkICgpIHtcbiAgICBpZiAoIWF3YWl0IHRoaXMuYWRiLmZpbGVFeGlzdHMoVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSKSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdUaGUgcHJldmlvdXMgdGFyZ2V0IGFwcGxpY2F0aW9uIHBhY2thZ2UgaXMgdW5rbm93bicpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGNvbnN0IHByZXZpb3VzQXBwUGFja2FnZSA9IChhd2FpdCB0aGlzLmFkYi5zaGVsbChbJ2NhdCcsIFRBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUl0pKS50cmltKCk7XG4gICAgbG9nZ2VyLmRlYnVnKGBUaGUgcHJldmlvdXMgdGFyZ2V0IGFwcGxpY2F0aW9uIHBhY2thZ2Ugd2FzICcke3ByZXZpb3VzQXBwUGFja2FnZX0nLiBgICtcbiAgICAgIGBUaGUgY3VycmVudCBwYWNrYWdlIGlzICcke3RoaXMuYXBwUGFja2FnZX0nYCk7XG4gICAgcmV0dXJuIHByZXZpb3VzQXBwUGFja2FnZSAhPT0gdGhpcy5hcHBQYWNrYWdlO1xuICB9XG5cbiAgLyoqXG4gICAqIEluc3RhbGxzIEVzcHJlc3NvIHNlcnZlciBhcGsgb24gdG8gdGhlIGRldmljZSBvciBlbXVsYXRvci5cbiAgICogRWFjaCBhZGIgY29tbWFuZCB1c2VzIGRlZmF1bHQgdGltZW91dCBieSB0aGVtLlxuICAgKi9cbiAgYXN5bmMgaW5zdGFsbFNlcnZlciAoKSB7XG4gICAgY29uc3QgYXBwU3RhdGUgPSBhd2FpdCB0aGlzLmFkYi5nZXRBcHBsaWNhdGlvbkluc3RhbGxTdGF0ZSh0aGlzLm1vZFNlcnZlclBhdGgsIFRFU1RfQVBLX1BLRyk7XG5cbiAgICBjb25zdCBzaG91bGRVbmluc3RhbGxBcHAgPSBbXG4gICAgICB0aGlzLmFkYi5BUFBfSU5TVEFMTF9TVEFURS5PTERFUl9WRVJTSU9OX0lOU1RBTExFRCxcbiAgICAgIHRoaXMuYWRiLkFQUF9JTlNUQUxMX1NUQVRFLk5FV0VSX1ZFUlNJT05fSU5TVEFMTEVEXG4gICAgXS5pbmNsdWRlcyhhcHBTdGF0ZSk7XG4gICAgY29uc3Qgc2hvdWxkSW5zdGFsbEFwcCA9IHNob3VsZFVuaW5zdGFsbEFwcCB8fCBbXG4gICAgICB0aGlzLmFkYi5BUFBfSU5TVEFMTF9TVEFURS5OT1RfSU5TVEFMTEVEXG4gICAgXS5pbmNsdWRlcyhhcHBTdGF0ZSk7XG5cbiAgICBpZiAoc2hvdWxkVW5pbnN0YWxsQXBwKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgVW5pbnN0YWxsaW5nIEVzcHJlc3NvIFRlc3QgU2VydmVyIGFwayBmcm9tIHRoZSB0YXJnZXQgZGV2aWNlIChwa2c6ICcke1RFU1RfQVBLX1BLR30nKWApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIudW5pbnN0YWxsQXBrKFRFU1RfQVBLX1BLRyk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oYEVycm9yIHVuaW5zdGFsbGluZyAnJHtURVNUX0FQS19QS0d9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoc2hvdWxkSW5zdGFsbEFwcCkge1xuICAgICAgbG9nZ2VyLmluZm8oYEluc3RhbGxpbmcgRXNwcmVzc28gVGVzdCBTZXJ2ZXIgYXBrIGZyb20gdGhlIHRhcmdldCBkZXZpY2UgKHBhdGg6ICcke3RoaXMubW9kU2VydmVyUGF0aH0nKWApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIuaW5zdGFsbCh0aGlzLm1vZFNlcnZlclBhdGgsIHsgcmVwbGFjZTogZmFsc2UsIHRpbWVvdXQ6IHRoaXMuYW5kcm9pZEluc3RhbGxUaW1lb3V0IH0pO1xuICAgICAgICBsb2dnZXIuaW5mbyhgSW5zdGFsbGVkIEVzcHJlc3NvIFRlc3QgU2VydmVyIGFwayAnJHt0aGlzLm1vZFNlcnZlclBhdGh9JyAocGtnOiAnJHtURVNUX0FQS19QS0d9JylgKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgQ2Fubm90IGluc3RhbGwgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScgYmVjYXVzZSBvZiAnJHtlcnIubWVzc2FnZX0nYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFRlc3RBcGsgKCkge1xuICAgIGxldCByZWJ1aWxkID0gdGhpcy5mb3JjZUVzcHJlc3NvUmVidWlsZDtcbiAgICBpZiAocmVidWlsZCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGAnZm9yY2VFc3ByZXNzb1JlYnVpbGQnIGNhcGFiaWxpdHkgaXMgZW5hYmxlZGApO1xuICAgIH0gZWxzZSBpZiAoYXdhaXQgdGhpcy5pc0FwcFBhY2thZ2VDaGFuZ2VkKCkpIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBGb3JjaW5nIEVzcHJlc3NvIHNlcnZlciByZWJ1aWxkIGJlY2F1c2Ugb2YgY2hhbmdlZCBhcHBsaWNhdGlvbiBwYWNrYWdlYCk7XG4gICAgICByZWJ1aWxkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBpZiAocmVidWlsZCAmJiBhd2FpdCBmcy5leGlzdHModGhpcy5tb2RTZXJ2ZXJQYXRoKSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBEZWxldGluZyB0aGUgb2Jzb2xldGUgRXNwcmVzc28gc2VydmVyIHBhY2thZ2UgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgICAgIGF3YWl0IGZzLnVubGluayh0aGlzLm1vZFNlcnZlclBhdGgpO1xuICAgIH1cbiAgICBpZiAoIShhd2FpdCBmcy5leGlzdHModGhpcy5tb2RTZXJ2ZXJQYXRoKSkpIHtcbiAgICAgIGF3YWl0IHRoaXMuYnVpbGROZXdNb2RTZXJ2ZXIoKTtcbiAgICB9XG4gICAgY29uc3QgaXNTaWduZWQgPSBhd2FpdCB0aGlzLmFkYi5jaGVja0Fwa0NlcnQodGhpcy5tb2RTZXJ2ZXJQYXRoLCBURVNUX0FQS19QS0cpO1xuICAgIGlmICghaXNTaWduZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnNpZ24odGhpcy5tb2RTZXJ2ZXJQYXRoKTtcbiAgICB9XG4gICAgaWYgKChyZWJ1aWxkIHx8ICFpc1NpZ25lZCkgJiYgYXdhaXQgdGhpcy5hZGIudW5pbnN0YWxsQXBrKFRFU1RfQVBLX1BLRykpIHtcbiAgICAgIGxvZ2dlci5pbmZvKCdVbmluc3RhbGxlZCB0aGUgb2Jzb2xldGUgRXNwcmVzc28gc2VydmVyIHBhY2thZ2UgZnJvbSB0aGUgZGV2aWNlIHVuZGVyIHRlc3QnKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmluc3RhbGxTZXJ2ZXIoKTtcbiAgfVxuXG4gIGFzeW5jIGJ1aWxkTmV3TW9kU2VydmVyICgpIHtcbiAgICBsb2dnZXIuaW5mbyhgUmVwYWNrYWdpbmcgZXNwcmVzc28gc2VydmVyIGZvcjogJyR7dGhpcy5hcHBQYWNrYWdlfSdgKTtcbiAgICBjb25zdCBwYWNrYWdlVG1wRGlyID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCB0aGlzLmFwcFBhY2thZ2UpO1xuICAgIGNvbnN0IG5ld01hbmlmZXN0UGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgJ0FuZHJvaWRNYW5pZmVzdC54bWwnKTtcbiAgICBhd2FpdCBmcy5yaW1yYWYobmV3TWFuaWZlc3RQYXRoKTtcblxuICAgIGxvZ2dlci5pbmZvKGBDcmVhdGluZyBuZXcgbWFuaWZlc3Q6ICcke25ld01hbmlmZXN0UGF0aH0nYCk7XG4gICAgYXdhaXQgbWtkaXJwKHBhY2thZ2VUbXBEaXIpO1xuICAgIGF3YWl0IGZzLmNvcHlGaWxlKFRFU1RfTUFOSUZFU1RfUEFUSCwgbmV3TWFuaWZlc3RQYXRoKTtcbiAgICBhd2FpdCB0aGlzLmFkYi5jb21waWxlTWFuaWZlc3QobmV3TWFuaWZlc3RQYXRoLCBURVNUX0FQS19QS0csIHRoaXMuYXBwUGFja2FnZSk7IC8vIGNyZWF0ZXMgYSBmaWxlIGAke25ld01hbmlmZXN0UGF0aH0uYXBrYFxuICAgIGF3YWl0IHRoaXMuYWRiLmluc2VydE1hbmlmZXN0KG5ld01hbmlmZXN0UGF0aCwgVEVTVF9BUEtfUEFUSCwgdGhpcy5tb2RTZXJ2ZXJQYXRoKTsgLy8gY29waWVzIGZyb20gc2Vjb25kIHRvIHRoaXJkIGFuZCBhZGQgbWFuaWZlc3RcbiAgICBsb2dnZXIuaW5mbyhgUmVwYWNrYWdlZCBlc3ByZXNzbyBzZXJ2ZXIgcmVhZHk6ICcke3RoaXMubW9kU2VydmVyUGF0aH0nYCk7XG4gIH1cblxuICBhc3luYyBjbGVhbnVwU2Vzc2lvbkxlZnRvdmVycyAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdQZXJmb3JtaW5nIGNsZWFudXAgb2YgYXV0b21hdGlvbiBsZWZ0b3ZlcnMnKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCB7dmFsdWV9ID0gYXdhaXQgcmVxdWVzdC5nZXQoe1xuICAgICAgICB1cmw6IGBodHRwOi8vJHt0aGlzLmhvc3R9OiR7dGhpcy5zeXN0ZW1Qb3J0fS9zZXNzaW9uc2AsXG4gICAgICAgIHRpbWVvdXQ6IDUwMCxcbiAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgYWN0aXZlU2Vzc2lvbklkcyA9IHZhbHVlLm1hcCgoc2VzcykgPT4gc2Vzcy5pZCk7XG4gICAgICBpZiAoYWN0aXZlU2Vzc2lvbklkcy5sZW5ndGgpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBUaGUgZm9sbG93aW5nIG9ic29sZXRlIHNlc3Npb25zIGFyZSBzdGlsbCBydW5uaW5nOiAke0pTT04uc3RyaW5naWZ5KGFjdGl2ZVNlc3Npb25JZHMpfWApO1xuICAgICAgICBsb2dnZXIuZGVidWcoJ0NsZWFuaW5nIHVwIHRoZSBvYnNvbGV0ZSBzZXNzaW9ucycpO1xuICAgICAgICBhd2FpdCBCLmFsbChhY3RpdmVTZXNzaW9uSWRzLm1hcCgoaWQpID0+XG4gICAgICAgICAgcmVxdWVzdC5kZWxldGUoe1xuICAgICAgICAgICAgdXJsOiBgaHR0cDovLyR7dGhpcy5ob3N0fToke3RoaXMuc3lzdGVtUG9ydH0vc2Vzc2lvbi8ke2lkfWAsXG4gICAgICAgICAgfSlcbiAgICAgICAgKSk7XG4gICAgICAgIC8vIExldCBhbGwgc2Vzc2lvbnMgdG8gYmUgcHJvcGVybHkgdGVybWluYXRlZCBiZWZvcmUgY29udGludWluZ1xuICAgICAgICBhd2FpdCBCLmRlbGF5KDEwMDApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdObyBvYnNvbGV0ZSBzZXNzaW9ucyBoYXZlIGJlZW4gZGV0ZWN0ZWQnKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYE5vIG9ic29sZXRlIHNlc3Npb25zIGhhdmUgYmVlbiBkZXRlY3RlZCAoJHtlLm1lc3NhZ2V9KWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xuICAgIGF3YWl0IHRoaXMuY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMoKTtcblxuICAgIGNvbnN0IGNtZCA9IFtcbiAgICAgICdzaGVsbCcsXG4gICAgICAnYW0nLCAnaW5zdHJ1bWVudCcsXG4gICAgICAnLXcnLFxuICAgICAgJy1lJywgJ2RlYnVnJywgcHJvY2Vzcy5lbnYuRVNQUkVTU09fSkFWQV9ERUJVRyA9PT0gJ3RydWUnID8gJ3RydWUnIDogJ2ZhbHNlJyxcbiAgICAgIGAke1RFU1RfQVBLX1BLR30vYW5kcm9pZHgudGVzdC5ydW5uZXIuQW5kcm9pZEpVbml0UnVubmVyYCxcbiAgICBdO1xuXG4gICAgbG9nZ2VyLmluZm8oYFN0YXJ0aW5nIEVzcHJlc3NvIFNlcnZlciB2JHt2ZXJzaW9ufSB3aXRoIGNtZDogYWRiICR7Y21kLmpvaW4oJyAnKX1gKTtcblxuICAgIGxldCBoYXNTb2NrZXRFcnJvciA9IGZhbHNlO1xuXG4gICAgLy8gc3RhcnQgdGhlIGluc3RydW1lbnRhdGlvbiBwcm9jZXNzXG4gICAgdGhpcy5pbnN0UHJvY2VzcyA9IHRoaXMuYWRiLmNyZWF0ZVN1YlByb2Nlc3MoY21kKTtcbiAgICB0aGlzLmluc3RQcm9jZXNzLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgbG9nZ2VyLmluZm8oYEluc3RydW1lbnRhdGlvbiBwcm9jZXNzIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfSBmcm9tIHNpZ25hbCAke3NpZ25hbH1gKTtcbiAgICB9KTtcbiAgICB0aGlzLmluc3RQcm9jZXNzLm9uKCdkaWUnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoYEluc3RydW1lbnRhdGlvbiBwcm9jZXNzIGRpZWQgd2l0aCBjb2RlICR7Y29kZX0gYW5kIHNpZ25hbCAke3NpZ25hbH1gKTtcbiAgICB9KTtcbiAgICB0aGlzLmluc3RQcm9jZXNzLm9uKCdzdHJlYW0tbGluZScsIChsaW5lKSA9PiB7XG4gICAgICBpZiAoXy5pc0VtcHR5KGxpbmUudHJpbSgpKSkge1xuICAgICAgICAvLyBEbyBub3QgcHJpbnQgZW1wdHkgbGluZXMgaW50byB0aGUgc3lzdGVtIGxvZ1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGxvZ2dlci5kZWJ1ZyhgW0luc3RydW1lbnRhdGlvbl0gJHtsaW5lLnRyaW0oKX1gKTtcbiAgICAgIC8vIEEgJ1NvY2tldEV4Y2VwdGlvbicgaW5kaWNhdGVzIHRoYXQgd2UgY291bGRuJ3QgY29ubmVjdCB0byB0aGUgRXNwcmVzc28gU2VydmVyLCBiZWNhdXNlIHRoZSBJTlRFUk5FVCBwZXJtaXNzaW9uIGlzIG5vdCBzZXRcbiAgICAgIGlmIChsaW5lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2phdmEubmV0LnNvY2tldGV4Y2VwdGlvbicpKSB7XG4gICAgICAgIGhhc1NvY2tldEVycm9yID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGF3YWl0IHRoaXMuaW5zdFByb2Nlc3Muc3RhcnQoKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICAvLyBmb3IgYW55IGNhbGwgdG8gdGhlIHN0YXJ0IGRldGVjdG9yLCBvbmUgb2Ygc3Rkb3V0IG9yIHN0ZGVyciB3aWxsIGhhdmVcbiAgICAgIC8vIGNvbnRlbnQsIHNvIG1lcmdlIGZvciBjaGVja3MgaGVyZVxuICAgICAgY29uc3Qgb3V0ID0gc3Rkb3V0LnRyaW0oKSB8fCBzdGRlcnIudHJpbSgpO1xuXG4gICAgICAvLyBhZGIgYWx3YXlzIHByaW50cyB0aGlzIG91dCBvbiBzdWNjZXNzLiBJZiB0aGlzIGlzIGZvdW5kIG5vdCB0byBiZSB0aGVcbiAgICAgIC8vIGNhc2UsIGFkZCBvdGhlciBjb25kaXRpb25zXG4gICAgICBpZiAob3V0LmluY2x1ZGVzKCdpby5hcHBpdW0uZXNwcmVzc29zZXJ2ZXIuRXNwcmVzc29TZXJ2ZXJSdW5uZXJUZXN0OicpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgaWYgKG91dC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdleGNlcHRpb24nKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3Iob3V0KTtcbiAgICAgIH1cbiAgICB9LCB0aGlzLnNlcnZlckxhdW5jaFRpbWVvdXQpO1xuXG4gICAgbG9nZ2VyLmluZm8oJ1dhaXRpbmcgZm9yIEVzcHJlc3NvIHRvIGJlIG9ubGluZS4uLicpO1xuXG4gICAgLy8gd2FpdCAyMHMgZm9yIGVzcHJlc3NvIHRvIGJlIG9ubGluZVxuICAgIHRyeSB7XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKDIwLCAxMDAwLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGhhc1NvY2tldEVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBUaW1lZCBvdXQgd2FpdGluZyBmb3IgRXNwcmVzc28gU2VydmVyIHRvIHN0YXJ0IGR1ZSB0byBTb2NrZXQgZXhjZXB0aW9uLiBFc3ByZXNzbyBTZXJ2ZXIgcmVxdWlyZXMgdGhlICdJTlRFUk5FVCcgcGVybWlzc2lvbiB0byBiZSBzZXQgaW4gdGhlIEFuZHJvaWQgbWFuaWZlc3QgZm9yIHRoZSBhcHAtdW5kZXItdGVzdCAoPHVzZXMtcGVybWlzc2lvbiBhbmRyb2lkOm5hbWU9XCJhbmRyb2lkLnBlcm1pc3Npb24uSU5URVJORVRcIiAvPilgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBUaW1lZCBvdXQgd2FpdGluZyBmb3IgRXNwcmVzc28gU2VydmVyIHRvIHN0YXJ0LiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7XG4gICAgICBjYXBhYmlsaXRpZXM6IHtcbiAgICAgICAgZmlyc3RNYXRjaDogW2NhcHNdLFxuICAgICAgICBhbHdheXNNYXRjaDoge31cbiAgICAgIH1cbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLnJlY29yZFRhcmdldEFwcFBhY2thZ2UoKTtcbiAgfVxuXG4gIGFzeW5jIHJlY29yZFRhcmdldEFwcFBhY2thZ2UgKCkge1xuICAgIGF3YWl0IHRoaXMuYWRiLnNoZWxsKFtgZWNobyBcIiR7dGhpcy5hcHBQYWNrYWdlfVwiID4gXCIke1RBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUn1cImBdKTtcbiAgICBsb2dnZXIuaW5mbyhgUmVjb3JkZWQgdGhlIHRhcmdldCBhcHBsaWNhdGlvbiBwYWNrYWdlICcke3RoaXMuYXBwUGFja2FnZX0nIHRvICR7VEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSfWApO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdEZWxldGluZyBFc3ByZXNzbyBzZXJ2ZXIgc2Vzc2lvbicpO1xuICAgIC8vIHJlbHkgb24gandwcm94eSdzIGludGVsbGlnZW5jZSB0byBrbm93IHdoYXQgd2UncmUgdGFsa2luZyBhYm91dCBhbmRcbiAgICAvLyBkZWxldGUgdGhlIGN1cnJlbnQgc2Vzc2lvblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnLycsICdERUxFVEUnKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci53YXJuKGBEaWQgbm90IGdldCBjb25maXJtYXRpb24gRXNwcmVzc28gZGVsZXRlU2Vzc2lvbiB3b3JrZWQ7IGAgK1xuICAgICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmluc3RQcm9jZXNzICYmIHRoaXMuaW5zdFByb2Nlc3MuaXNSdW5uaW5nKSB7XG4gICAgICBhd2FpdCB0aGlzLmluc3RQcm9jZXNzLnN0b3AoKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgRXNwcmVzc29SdW5uZXIsIFJFUVVJUkVEX1BBUkFNUywgVEVTVF9BUEtfUEtHIH07XG5leHBvcnQgZGVmYXVsdCBFc3ByZXNzb1J1bm5lcjtcbiJdLCJmaWxlIjoibGliL2VzcHJlc3NvLXJ1bm5lci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
