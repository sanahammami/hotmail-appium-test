"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.initMJpegServer = initMJpegServer;
exports.TEST_IMG_JPG = exports.MJpegStream = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _request = _interopRequireDefault(require("request"));

var _logger = _interopRequireDefault(require("./logger"));

var _http = _interopRequireDefault(require("http"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _imageUtil = require("./image-util");

var _mjpegServer = _interopRequireDefault(require("mjpeg-server"));

var _stream = require("stream");

var _node = require("./node");

let MJpegConsumer = null;

async function initMJpegConsumer() {
  if (!MJpegConsumer) {
    try {
      MJpegConsumer = await (0, _node.requirePackage)('mjpeg-consumer');
    } catch (ign) {}
  }

  if (!MJpegConsumer) {
    throw new Error('mjpeg-consumer module is required to use MJPEG-over-HTTP features. ' + 'Please install it first (npm i -g mjpeg-consumer) and restart Appium.');
  }
}

const TEST_IMG_JPG = '/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAAAeAAD/4QOBaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6NGY5ODc1OTctZGE2My00Y2M0LTkzNDMtNGYyNjgzMGUwNjk3IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjlDMzI3QkY0N0Q3NTExRThCMTlDOTVDMDc2RDE5MDY5IiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjlDMzI3QkYzN0Q3NTExRThCMTlDOTVDMDc2RDE5MDY5IiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE4IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NGY5ODc1OTctZGE2My00Y2M0LTkzNDMtNGYyNjgzMGUwNjk3IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjRmOTg3NTk3LWRhNjMtNGNjNC05MzQzLTRmMjY4MzBlMDY5NyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pv/uAA5BZG9iZQBkwAAAAAH/2wCEABALCwsMCxAMDBAXDw0PFxsUEBAUGx8XFxcXFx8eFxoaGhoXHh4jJSclIx4vLzMzLy9AQEBAQEBAQEBAQEBAQEABEQ8PERMRFRISFRQRFBEUGhQWFhQaJhoaHBoaJjAjHh4eHiMwKy4nJycuKzU1MDA1NUBAP0BAQEBAQEBAQEBAQP/AABEIACAAIAMBIgACEQEDEQH/xABgAAEAAwEAAAAAAAAAAAAAAAAABAUHCAEBAAAAAAAAAAAAAAAAAAAAABAAAQMCAgsAAAAAAAAAAAAAAAECBBEDEgYhMRODo7PTVAUWNhEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8Az8AAdAAAAAAI8+fE8dEuTZtzZR7VMb6OdTE5GJoYirrUp/e8qd9wb3TGe/lJ2551sx8D/9k=';
exports.TEST_IMG_JPG = TEST_IMG_JPG;
const MJPEG_SERVER_TIMEOUT_MS = 10000;

class MJpegStream extends _stream.Writable {
  constructor(mJpegUrl, errorHandler = _lodash.default.noop, options = {}) {
    super(options);
    this.errorHandler = errorHandler;
    this.url = mJpegUrl;
    this.clear();
  }

  get lastChunkBase64() {
    return _lodash.default.isBuffer(this.lastChunk) ? this.lastChunk.toString('base64') : null;
  }

  async lastChunkPNG() {
    if (!_lodash.default.isBuffer(this.lastChunk)) {
      return null;
    }

    const jpg = await (0, _imageUtil.getJimpImage)(this.lastChunk);
    return await jpg.getBuffer(_imageUtil.MIME_PNG);
  }

  async lastChunkPNGBase64() {
    const png = await this.lastChunkPNG();

    if (!png) {
      return null;
    }

    return png.toString('base64');
  }

  clear() {
    this.registerStartSuccess = null;
    this.registerStartFailure = null;
    this.request = null;
    this.consumer = null;
    this.lastChunk = null;
    this.updateCount = 0;
  }

  async start(serverTimeout = MJPEG_SERVER_TIMEOUT_MS) {
    this.stop();
    await initMJpegConsumer();
    this.consumer = new MJpegConsumer();
    const startPromise = new _bluebird.default((res, rej) => {
      this.registerStartSuccess = res;
      this.registerStartFailure = rej;
    }).timeout(serverTimeout, `Waited ${serverTimeout}ms but the MJPEG server never sent any images`);

    const onErr = err => {
      _logger.default.error(`Error getting MJpeg screenshot chunk: ${err}`);

      this.errorHandler(err);

      if (this.registerStartFailure) {
        this.registerStartFailure(err);
      }
    };

    this.request = (0, _request.default)(this.url);
    this.request.on('error', onErr).pipe(this.consumer).pipe(this);
    await startPromise;
  }

  stop() {
    if (!this.consumer) {
      return;
    }

    this.consumer.unpipe();
    this.request.end();
    this.clear();
  }

  write(data) {
    this.lastChunk = data;
    this.updateCount++;

    if (this.registerStartSuccess) {
      this.registerStartSuccess();
      this.registerStartSuccess = null;
    }
  }

}

exports.MJpegStream = MJpegStream;

function initMJpegServer(port, intMs = 300, times = 20) {
  const server = _http.default.createServer(async function (req, res) {
    const mJpegReqHandler = _mjpegServer.default.createReqHandler(req, res);

    const jpg = Buffer.from(TEST_IMG_JPG, 'base64');

    for (let i = 0; i < times; i++) {
      await _bluebird.default.delay(intMs);

      mJpegReqHandler._write(jpg, null, _lodash.default.noop);
    }

    mJpegReqHandler.close();
  }).listen(port);

  return server;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9tanBlZy5qcyJdLCJuYW1lcyI6WyJNSnBlZ0NvbnN1bWVyIiwiaW5pdE1KcGVnQ29uc3VtZXIiLCJpZ24iLCJFcnJvciIsIlRFU1RfSU1HX0pQRyIsIk1KUEVHX1NFUlZFUl9USU1FT1VUX01TIiwiTUpwZWdTdHJlYW0iLCJXcml0YWJsZSIsImNvbnN0cnVjdG9yIiwibUpwZWdVcmwiLCJlcnJvckhhbmRsZXIiLCJfIiwibm9vcCIsIm9wdGlvbnMiLCJ1cmwiLCJjbGVhciIsImxhc3RDaHVua0Jhc2U2NCIsImlzQnVmZmVyIiwibGFzdENodW5rIiwidG9TdHJpbmciLCJsYXN0Q2h1bmtQTkciLCJqcGciLCJnZXRCdWZmZXIiLCJNSU1FX1BORyIsImxhc3RDaHVua1BOR0Jhc2U2NCIsInBuZyIsInJlZ2lzdGVyU3RhcnRTdWNjZXNzIiwicmVnaXN0ZXJTdGFydEZhaWx1cmUiLCJyZXF1ZXN0IiwiY29uc3VtZXIiLCJ1cGRhdGVDb3VudCIsInN0YXJ0Iiwic2VydmVyVGltZW91dCIsInN0b3AiLCJzdGFydFByb21pc2UiLCJCIiwicmVzIiwicmVqIiwidGltZW91dCIsIm9uRXJyIiwiZXJyIiwibG9nIiwiZXJyb3IiLCJvbiIsInBpcGUiLCJ1bnBpcGUiLCJlbmQiLCJ3cml0ZSIsImRhdGEiLCJpbml0TUpwZWdTZXJ2ZXIiLCJwb3J0IiwiaW50TXMiLCJ0aW1lcyIsInNlcnZlciIsImh0dHAiLCJjcmVhdGVTZXJ2ZXIiLCJyZXEiLCJtSnBlZ1JlcUhhbmRsZXIiLCJtSnBlZ1NlcnZlciIsImNyZWF0ZVJlcUhhbmRsZXIiLCJCdWZmZXIiLCJmcm9tIiwiaSIsImRlbGF5IiwiX3dyaXRlIiwiY2xvc2UiLCJsaXN0ZW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUlBLElBQUlBLGFBQWEsR0FBRyxJQUFwQjs7QUFLQSxlQUFlQyxpQkFBZixHQUFvQztB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QUNELEdBVmMsRUFVWkMsTUFWWSxDQVVMaEIsSUFWSyxDQUFmOztBQVlBLFNBQU9HLE1BQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBnZXRKaW1wSW1hZ2UsIE1JTUVfUE5HIH0gZnJvbSAnLi9pbWFnZS11dGlsJztcbmltcG9ydCBtSnBlZ1NlcnZlciBmcm9tICdtanBlZy1zZXJ2ZXInO1xuaW1wb3J0IHsgV3JpdGFibGUgfSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHsgcmVxdWlyZVBhY2thZ2UgfSBmcm9tICcuL25vZGUnO1xuXG5cbi8vIGxhenkgbG9hZCB0aGlzLCBhcyBpdCBtaWdodCBub3QgYmUgYXZhaWxhYmxlXG5sZXQgTUpwZWdDb25zdW1lciA9IG51bGw7XG5cbi8qKlxuICogQHRocm93cyB7RXJyb3J9IElmIGBtanBlZy1jb25zdW1lcmAgbW9kdWxlIGlzIG5vdCBpbnN0YWxsZWQgb3IgY2Fubm90IGJlIGxvYWRlZFxuICovXG5hc3luYyBmdW5jdGlvbiBpbml0TUpwZWdDb25zdW1lciAoKSB7XG4gIGlmICghTUpwZWdDb25zdW1lcikge1xuICAgIHRyeSB7XG4gICAgICBNSnBlZ0NvbnN1bWVyID0gYXdhaXQgcmVxdWlyZVBhY2thZ2UoJ21qcGVnLWNvbnN1bWVyJyk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICB9XG4gIGlmICghTUpwZWdDb25zdW1lcikge1xuICAgIHRocm93IG5ldyBFcnJvcignbWpwZWctY29uc3VtZXIgbW9kdWxlIGlzIHJlcXVpcmVkIHRvIHVzZSBNSlBFRy1vdmVyLUhUVFAgZmVhdHVyZXMuICcgK1xuICAgICAgICAgICAgICAgICAgICAnUGxlYXNlIGluc3RhbGwgaXQgZmlyc3QgKG5wbSBpIC1nIG1qcGVnLWNvbnN1bWVyKSBhbmQgcmVzdGFydCBBcHBpdW0uJyk7XG4gIH1cbn1cblxuY29uc3QgVEVTVF9JTUdfSlBHID0gJy85ai80UUFZUlhocFpnQUFTVWtxQUFnQUFBQUFBQUFBQUFBQUFQL3NBQkZFZFdOcmVRQUJBQVFBQUFBZUFBRC80UU9CYUhSMGNEb3ZMMjV6TG1Ga2IySmxMbU52YlM5NFlYQXZNUzR3THdBOFAzaHdZV05yWlhRZ1ltVm5hVzQ5SXUrN3Z5SWdhV1E5SWxjMVRUQk5jRU5sYUdsSWVuSmxVM3BPVkdONmEyTTVaQ0kvUGlBOGVEcDRiWEJ0WlhSaElIaHRiRzV6T25nOUltRmtiMkpsT201ek9tMWxkR0V2SWlCNE9uaHRjSFJyUFNKQlpHOWlaU0JZVFZBZ1EyOXlaU0ExTGpZdFl6RTBNQ0EzT1M0eE5qQTBOVEVzSURJd01UY3ZNRFV2TURZdE1ERTZNRGc2TWpFZ0lDQWdJQ0FnSUNJK0lEeHlaR1k2VWtSR0lIaHRiRzV6T25Ka1pqMGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNVGs1T1M4d01pOHlNaTF5WkdZdGMzbHVkR0Y0TFc1ekl5SStJRHh5WkdZNlJHVnpZM0pwY0hScGIyNGdjbVJtT21GaWIzVjBQU0lpSUhodGJHNXpPbmh0Y0UxTlBTSm9kSFJ3T2k4dmJuTXVZV1J2WW1VdVkyOXRMM2hoY0M4eExqQXZiVzB2SWlCNGJXeHVjenB6ZEZKbFpqMGlhSFIwY0RvdkwyNXpMbUZrYjJKbExtTnZiUzk0WVhBdk1TNHdMM05VZVhCbEwxSmxjMjkxY21ObFVtVm1JeUlnZUcxc2JuTTZlRzF3UFNKb2RIUndPaTh2Ym5NdVlXUnZZbVV1WTI5dEwzaGhjQzh4TGpBdklpQjRiWEJOVFRwUGNtbG5hVzVoYkVSdlkzVnRaVzUwU1VROUluaHRjQzVrYVdRNk5HWTVPRGMxT1RjdFpHRTJNeTAwWTJNMExUa3pORE10TkdZeU5qZ3pNR1V3TmprM0lpQjRiWEJOVFRwRWIyTjFiV1Z1ZEVsRVBTSjRiWEF1Wkdsa09qbERNekkzUWtZME4wUTNOVEV4UlRoQ01UbERPVFZETURjMlJERTVNRFk1SWlCNGJYQk5UVHBKYm5OMFlXNWpaVWxFUFNKNGJYQXVhV2xrT2psRE16STNRa1l6TjBRM05URXhSVGhDTVRsRE9UVkRNRGMyUkRFNU1EWTVJaUI0YlhBNlEzSmxZWFJ2Y2xSdmIydzlJa0ZrYjJKbElGQm9iM1J2YzJodmNDQkRReUF5TURFNElDaE5ZV05wYm5SdmMyZ3BJajRnUEhodGNFMU5Pa1JsY21sMlpXUkdjbTl0SUhOMFVtVm1PbWx1YzNSaGJtTmxTVVE5SW5odGNDNXBhV1E2TkdZNU9EYzFPVGN0WkdFMk15MDBZMk0wTFRrek5ETXROR1l5Tmpnek1HVXdOamszSWlCemRGSmxaanBrYjJOMWJXVnVkRWxFUFNKNGJYQXVaR2xrT2pSbU9UZzNOVGszTFdSaE5qTXROR05qTkMwNU16UXpMVFJtTWpZNE16QmxNRFk1TnlJdlBpQThMM0prWmpwRVpYTmpjbWx3ZEdsdmJqNGdQQzl5WkdZNlVrUkdQaUE4TDNnNmVHMXdiV1YwWVQ0Z1BEOTRjR0ZqYTJWMElHVnVaRDBpY2lJL1B2L3VBQTVCWkc5aVpRQmt3QUFBQUFILzJ3Q0VBQkFMQ3dzTUN4QU1EQkFYRHcwUEZ4c1VFQkFVR3g4WEZ4Y1hGeDhlRnhvYUdob1hIaDRqSlNjbEl4NHZMek16THk5QVFFQkFRRUJBUUVCQVFFQkFRRUFCRVE4UEVSTVJGUklTRlJRUkZCRVVHaFFXRmhRYUpob2FIQm9hSmpBakhoNGVIaU13S3k0bkp5Y3VLelUxTURBMU5VQkFQMEJBUUVCQVFFQkFRRUJBUVAvQUFCRUlBQ0FBSUFNQklnQUNFUUVERVFIL3hBQmdBQUVBQXdFQUFBQUFBQUFBQUFBQUFBQUFCQVVIQ0FFQkFBQUFBQUFBQUFBQUFBQUFBQUFBQUJBQUFRTUNBZ3NBQUFBQUFBQUFBQUFBQUFFQ0JCRURFZ1loTVJPRG83UFRWQVVXTmhFQkFBQUFBQUFBQUFBQUFBQUFBQUFBQVAvYUFBd0RBUUFDRVFNUkFEOEF6OEFBZEFBQUFBQUk4K2ZFOGRFdVRadHpaUjdWTWI2T2RURTVHSm9ZaXJyVXAvZThxZDl3YjNUR2UvbEoyNTUxc3g4RC85az0nO1xuXG4vLyBhbW91bnQgb2YgdGltZSB0byB3YWl0IGZvciB0aGUgZmlyc3QgaW1hZ2UgaW4gdGhlIHN0cmVhbVxuY29uc3QgTUpQRUdfU0VSVkVSX1RJTUVPVVRfTVMgPSAxMDAwMDtcblxuLyoqIENsYXNzIHdoaWNoIHN0b3JlcyB0aGUgbGFzdCBiaXQgb2YgZGF0YSBzdHJlYW1lZCBpbnRvIGl0ICovXG5jbGFzcyBNSnBlZ1N0cmVhbSBleHRlbmRzIFdyaXRhYmxlIHtcblxuICAvKipcbiAgICogQ3JlYXRlIGFuIE1KcGVnU3RyZWFtXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBtSnBlZ1VybCAtIFVSTCBvZiBNSlBFRy1vdmVyLUhUVFAgc3RyZWFtXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtlcnJvckhhbmRsZXI9bm9vcF0gLSBhZGRpdGlvbmFsIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZVxuICAgKiBjYWxsZWQgaW4gdGhlIGNhc2Ugb2YgYW55IGVycm9ycy5cbiAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zPXt9XSAtIE9wdGlvbnMgdG8gcGFzcyB0byB0aGUgV3JpdGFibGUgY29uc3RydWN0b3JcbiAgICovXG4gIGNvbnN0cnVjdG9yIChtSnBlZ1VybCwgZXJyb3JIYW5kbGVyID0gXy5ub29wLCBvcHRpb25zID0ge30pIHtcbiAgICBzdXBlcihvcHRpb25zKTtcblxuICAgIHRoaXMuZXJyb3JIYW5kbGVyID0gZXJyb3JIYW5kbGVyO1xuICAgIHRoaXMudXJsID0gbUpwZWdVcmw7XG4gICAgdGhpcy5jbGVhcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgYmFzZTY0LWVuY29kZWQgdmVyc2lvbiBvZiB0aGUgSlBFR1xuICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgKi9cbiAgZ2V0IGxhc3RDaHVua0Jhc2U2NCAoKSB7XG4gICAgcmV0dXJuIF8uaXNCdWZmZXIodGhpcy5sYXN0Q2h1bmspID9cbiAgICAgIHRoaXMubGFzdENodW5rLnRvU3RyaW5nKCdiYXNlNjQnKSA6XG4gICAgICBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgUE5HIHZlcnNpb24gb2YgdGhlIEpQRUcgYnVmZmVyXG4gICAqIEByZXR1cm5zIHtCdWZmZXJ9IFBORyBpbWFnZSBkYXRhXG4gICAqL1xuICBhc3luYyBsYXN0Q2h1bmtQTkcgKCkge1xuICAgIGlmICghXy5pc0J1ZmZlcih0aGlzLmxhc3RDaHVuaykpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGpwZyA9IGF3YWl0IGdldEppbXBJbWFnZSh0aGlzLmxhc3RDaHVuayk7XG4gICAgcmV0dXJuIGF3YWl0IGpwZy5nZXRCdWZmZXIoTUlNRV9QTkcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgYmFzZTY0LWVuY29kZWQgdmVyc2lvbiBvZiB0aGUgUE5HXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAqL1xuICBhc3luYyBsYXN0Q2h1bmtQTkdCYXNlNjQgKCkge1xuICAgIGNvbnN0IHBuZyA9IGF3YWl0IHRoaXMubGFzdENodW5rUE5HKCk7XG5cbiAgICBpZiAoIXBuZykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBuZy50b1N0cmluZygnYmFzZTY0Jyk7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXQgaW50ZXJuYWwgc3RhdGVcbiAgICovXG4gIGNsZWFyICgpIHtcbiAgICB0aGlzLnJlZ2lzdGVyU3RhcnRTdWNjZXNzID0gbnVsbDtcbiAgICB0aGlzLnJlZ2lzdGVyU3RhcnRGYWlsdXJlID0gbnVsbDtcbiAgICB0aGlzLnJlcXVlc3QgPSBudWxsO1xuICAgIHRoaXMuY29uc3VtZXIgPSBudWxsO1xuICAgIHRoaXMubGFzdENodW5rID0gbnVsbDtcbiAgICB0aGlzLnVwZGF0ZUNvdW50ID0gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCByZWFkaW5nIHRoZSBNSnBlZyBzdHJlYW0gYW5kIHN0b3JpbmcgdGhlIGxhc3QgaW1hZ2VcbiAgICovXG4gIGFzeW5jIHN0YXJ0IChzZXJ2ZXJUaW1lb3V0ID0gTUpQRUdfU0VSVkVSX1RJTUVPVVRfTVMpIHtcbiAgICAvLyBlbnN1cmUgd2UncmUgbm90IHN0YXJ0ZWQgYWxyZWFkeVxuICAgIHRoaXMuc3RvcCgpO1xuXG4gICAgYXdhaXQgaW5pdE1KcGVnQ29uc3VtZXIoKTtcblxuICAgIHRoaXMuY29uc3VtZXIgPSBuZXcgTUpwZWdDb25zdW1lcigpO1xuXG4gICAgLy8gdXNlIHRoZSBkZWZlcnJlZCBwYXR0ZXJuIHNvIHdlIGNhbiB3YWl0IGZvciB0aGUgc3RhcnQgb2YgdGhlIHN0cmVhbVxuICAgIC8vIGJhc2VkIG9uIHdoYXQgY29tZXMgaW4gZnJvbSBhbiBleHRlcm5hbCBwaXBlXG4gICAgY29uc3Qgc3RhcnRQcm9taXNlID0gbmV3IEIoKHJlcywgcmVqKSA9PiB7XG4gICAgICB0aGlzLnJlZ2lzdGVyU3RhcnRTdWNjZXNzID0gcmVzO1xuICAgICAgdGhpcy5yZWdpc3RlclN0YXJ0RmFpbHVyZSA9IHJlajtcbiAgICB9KVxuICAgIC8vIHN0YXJ0IGEgdGltZW91dCBzbyB0aGF0IGlmIHRoZSBzZXJ2ZXIgZG9lcyBub3QgcmV0dXJuIGRhdGEsIHdlIGRvbid0XG4gICAgLy8gYmxvY2sgZm9yZXZlci5cbiAgICAgIC50aW1lb3V0KHNlcnZlclRpbWVvdXQsXG4gICAgICAgIGBXYWl0ZWQgJHtzZXJ2ZXJUaW1lb3V0fW1zIGJ1dCB0aGUgTUpQRUcgc2VydmVyIG5ldmVyIHNlbnQgYW55IGltYWdlc2ApO1xuXG4gICAgY29uc3Qgb25FcnIgPSAoZXJyKSA9PiB7XG4gICAgICBsb2cuZXJyb3IoYEVycm9yIGdldHRpbmcgTUpwZWcgc2NyZWVuc2hvdCBjaHVuazogJHtlcnJ9YCk7XG4gICAgICB0aGlzLmVycm9ySGFuZGxlcihlcnIpO1xuICAgICAgaWYgKHRoaXMucmVnaXN0ZXJTdGFydEZhaWx1cmUpIHtcbiAgICAgICAgdGhpcy5yZWdpc3RlclN0YXJ0RmFpbHVyZShlcnIpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0KHRoaXMudXJsKTtcblxuICAgIHRoaXMucmVxdWVzdFxuICAgICAgLm9uKCdlcnJvcicsIG9uRXJyKSAvLyBlbnN1cmUgd2UgZG8gc29tZXRoaW5nIHdpdGggZXJyb3JzXG4gICAgICAucGlwZSh0aGlzLmNvbnN1bWVyKSAvLyBhbGxvdyBjaHVua2luZyBhbmQgdHJhbnNmb3JtaW5nIG9mIGpwZWcgZGF0YVxuICAgICAgLnBpcGUodGhpcyk7IC8vIHNlbmQgdGhlIGFjdHVhbCBqcGVncyB0byBvdXJzZWxmXG5cbiAgICBhd2FpdCBzdGFydFByb21pc2U7XG4gIH1cblxuICAvKipcbiAgICogU3RvcCByZWFkaW5nIHRoZSBNSnBlZyBzdHJlYW0uIEVuc3VyZSB3ZSBkaXNjb25uZWN0IGFsbCB0aGUgcGlwZXMgYW5kIHN0b3BcbiAgICogdGhlIEhUVFAgcmVxdWVzdCBpdHNlbGYuIFRoZW4gcmVzZXQgdGhlIHN0YXRlLlxuICAgKi9cbiAgc3RvcCAoKSB7XG4gICAgaWYgKCF0aGlzLmNvbnN1bWVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5jb25zdW1lci51bnBpcGUoKTtcbiAgICB0aGlzLnJlcXVlc3QuZW5kKCk7XG4gICAgdGhpcy5jbGVhcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIE92ZXJyaWRlIHRoZSBXcml0YWJsZSB3cml0ZSgpIG1ldGhvZCBpbiBvcmRlciB0byBzYXZlIHRoZSBsYXN0IGltYWdlIGFuZFxuICAgKiBsb2cgdGhlIG51bWJlciBvZiBpbWFnZXMgd2UgaGF2ZSByZWNlaXZlZFxuICAgKiBAb3ZlcnJpZGVcbiAgICogQHBhcmFtIHtCdWZmZXJ9IGRhdGEgLSBiaW5hcnkgZGF0YSBzdHJlYW1lZCBmcm9tIHRoZSBNSnBlZyBjb25zdW1lclxuICAgKi9cbiAgd3JpdGUgKGRhdGEpIHtcbiAgICB0aGlzLmxhc3RDaHVuayA9IGRhdGE7XG4gICAgdGhpcy51cGRhdGVDb3VudCsrO1xuXG4gICAgaWYgKHRoaXMucmVnaXN0ZXJTdGFydFN1Y2Nlc3MpIHtcbiAgICAgIHRoaXMucmVnaXN0ZXJTdGFydFN1Y2Nlc3MoKTtcbiAgICAgIHRoaXMucmVnaXN0ZXJTdGFydFN1Y2Nlc3MgPSBudWxsO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIFN0YXJ0IGFuIG1qcGVnIHNlcnZlciBmb3IgdGhlIHB1cnBvc2Ugb2YgdGVzdGluZywgd2hpY2gganVzdCBzZW5kcyB0aGUgc2FtZVxuICogaW1hZ2Ugb3ZlciBhbmQgb3Zlci4gQ2FsbGVyIGlzIHJlc3BvbnNpYmxlIGZvciBjbG9zaW5nIHRoZSBzZXJ2ZXIuXG4gKiBAcGFyYW0ge2ludH0gcG9ydCAtIHBvcnQgdGhlIHNlcnZlciBzaG91bGQgbGlzdGVuIG9uXG4gKiBAcGFyYW0ge2ludH0gW2ludE1zXSAtIGhvdyBvZnRlbiB0aGUgc2VydmVyIHNob3VsZCBwdXNoIGFuIGltYWdlXG4gKiBAcGFyYW0ge2ludH0gW3RpbWVzXSAtIGhvdyBtYW55IHRpbWVzIHRoZSBzZXJ2ZXIgc2hvdWxkIHB1c2ggYW4gaW1hZ2UgYmVmb3JlXG4gKiBpdCBjbG9zZXMgdGhlIGNvbm5lY3Rpb25cbiAqIEByZXR1cm5zIHtodHRwLlNlcnZlcn1cbiAqL1xuZnVuY3Rpb24gaW5pdE1KcGVnU2VydmVyIChwb3J0LCBpbnRNcyA9IDMwMCwgdGltZXMgPSAyMCkge1xuICBjb25zdCBzZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhc3luYyBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICBjb25zdCBtSnBlZ1JlcUhhbmRsZXIgPSBtSnBlZ1NlcnZlci5jcmVhdGVSZXFIYW5kbGVyKHJlcSwgcmVzKTtcbiAgICBjb25zdCBqcGcgPSBCdWZmZXIuZnJvbShURVNUX0lNR19KUEcsICdiYXNlNjQnKTtcblxuICAgIC8vIGp1c3Qgc2VuZCB0aGUgc2FtZSBqcGVnIG92ZXIgYW5kIG92ZXJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVzOyBpKyspIHtcbiAgICAgIGF3YWl0IEIuZGVsYXkoaW50TXMpO1xuICAgICAgbUpwZWdSZXFIYW5kbGVyLl93cml0ZShqcGcsIG51bGwsIF8ubm9vcCk7XG4gICAgfVxuICAgIG1KcGVnUmVxSGFuZGxlci5jbG9zZSgpO1xuICB9KS5saXN0ZW4ocG9ydCk7XG5cbiAgcmV0dXJuIHNlcnZlcjtcbn1cblxuZXhwb3J0IHsgTUpwZWdTdHJlYW0sIGluaXRNSnBlZ1NlcnZlciwgVEVTVF9JTUdfSlBHIH07XG4iXSwiZmlsZSI6ImxpYi9tanBlZy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
