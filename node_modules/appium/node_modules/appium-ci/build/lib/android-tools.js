"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Emulator = exports.androidTools = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _stream = _interopRequireDefault(require("stream"));

var _fs = _interopRequireDefault(require("fs"));

var _split = _interopRequireDefault(require("split"));

var _os = _interopRequireDefault(require("os"));

var _utils = _interopRequireDefault(require("./utils"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

_bluebird.default.config({
  cancellation: true
});

const log = _appiumSupport.logger.getLogger('android-tools');

const DEFAULT_OPTS = {
  initWait: 15000,
  maxWait: 300000,
  pool: 5000
};
const androidTools = {
  killAll: function () {
    var _killAll = (0, _asyncToGenerator2.default)(function* (processes = ['emulator']) {
      processes = _lodash.default.flatten([processes]);
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = processes[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          const p = _step.value;
          const cmd = process.platform.match(/^win/) ? `powershell -Command "Stop-Process -Name *${p}*"` : `sudo pkill -f ${p}`;
          log.warn(`Killing process with command: ${cmd}`);
          yield _utils.default.exec(cmd).catch(() => {});
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return != null) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }
    });

    return function killAll() {
      return _killAll.apply(this, arguments);
    };
  }()
};
exports.androidTools = androidTools;

class Emulator {
  constructor(avd, opts = {}) {
    this.avd = avd;
    this.opts = Object.assign({}, DEFAULT_OPTS, opts);
  }

  start() {
    const out = new _stream.default.PassThrough();
    out.pipe((0, _split.default)()).on('data', line => {
      log.info(line);
    });
    out.pipe(_fs.default.createWriteStream('emulator.log'));
    const emuBin = _os.default.platform() === 'linux' ? 'emulator64-x86' : 'emulator';
    let emuArgs = ['-avd', this.avd, '-no-snapshot-load', '-no-snapshot-save', '-no-audio', '-netfast'];

    if (_os.default.platform() === 'linux') {
      emuArgs = emuArgs.concat(['-qemu', '-m', '512', '-enable-kvm']);
    }

    log.info(`Executing command: ${emuBin} ${emuArgs.join(' ')}`);
    this.child = _utils.default.spawn(emuBin, emuArgs);
    this.child.stdout.pipe(out);
    this.child.stderr.pipe(out);
  }

  waitTillReady() {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const startMs = Date.now();
      let timeoutPromise;
      let emuStarted = false;
      let emuErrored = false;
      const procPromise = new _bluebird.default((resolve, reject, onCancel) => {
        _this.child.on('error', err => {
          emuErrored = true;
          reject(`Emulator did not start properly, error: ${err}`);
        });

        _this.child.on('close', () => {
          if (!emuStarted) {
            emuErrored = true;
            reject('Emulator closed too early, see emu logs for errors.');
          }
        });

        onCancel(() => reject(new _bluebird.default.CancellationError()));
      }).catch(_bluebird.default.CancellationError, () => {});

      const _waitForEmu = function () {
        var _ref = (0, _asyncToGenerator2.default)(function* (waitMs = _this.opts.pool) {
          if (waitMs > 0) {
            log.info(`Waiting ${waitMs}ms for emu...`);
            timeoutPromise = new _bluebird.default((resolve, reject, onCancel) => {
              onCancel(() => reject(new _bluebird.default.CancellationError()));
            }).timeout(waitMs);
            yield timeoutPromise.catch(_bluebird.default.Promise.TimeoutError, () => {}).catch(_bluebird.default.Promise.CancellationError, () => {});
          }

          if (emuErrored) {
            throw new Error('Emulator errored');
          }

          if (Date.now() - startMs > _this.opts.maxWait) {
            throw new Error('Emulator did not show up');
          }

          let stdout;

          try {
            var _ref2 = yield _utils.default.exec('adb shell getprop sys.boot_completed');

            var _ref3 = (0, _slicedToArray2.default)(_ref2, 1);

            stdout = _ref3[0];
          } catch (err) {
            if (err.toString().match(/device not found/)) {
              log.warn('Device not found, it should be there, killing adb server.');
              return _utils.default.exec('adb kill-server').then(() => {
                return _waitForEmu();
              });
            } else if (err.toString().match(/device offline/)) {
              return _waitForEmu();
            } else {
              throw err;
            }
          }

          if (stdout && stdout.trim() === '1') {
            log.info('Emulator started');
            emuStarted = true;
          } else {
            yield _waitForEmu();
          }
        });

        return function _waitForEmu() {
          return _ref.apply(this, arguments);
        };
      }();

      yield _bluebird.default.race([_waitForEmu(_this.opts.initWait), procPromise]).finally(() => {
        timeoutPromise.cancel();
        procPromise.cancel();
      });
    })();
  }

  stop() {
    if (this.child) {
      this.child.kill();
    }
  }

}

exports.Emulator = Emulator;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hbmRyb2lkLXRvb2xzLmpzIl0sIm5hbWVzIjpbIkIiLCJjb25maWciLCJjYW5jZWxsYXRpb24iLCJsb2ciLCJsb2dnZXIiLCJnZXRMb2dnZXIiLCJERUZBVUxUX09QVFMiLCJpbml0V2FpdCIsIm1heFdhaXQiLCJwb29sIiwiYW5kcm9pZFRvb2xzIiwia2lsbEFsbCIsInByb2Nlc3NlcyIsIl8iLCJmbGF0dGVuIiwicCIsImNtZCIsInByb2Nlc3MiLCJwbGF0Zm9ybSIsIm1hdGNoIiwid2FybiIsInV0aWxzIiwiZXhlYyIsImNhdGNoIiwiRW11bGF0b3IiLCJjb25zdHJ1Y3RvciIsImF2ZCIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJzdGFydCIsIm91dCIsInN0cmVhbSIsIlBhc3NUaHJvdWdoIiwicGlwZSIsIm9uIiwibGluZSIsImluZm8iLCJmcyIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiZW11QmluIiwib3MiLCJlbXVBcmdzIiwiY29uY2F0Iiwiam9pbiIsImNoaWxkIiwic3Bhd24iLCJzdGRvdXQiLCJzdGRlcnIiLCJ3YWl0VGlsbFJlYWR5Iiwic3RhcnRNcyIsIkRhdGUiLCJub3ciLCJ0aW1lb3V0UHJvbWlzZSIsImVtdVN0YXJ0ZWQiLCJlbXVFcnJvcmVkIiwicHJvY1Byb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwib25DYW5jZWwiLCJlcnIiLCJDYW5jZWxsYXRpb25FcnJvciIsIl93YWl0Rm9yRW11Iiwid2FpdE1zIiwidGltZW91dCIsIlByb21pc2UiLCJUaW1lb3V0RXJyb3IiLCJFcnJvciIsInRvU3RyaW5nIiwidGhlbiIsInRyaW0iLCJyYWNlIiwiZmluYWxseSIsImNhbmNlbCIsInN0b3AiLCJraWxsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0FBLGtCQUFFQyxNQUFGLENBQVM7QUFDUEMsRUFBQUEsWUFBWSxFQUFFO0FBRFAs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QyxXQUFXLEVBQWxCO0FBQ0QsYUFITSxNQUdBO0FBQ0wsb0JBQU9GLEdBQVA7QUFDRDtBQUNGOztBQUdELGNBQUliLE1BQU0sSUFBSUEsTUFBTSxDQUFDdUIsSUFBUCxPQUFrQixHQUFoQyxFQUFxQztBQUNuQ25FLFlBQUFBLEdBQUcsQ0FBQ2tDLElBQUosQ0FBUyxrQkFBVDtBQUNBaUIsWUFBQUEsVUFBVSxHQUFHLElBQWI7QUFDRCxXQUhELE1BR087QUFDTCxrQkFBTVEsV0FBVyxFQUFqQjtBQUNEO0FBQ0YsU0EzQ2dCOztBQUFBLHdCQUFYQSxXQUFXO0FBQUE7QUFBQTtBQUFBLFNBQWpCOztBQThDQSxZQUFNOUQsa0JBQUV1RSxJQUFGLENBQU8sQ0FBQ1QsV0FBVyxDQUFDLEtBQUksQ0FBQ25DLElBQUwsQ0FBVXBCLFFBQVgsQ0FBWixFQUFrQ2lELFdBQWxDLENBQVAsRUFDSGdCLE9BREcsQ0FDSyxNQUFNO0FBRWJuQixRQUFBQSxjQUFjLENBQUNvQixNQUFmO0FBQ0FqQixRQUFBQSxXQUFXLENBQUNpQixNQUFaO0FBQ0QsT0FMRyxDQUFOO0FBbkVxQjtBQTBFdEI7O0FBRURDLEVBQUFBLElBQUksR0FBSTtBQUNOLFFBQUksS0FBSzdCLEtBQVQsRUFBZ0I7QUFDZCxXQUFLQSxLQUFMLENBQVc4QixJQUFYO0FBQ0Q7QUFDRjs7QUFoSG1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHN0cmVhbSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBzcGxpdCBmcm9tICdzcGxpdCc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IHV0aWxzIGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuXG5CLmNvbmZpZyh7XG4gIGNhbmNlbGxhdGlvbjogdHJ1ZSxcbn0pO1xuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdhbmRyb2lkLXRvb2xzJyk7XG5cbmNvbnN0IERFRkFVTFRfT1BUUyA9IHtcbiAgaW5pdFdhaXQ6IDE1MDAwLFxuICBtYXhXYWl0OiAzMDAwMDAsXG4gIHBvb2w6IDUwMDAsXG59O1xuXG5jb25zdCBhbmRyb2lkVG9vbHMgPSB7XG4gIGtpbGxBbGw6IGFzeW5jIChwcm9jZXNzZXMgPSBbJ2VtdWxhdG9yJ10pID0+IHtcbiAgICBwcm9jZXNzZXMgPSBfLmZsYXR0ZW4oW3Byb2Nlc3Nlc10pO1xuICAgIGZvciAoY29uc3QgcCBvZiBwcm9jZXNzZXMpIHtcbiAgICAgIGNvbnN0IGNtZCA9IHByb2Nlc3MucGxhdGZvcm0ubWF0Y2goL153aW4vKVxuICAgICAgICA/IGBwb3dlcnNoZWxsIC1Db21tYW5kIFwiU3RvcC1Qcm9jZXNzIC1OYW1lICoke3B9KlwiYFxuICAgICAgICA6IGBzdWRvIHBraWxsIC1mICR7cH1gO1xuICAgICAgbG9nLndhcm4oYEtpbGxpbmcgcHJvY2VzcyB3aXRoIGNvbW1hbmQ6ICR7Y21kfWApO1xuICAgICAgYXdhaXQgdXRpbHMuZXhlYyhjbWQpLmNhdGNoKCgpID0+IHt9KTtcbiAgICB9XG4gIH1cbn07XG5cbmV4cG9ydCB7IGFuZHJvaWRUb29scyB9O1xuXG5leHBvcnQgY2xhc3MgRW11bGF0b3Ige1xuICBjb25zdHJ1Y3RvciAoYXZkLCBvcHRzID0ge30pIHtcbiAgICB0aGlzLmF2ZCA9IGF2ZDtcbiAgICB0aGlzLm9wdHMgPSBPYmplY3QuYXNzaWduKHt9LCBERUZBVUxUX09QVFMsIG9wdHMpO1xuICB9XG5cbiAgc3RhcnQgKCkge1xuICAgIGNvbnN0IG91dCA9IG5ldyBzdHJlYW0uUGFzc1Rocm91Z2goKTtcbiAgICBvdXQucGlwZShzcGxpdCgpKVxuICAgICAgLm9uKCdkYXRhJywgKGxpbmUpID0+IHtcbiAgICAgICAgbG9nLmluZm8obGluZSk7XG4gICAgICB9KTtcbiAgICBvdXQucGlwZShmcy5jcmVhdGVXcml0ZVN0cmVhbSgnZW11bGF0b3IubG9nJykpO1xuICAgIGNvbnN0IGVtdUJpbiA9IG9zLnBsYXRmb3JtKCkgPT09ICdsaW51eCcgPyAnZW11bGF0b3I2NC14ODYnIDogJ2VtdWxhdG9yJztcbiAgICBsZXQgZW11QXJncyA9IFtcbiAgICAgICctYXZkJywgdGhpcy5hdmQsXG4gICAgICAnLW5vLXNuYXBzaG90LWxvYWQnLFxuICAgICAgJy1uby1zbmFwc2hvdC1zYXZlJyxcbiAgICAgICctbm8tYXVkaW8nLFxuICAgICAgJy1uZXRmYXN0J1xuICAgIF07XG4gICAgaWYgKG9zLnBsYXRmb3JtKCkgPT09ICdsaW51eCcpIHtcbiAgICAgIGVtdUFyZ3MgPSBlbXVBcmdzLmNvbmNhdChbXG4gICAgICAgICctcWVtdScsICctbScsICc1MTInLCAnLWVuYWJsZS1rdm0nXG4gICAgICBdKTtcbiAgICB9XG4gICAgbG9nLmluZm8oYEV4ZWN1dGluZyBjb21tYW5kOiAke2VtdUJpbn0gJHtlbXVBcmdzLmpvaW4oJyAnKX1gKTtcbiAgICB0aGlzLmNoaWxkID0gdXRpbHMuc3Bhd24oZW11QmluLCBlbXVBcmdzKTtcbiAgICB0aGlzLmNoaWxkLnN0ZG91dC5waXBlKG91dCk7XG4gICAgdGhpcy5jaGlsZC5zdGRlcnIucGlwZShvdXQpO1xuICB9XG5cbiAgYXN5bmMgd2FpdFRpbGxSZWFkeSAoKSB7XG4gICAgY29uc3Qgc3RhcnRNcyA9IERhdGUubm93KCk7XG4gICAgbGV0IHRpbWVvdXRQcm9taXNlO1xuICAgIGxldCBlbXVTdGFydGVkID0gZmFsc2U7XG4gICAgbGV0IGVtdUVycm9yZWQgPSBmYWxzZTtcblxuICAgIC8vIG9uZSBjYW5jZWxsYWJsZSBwcm9taXNlIG1vbml0b3IgdGhlIHByb2MgZXZlbnRzIGZvciBhYm5vcm1hbCB0ZXJtaW5hdGlvblxuICAgIGNvbnN0IHByb2NQcm9taXNlID0gbmV3IEIoKHJlc29sdmUsIHJlamVjdCwgb25DYW5jZWwpID0+IHtcbiAgICAgIHRoaXMuY2hpbGQub24oJ2Vycm9yJywgKGVycikgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLWNhbGxiYWNrc1xuICAgICAgICBlbXVFcnJvcmVkID0gdHJ1ZTtcbiAgICAgICAgcmVqZWN0KGBFbXVsYXRvciBkaWQgbm90IHN0YXJ0IHByb3Blcmx5LCBlcnJvcjogJHtlcnJ9YCk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuY2hpbGQub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICBpZiAoIWVtdVN0YXJ0ZWQpIHtcbiAgICAgICAgICBlbXVFcnJvcmVkID0gdHJ1ZTtcbiAgICAgICAgICByZWplY3QoJ0VtdWxhdG9yIGNsb3NlZCB0b28gZWFybHksIHNlZSBlbXUgbG9ncyBmb3IgZXJyb3JzLicpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIG9uQ2FuY2VsKCgpID0+IHJlamVjdChuZXcgQi5DYW5jZWxsYXRpb25FcnJvcigpKSk7XG4gICAgfSkuY2F0Y2goQi5DYW5jZWxsYXRpb25FcnJvciwgKCkgPT4ge30pO1xuXG4gICAgY29uc3QgX3dhaXRGb3JFbXUgPSBhc3luYyAod2FpdE1zID0gdGhpcy5vcHRzLnBvb2wpID0+IHtcbiAgICAgIGlmICh3YWl0TXMgPiAwKSB7XG4gICAgICAgIGxvZy5pbmZvKGBXYWl0aW5nICR7d2FpdE1zfW1zIGZvciBlbXUuLi5gKTtcbiAgICAgICAgdGltZW91dFByb21pc2UgPSBuZXcgQigocmVzb2x2ZSwgcmVqZWN0LCBvbkNhbmNlbCkgPT4ge1xuICAgICAgICAgIG9uQ2FuY2VsKCgpID0+IHJlamVjdChuZXcgQi5DYW5jZWxsYXRpb25FcnJvcigpKSk7XG4gICAgICAgIH0pLnRpbWVvdXQod2FpdE1zKTtcbiAgICAgICAgYXdhaXQgdGltZW91dFByb21pc2VcbiAgICAgICAgICAuY2F0Y2goQi5Qcm9taXNlLlRpbWVvdXRFcnJvciwgKCkgPT4ge30pXG4gICAgICAgICAgLmNhdGNoKEIuUHJvbWlzZS5DYW5jZWxsYXRpb25FcnJvciwgKCkgPT4ge30pO1xuICAgICAgfVxuXG4gICAgICAvLyByZWN1cnNpb24gZW5kIGNvbmRpdGlvbnNcbiAgICAgIGlmIChlbXVFcnJvcmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRW11bGF0b3IgZXJyb3JlZCcpO1xuICAgICAgfVxuICAgICAgaWYgKERhdGUubm93KCkgLSBzdGFydE1zID4gdGhpcy5vcHRzLm1heFdhaXQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbXVsYXRvciBkaWQgbm90IHNob3cgdXAnKTtcbiAgICAgIH1cblxuICAgICAgLy8gcmV0cmlldmUgZW11bGF0b3Igc3RhdHVzXG4gICAgICBsZXQgc3Rkb3V0O1xuICAgICAgdHJ5IHtcbiAgICAgICAgW3N0ZG91dF0gPSBhd2FpdCB1dGlscy5leGVjKCdhZGIgc2hlbGwgZ2V0cHJvcCBzeXMuYm9vdF9jb21wbGV0ZWQnKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBpZiAoZXJyLnRvU3RyaW5nKCkubWF0Y2goL2RldmljZSBub3QgZm91bmQvKSkge1xuICAgICAgICAgIC8vIHRoZXJlIG1pZ2h0IGJlIHNvbWV0aGluZyB3cm9uZyB3aXRoIHRoZSBhZGIgc2VydmVyXG4gICAgICAgICAgbG9nLndhcm4oJ0RldmljZSBub3QgZm91bmQsIGl0IHNob3VsZCBiZSB0aGVyZSwga2lsbGluZyBhZGIgc2VydmVyLicpO1xuICAgICAgICAgIHJldHVybiB1dGlscy5leGVjKCdhZGIga2lsbC1zZXJ2ZXInKS50aGVuKCgpID0+IHsgcmV0dXJuIF93YWl0Rm9yRW11KCk7IH0pOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLXRoZW5cbiAgICAgICAgfSBlbHNlIGlmIChlcnIudG9TdHJpbmcoKS5tYXRjaCgvZGV2aWNlIG9mZmxpbmUvKSkge1xuICAgICAgICAgIC8vIHRoYXQncyBvayxqdXN0IHdhaXRcbiAgICAgICAgICByZXR1cm4gX3dhaXRGb3JFbXUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyAoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBjaGVjayBlbXVsYXRvciBzdGF0dXNcbiAgICAgIGlmIChzdGRvdXQgJiYgc3Rkb3V0LnRyaW0oKSA9PT0gJzEnKSB7XG4gICAgICAgIGxvZy5pbmZvKCdFbXVsYXRvciBzdGFydGVkJyk7XG4gICAgICAgIGVtdVN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgX3dhaXRGb3JFbXUoKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8gd2FpdCBmb3IgZmlyc3QgcHJvbWlzZVxuICAgIGF3YWl0IEIucmFjZShbX3dhaXRGb3JFbXUodGhpcy5vcHRzLmluaXRXYWl0KSwgcHJvY1Byb21pc2VdKVxuICAgICAgLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgICAvLyBjYW5jZWwgb3V0c3RhbmRpbmcgcHJvbWlzZXMgc28gdGhhdCB0aGV5IGRvIG5vdCBoYW5nIHRoZSBub2RlIHByb2Nlc3NcbiAgICAgICAgdGltZW91dFByb21pc2UuY2FuY2VsKCk7XG4gICAgICAgIHByb2NQcm9taXNlLmNhbmNlbCgpO1xuICAgICAgfSk7XG5cbiAgfVxuXG4gIHN0b3AgKCkge1xuICAgIGlmICh0aGlzLmNoaWxkKSB7XG4gICAgICB0aGlzLmNoaWxkLmtpbGwoKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJmaWxlIjoibGliL2FuZHJvaWQtdG9vbHMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
