"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.server = server;
exports.configureServer = configureServer;
exports.normalizeBasePath = normalizeBasePath;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _serveFavicon = _interopRequireDefault(require("serve-favicon"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var _methodOverride = _interopRequireDefault(require("method-override"));

var _logger = _interopRequireDefault(require("./logger"));

var _expressLogging = require("./express-logging");

var _middleware = require("./middleware");

var _static = require("./static");

var _crash = require("./crash");

var _websocket = require("./websocket");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _protocol = require("../protocol");

async function server(opts = {}) {
  const {
    routeConfiguringFunction,
    port,
    hostname = null,
    allowCors = true,
    basePath = _protocol.DEFAULT_BASE_PATH
  } = opts;
  const app = (0, _express.default)();

  let httpServer = _http.default.createServer(app);

  httpServer.addWebSocketHandler = _websocket.addWebSocketHandler;
  httpServer.removeWebSocketHandler = _websocket.removeWebSocketHandler;
  httpServer.removeAllWebSocketHandlers = _websocket.removeAllWebSocketHandlers;
  httpServer.getWebSocketHandlers = _websocket.getWebSocketHandlers;
  const close = httpServer.close.bind(httpServer);

  httpServer.close = async () => {
    return await new _bluebird.default((resolve, reject) => {
      httpServer.on('close', resolve);
      close(err => {
        if (err) reject(err);
      });
    });
  };

  return await new _bluebird.default((resolve, reject) => {
    httpServer.on('error', err => {
      if (err.code === 'EADDRNOTAVAIL') {
        _logger.default.error('Could not start REST http interface listener. ' + 'Requested address is not available.');
      } else {
        _logger.default.error('Could not start REST http interface listener. The requested ' + 'port may already be in use. Please make sure there is no ' + 'other instance of this server running already.');
      }

      reject(err);
    });
    httpServer.on('connection', socket => {
      socket.setTimeout(600 * 1000);
      socket.on('error', reject);
    });
    configureServer(app, routeConfiguringFunction, allowCors, basePath);
    let serverArgs = [port];

    if (hostname) {
      serverArgs.push(hostname);
    }

    httpServer.listen(...serverArgs, err => {
      if (err) {
        reject(err);
      }

      resolve(httpServer);
    });
  });
}

function normalizeBasePath(basePath) {
  if (!_lodash.default.isString(basePath)) {
    throw new Error(`Invalid path prefix ${basePath}`);
  }

  basePath = basePath.replace(/\/$/, '');

  if (basePath !== '' && basePath[0] !== '/') {
    basePath = `/${basePath}`;
  }

  return basePath;
}

function configureServer(app, routeConfiguringFunction, allowCors = true, basePath = _protocol.DEFAULT_BASE_PATH) {
  basePath = normalizeBasePath(basePath);
  app.use(_expressLogging.endLogFormatter);
  app.use((0, _serveFavicon.default)(_path.default.resolve(_static.STATIC_DIR, 'favicon.ico')));
  app.use(_express.default.static(_static.STATIC_DIR));
  app.use(`${basePath}/produce_error`, _crash.produceError);
  app.use(`${basePath}/crash`, _crash.produceCrash);

  if (allowCors) {
    app.use(_middleware.allowCrossDomain);
  } else {
    app.use((0, _middleware.allowCrossDomainAsyncExecute)(basePath));
  }

  app.use((0, _middleware.fixPythonContentType)(basePath));
  app.use(_middleware.defaultToJSONContentType);
  app.use(_bodyParser.default.urlencoded({
    extended: true
  }));
  app.use((0, _methodOverride.default)());
  app.use(_middleware.catch4XXHandler);
  app.use(_middleware.catchAllHandler);
  app.use(_bodyParser.default.json({
    limit: '1gb'
  }));
  app.use(_expressLogging.startLogFormatter);
  routeConfiguringFunction(app, basePath);
  app.all('/welcome', _static.welcome);
  app.all('/test/guinea-pig', _static.guineaPig);
  app.all('/test/guinea-pig-scrollable', _static.guineaPigScrollable);
  app.all('/test/guinea-pig-app-banner', _static.guineaPigAppBanner);
  app.use(_middleware.catch404Handler);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leHByZXNzL3NlcnZlci5qcyJdLCJuYW1lcyI6WyJzZXJ2ZXIiLCJvcHRzIiwicm91dGVDb25maWd1cmluZ0Z1bmN0aW9uIiwicG9ydCIsImhvc3RuYW1lIiwiYWxsb3dDb3JzIiwiYmFzZVBhdGgiLCJERUZBVUxUX0JBU0VfUEFUSCIsImFwcCIsImh0dHBTZXJ2ZXIiLCJodHRwIiwiY3JlYXRlU2VydmVyIiwiYWRkV2ViU29ja2V0SGFuZGxlciIsInJlbW92ZVdlYlNvY2tldEhhbmRsZXIiLCJyZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyIsImdldFdlYlNvY2tldEhhbmRsZXJzIiwiY2xvc2UiLCJiaW5kIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJvbiIsImVyciIsImNvZGUiLCJsb2ciLCJlcnJvciIsInNvY2tldCIsInNldFRpbWVvdXQiLCJjb25maWd1cmVTZXJ2ZXIiLCJzZXJ2ZXJBcmdzIiwicHVzaCIsImxpc3RlbiIsIm5vcm1hbGl6ZUJhc2VQYXRoIiwiXyIsImlzU3RyaW5nIiwiRXJyb3IiLCJyZXBsYWNlIiwidXNlIiwiZW5kTG9nRm9ybWF0dGVyIiwicGF0aCIsIlNUQVRJQ19ESVIiLCJleHByZXNzIiwic3RhdGljIiwicHJvZHVjZUVycm9yIiwicHJvZHVjZUNyYXNoIiwiYWxsb3dDcm9zc0RvbWFpbiIsImRlZmF1bHRUb0pTT05Db250ZW50VHlwZSIsImJvZHlQYXJzZXIiLCJ1cmxlbmNvZGVkIiwiZXh0ZW5kZWQiLCJjYXRjaDRYWEhhbmRsZXIiLCJjYXRjaEFsbEhhbmRsZXIiLCJqc29uIiwibGltaXQiLCJzdGFydExvZ0Zvcm1hdHRlciIsImFsbCIsIndlbGNvbWUiLCJndWluZWFQaWciLCJndWluZWFQaWdTY3JvbGxhYmxlIiwiZ3VpbmVhUGlnQXBwQmFubmVyIiwiY2F0Y2g0MDRIYW5kbGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBR0EsZUFBZUEsTUFBZixDQUF1QkMsSUFBSSxHQUFHLEVBQTlCLEVBQWtDO0FBQ2hDLFFBQU07QUFDSkMsSUFBQUEsd0JBREk7QUFFSkMsSUFBQUEsSUFGSTtBQUdKQyxJQUFBQSxRQUFRLEdBQUcsSUFIUDtBQUlKQyxJQUFBQSxTQUFTLEdBQUcsSUFKUjtBQUtKQyxJQUFBQSxRQUFRLEdBQUdDO0FBTFAsTUFNRk4sSUFOSjtBQVNBLFFBQU1PLEdBQUcsR0FBRyx1QkFBWjs7QUFDQSxNQUFJQyxVQUFVLEdBQUdDLGNBQUtDLFlBQUwsQ0FBa0JILEdBQWxCLENBQWpCOztBQUNBQyxFQUFBQSxVQUFVLENBQUNHLG1CQUFYLEdBQWlDQSw4QkFBakM7QUFDQUgsRUFBQUEsVUFBVSxDQUFDSSxzQkFBWCxHQUFvQ0EsaUNBQXBDO0FBQ0FKLEVBQUFBLFVBQVUsQ0FBQ0ssMEJBQVgsR0FBd0NBLHFDQUF4QztBQUNBTCxFQUFBQSxVQUFVLENBQUNNLG9CQUFYLEdBQWtDQSwrQkFBbEM7QUFJQSxRQUFNQyxLQUFLLEdBQUdQLFVBQVUsQ0FBQ08sS0FBWCxDQUFpQkMsSUFBakIsQ0FBc0JSLFVBQXRCLENBQWQ7O0FBQ0FBLEVBQUFBLFVBQVUsQ0FBQ08sS0FBWCxHQUFtQixZQUFZO0FBQzdCLFdBQU8sTUFBTSxJQUFJRSxpQkFBSixDQUFNLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUN0Q1gsTUFBQUEsVUFBVSxDQUFDWSxFQUFYLENBQWMsT0FBZCxFQUF1QkYsT0FBdkI7QUFDQUgsTUFBQUEsS0FBSyxDQUFFTSxHQUFELElBQVM7QUFDYixZQUFJQSxHQUFKLEVBQVNGLE1BQU0sQ0FBQ0UsR0FBRCxDQUFOO0FBQ1YsT0FGSSxDQUFMO0FBR0QsS0FMWSxDQUFiO0FBTUQsR0FQRDs7QUFTQSxTQUFPLE1BQU0sSUFBSUosaUJBQUosQ0FBTSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDdENYLElBQUFBLFVBQVUsQ0FBQ1ksRUFBWCxDQUFjLE9BQWQsRUFBd0JDLEdBQUQsSUFBUztBQUM5QixVQUFJQSxHQUFHLENBQUNDLElBQUosS0FBYSxlQUFqQixFQUFrQztBQUNoQ0Msd0JBQUlDLEtBQUosQ0FBVSxtREFDQSxxQ0FEVjtBQUVELE9BSEQsTUFHTztBQUNMRCx3QkFBSUMsS0FBSixDQUFVLGlFQUNBLDJEQURBLEdBRUEsZ0RBRlY7QUFHRDs7QUFDREwsTUFBQUEsTUFBTSxDQUFDRSxHQUFELENBQU47QUFDRCxLQVZEO0FBV0FiLElBQUFBLFVBQVUsQ0FBQ1ksRUFBWCxDQUFjLFlBQWQsRUFBNkJLLE1BQUQsSUFBWTtBQUN0Q0EsTUFBQUEsTUFBTSxDQUFDQyxVQUFQLENBQWtCLE1BQU0sSUFBeEI7QUFDQUQsTUFBQUEsTUFBTSxDQUFDTCxFQUFQLENBQVUsT0FBVixFQUFtQkQsTUFBbkI7QUFDRCxLQUhEO0FBSUFRLElBQUFBLGVBQWUsQ0FBQ3BCLEdBQUQsRUFBTU4sd0JBQU4sRUFBZ0NHLFNBQWhDLEVBQTJDQyxRQUEzQyxDQUFmO0FBRUEsUUFBSXVCLFVBQVUsR0FBRyxDQUFDMUIsSUFBRCxDQUFqQjs7QUFDQSxRQUFJQyxRQUFKLEVBQWM7QUFHWnlCLE1BQUFBLFVBQVUsQ0FBQ0MsSUFBWCxDQUFnQjFCLFFBQWhCO0FBQ0Q7O0FBQ0RLLElBQUFBLFVBQVUsQ0FBQ3NCLE1BQVgsQ0FBa0IsR0FBR0YsVUFBckIsRUFBa0NQLEdBQUQsSUFBUztBQUN4QyxVQUFJQSxHQUFKLEVBQVM7QUFDUEYsUUFBQUEsTUFBTSxDQUFDRSxHQUFELENBQU47QUFDRDs7QUFDREgsTUFBQUEsT0FBTyxDQUFDVixVQUFELENBQVA7QUFDRCxLQUxEO0FBTUQsR0E5QlksQ0FBYjtBQStCRDs7QUFFRCxTQUFTdUIsaUJBQVQsQ0FBNEIxQixRQUE1QixFQUFzQztBQUNwQyxNQUFJLENBQUMyQixnQkFBRUMsUUFBRixDQUFXNUIsUUFBWCxDQUFMLEVBQTJCO0FBQ3pCLFVBQU0sSUFBSTZCLEtBQUosQ0FBVyx1QkFBc0I3QixRQUFTLEVBQTFDLENBQU47QUFDRDs7QUFJREEsRUFBQUEsUUFBUSxHQUFHQSxRQUFRLENBQUM4QixPQUFULENBQWlCLEtBQWpCLEVBQXdCLEVBQXhCLENBQVg7O0FBSUEsTUFBSTlCLFFBQVEsS0FBSyxFQUFiLElBQW1CQSxRQUFRLENBQUMsQ0FBRCxDQUFSLEtBQWdCLEdBQXZDLEVBQTRDO0FBQzFDQSxJQUFBQSxRQUFRLEdBQUksSUFBR0EsUUFBUyxFQUF4QjtBQUNEOztBQUVELFNBQU9BLFFBQVA7QUFDRDs7QUFFRCxTQUFTc0IsZUFBVCxDQUEwQnBCLEdBQTFCLEVBQStCTix3QkFBL0IsRUFBeURHLFNBQVMsR0FBRyxJQUFyRSxFQUEyRUMsUUFBUSxHQUFHQywyQkFBdEYsRUFBeUc7QUFDdkdELEVBQUFBLFFBQVEsR0FBRzBCLGlCQUFpQixDQUFDMUIsUUFBRCxDQUE1QjtBQUVBRSxFQUFBQSxHQUFHLENBQUM2QixHQUFKLENBQVFDLCtCQUFSO0FBR0E5QixFQUFBQSxHQUFHLENBQUM2QixHQUFKLENBQVEsMkJBQVFFLGNBQUtwQixPQUFMLENBQWFxQixrQkFBYixFQUF5QixhQUF6QixDQUFSLENBQVI7QUFDQWhDLEVBQUFBLEdBQUcsQ0FBQzZCLEdBQUosQ0FBUUksaUJBQVFDLE1BQVIsQ0FBZUYsa0JBQWYsQ0FBUjtBQUdBaEMsRUFBQUEsR0FBRyxDQUFDNkIsR0FBSixDQUFTLEdBQUUvQixRQUFTLGdCQUFwQixFQUFxQ3FDLG1CQUFyQztBQUNBbkMsRUFBQUEsR0FBRyxDQUFDNkIsR0FBSixDQUFTLEdBQUUvQixRQUFTLFFBQXBCLEVBQTZCc0MsbUJBQTdCOztBQUdBLE1BQUl2QyxTQUFKLEVBQWU7QUFDYkcsSUFBQUEsR0FBRyxDQUFDNkIsR0FBSixDQUFRUSw0QkFBUjtBQUNELEdBRkQsTUFFTztBQUNMckMsSUFBQUEsR0FBRyxDQUFDNkIsR0FBSixDQUFRLDhDQUE2Qi9CLFFBQTdCLENBQVI7QUFDRDs7QUFDREUsRUFBQUEsR0FBRyxDQUFDNkIsR0FBSixDQUFRLHNDQUFxQi9CLFFBQXJCLENBQVI7QUFDQUUsRUFBQUEsR0FBRyxDQUFDNkIsR0FBSixDQUFRUyxvQ0FBUjtBQUNBdEMsRUFBQUEsR0FBRyxDQUFDNkIsR0FBSixDQUFRVSxvQkFBV0MsVUFBWCxDQUFzQjtBQUFDQyxJQUFBQSxRQUFRLEVBQUU7QUFBWCxHQUF0QixDQUFSO0FBQ0F6QyxFQUFBQSxHQUFHLENBQUM2QixHQUFKLENBQVEsOEJBQVI7QUFDQTdCLEVBQUFBLEdBQUcsQ0FBQzZCLEdBQUosQ0FBUWEsMkJBQVI7QUFDQTFDLEVBQUFBLEdBQUcsQ0FBQzZCLEdBQUosQ0FBUWMsMkJBQVI7QUFHQTNDLEVBQUFBLEdBQUcsQ0FBQzZCLEdBQUosQ0FBUVUsb0JBQVdLLElBQVgsQ0FBZ0I7QUFBQ0MsSUFBQUEsS0FBSyxFQUFFO0FBQVIsR0FBaEIsQ0FBUjtBQUdBN0MsRUFBQUEsR0FBRyxDQUFDNkIsR0FBSixDQUFRaUIsaUNBQVI7QUFFQXBELEVBQUFBLHdCQUF3QixDQUFDTSxHQUFELEVBQU1GLFFBQU4sQ0FBeEI7QUFHQUUsRUFBQUEsR0FBRyxDQUFDK0MsR0FBSixDQUFRLFVBQVIsRUFBb0JDLGVBQXBCO0FBQ0FoRCxFQUFBQSxHQUFHLENBQUMrQyxHQUFKLENBQVEsa0JBQVIsRUFBNEJFLGlCQUE1QjtBQUNBakQsRUFBQUEsR0FBRyxDQUFDK0MsR0FBSixDQUFRLDZCQUFSLEVBQXVDRywyQkFBdkM7QUFDQWxELEVBQUFBLEdBQUcsQ0FBQytDLEdBQUosQ0FBUSw2QkFBUixFQUF1Q0ksMEJBQXZDO0FBR0FuRCxFQUFBQSxHQUFHLENBQUM2QixHQUFKLENBQVF1QiwyQkFBUjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBmYXZpY29uIGZyb20gJ3NlcnZlLWZhdmljb24nO1xuaW1wb3J0IGJvZHlQYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInO1xuaW1wb3J0IG1ldGhvZE92ZXJyaWRlIGZyb20gJ21ldGhvZC1vdmVycmlkZSc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHN0YXJ0TG9nRm9ybWF0dGVyLCBlbmRMb2dGb3JtYXR0ZXIgfSBmcm9tICcuL2V4cHJlc3MtbG9nZ2luZyc7XG5pbXBvcnQgeyBhbGxvd0Nyb3NzRG9tYWluLCBmaXhQeXRob25Db250ZW50VHlwZSwgZGVmYXVsdFRvSlNPTkNvbnRlbnRUeXBlLFxuICAgICAgICAgY2F0Y2hBbGxIYW5kbGVyLCBjYXRjaDQwNEhhbmRsZXIsIGNhdGNoNFhYSGFuZGxlcixcbiAgICAgICAgIGFsbG93Q3Jvc3NEb21haW5Bc3luY0V4ZWN1dGV9IGZyb20gJy4vbWlkZGxld2FyZSc7XG5pbXBvcnQgeyBndWluZWFQaWcsIGd1aW5lYVBpZ1Njcm9sbGFibGUsIGd1aW5lYVBpZ0FwcEJhbm5lciwgd2VsY29tZSwgU1RBVElDX0RJUiB9IGZyb20gJy4vc3RhdGljJztcbmltcG9ydCB7IHByb2R1Y2VFcnJvciwgcHJvZHVjZUNyYXNoIH0gZnJvbSAnLi9jcmFzaCc7XG5pbXBvcnQgeyBhZGRXZWJTb2NrZXRIYW5kbGVyLCByZW1vdmVXZWJTb2NrZXRIYW5kbGVyLCByZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyxcbiAgICAgICAgIGdldFdlYlNvY2tldEhhbmRsZXJzIH0gZnJvbSAnLi93ZWJzb2NrZXQnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgREVGQVVMVF9CQVNFX1BBVEggfSBmcm9tICcuLi9wcm90b2NvbCc7XG5cblxuYXN5bmMgZnVuY3Rpb24gc2VydmVyIChvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbixcbiAgICBwb3J0LFxuICAgIGhvc3RuYW1lID0gbnVsbCxcbiAgICBhbGxvd0NvcnMgPSB0cnVlLFxuICAgIGJhc2VQYXRoID0gREVGQVVMVF9CQVNFX1BBVEgsXG4gIH0gPSBvcHRzO1xuXG4gIC8vIGNyZWF0ZSB0aGUgYWN0dWFsIGh0dHAgc2VydmVyXG4gIGNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcbiAgbGV0IGh0dHBTZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApO1xuICBodHRwU2VydmVyLmFkZFdlYlNvY2tldEhhbmRsZXIgPSBhZGRXZWJTb2NrZXRIYW5kbGVyO1xuICBodHRwU2VydmVyLnJlbW92ZVdlYlNvY2tldEhhbmRsZXIgPSByZW1vdmVXZWJTb2NrZXRIYW5kbGVyO1xuICBodHRwU2VydmVyLnJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzID0gcmVtb3ZlQWxsV2ViU29ja2V0SGFuZGxlcnM7XG4gIGh0dHBTZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMgPSBnZXRXZWJTb2NrZXRIYW5kbGVycztcblxuICAvLyBodHRwLlNlcnZlci5jbG9zZSgpIG9ubHkgc3RvcHMgbmV3IGNvbm5lY3Rpb25zLCBidXQgd2UgbmVlZCB0byB3YWl0IHVudGlsXG4gIC8vIGFsbCBjb25uZWN0aW9ucyBhcmUgY2xvc2VkIGFuZCB0aGUgYGNsb3NlYCBldmVudCBpcyBlbWl0dGVkXG4gIGNvbnN0IGNsb3NlID0gaHR0cFNlcnZlci5jbG9zZS5iaW5kKGh0dHBTZXJ2ZXIpO1xuICBodHRwU2VydmVyLmNsb3NlID0gYXN5bmMgKCkgPT4ge1xuICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBodHRwU2VydmVyLm9uKCdjbG9zZScsIHJlc29sdmUpO1xuICAgICAgY2xvc2UoKGVycikgPT4ge1xuICAgICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH07XG5cbiAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBodHRwU2VydmVyLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgIGlmIChlcnIuY29kZSA9PT0gJ0VBRERSTk9UQVZBSUwnKSB7XG4gICAgICAgIGxvZy5lcnJvcignQ291bGQgbm90IHN0YXJ0IFJFU1QgaHR0cCBpbnRlcmZhY2UgbGlzdGVuZXIuICcgK1xuICAgICAgICAgICAgICAgICAgJ1JlcXVlc3RlZCBhZGRyZXNzIGlzIG5vdCBhdmFpbGFibGUuJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZXJyb3IoJ0NvdWxkIG5vdCBzdGFydCBSRVNUIGh0dHAgaW50ZXJmYWNlIGxpc3RlbmVyLiBUaGUgcmVxdWVzdGVkICcgK1xuICAgICAgICAgICAgICAgICAgJ3BvcnQgbWF5IGFscmVhZHkgYmUgaW4gdXNlLiBQbGVhc2UgbWFrZSBzdXJlIHRoZXJlIGlzIG5vICcgK1xuICAgICAgICAgICAgICAgICAgJ290aGVyIGluc3RhbmNlIG9mIHRoaXMgc2VydmVyIHJ1bm5pbmcgYWxyZWFkeS4nKTtcbiAgICAgIH1cbiAgICAgIHJlamVjdChlcnIpO1xuICAgIH0pO1xuICAgIGh0dHBTZXJ2ZXIub24oJ2Nvbm5lY3Rpb24nLCAoc29ja2V0KSA9PiB7XG4gICAgICBzb2NrZXQuc2V0VGltZW91dCg2MDAgKiAxMDAwKTsgLy8gMTAgbWludXRlIHRpbWVvdXRcbiAgICAgIHNvY2tldC5vbignZXJyb3InLCByZWplY3QpO1xuICAgIH0pO1xuICAgIGNvbmZpZ3VyZVNlcnZlcihhcHAsIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbiwgYWxsb3dDb3JzLCBiYXNlUGF0aCk7XG5cbiAgICBsZXQgc2VydmVyQXJncyA9IFtwb3J0XTtcbiAgICBpZiAoaG9zdG5hbWUpIHtcbiAgICAgIC8vIElmIHRoZSBob3N0bmFtZSBpcyBvbWl0dGVkLCB0aGUgc2VydmVyIHdpbGwgYWNjZXB0XG4gICAgICAvLyBjb25uZWN0aW9ucyBvbiBhbnkgSVAgYWRkcmVzc1xuICAgICAgc2VydmVyQXJncy5wdXNoKGhvc3RuYW1lKTtcbiAgICB9XG4gICAgaHR0cFNlcnZlci5saXN0ZW4oLi4uc2VydmVyQXJncywgKGVycikgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICAgIHJlc29sdmUoaHR0cFNlcnZlcik7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVCYXNlUGF0aCAoYmFzZVBhdGgpIHtcbiAgaWYgKCFfLmlzU3RyaW5nKGJhc2VQYXRoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwYXRoIHByZWZpeCAke2Jhc2VQYXRofWApO1xuICB9XG5cbiAgLy8gZW5zdXJlIHRoZSBwYXRoIHByZWZpeCBkb2VzIG5vdCBlbmQgaW4gJy8nLCBzaW5jZSBvdXIgbWV0aG9kIG1hcFxuICAvLyBzdGFydHMgYWxsIHBhdGhzIHdpdGggJy8nXG4gIGJhc2VQYXRoID0gYmFzZVBhdGgucmVwbGFjZSgvXFwvJC8sICcnKTtcblxuICAvLyBsaWtld2lzZSwgZW5zdXJlIHRoZSBwYXRoIHByZWZpeCBkb2VzIGFsd2F5cyBTVEFSVCB3aXRoIC8sIHVubGVzcyB0aGUgcGF0aFxuICAvLyBpcyBlbXB0eSBtZWFuaW5nIG5vIGJhc2UgcGF0aCBhdCBhbGxcbiAgaWYgKGJhc2VQYXRoICE9PSAnJyAmJiBiYXNlUGF0aFswXSAhPT0gJy8nKSB7XG4gICAgYmFzZVBhdGggPSBgLyR7YmFzZVBhdGh9YDtcbiAgfVxuXG4gIHJldHVybiBiYXNlUGF0aDtcbn1cblxuZnVuY3Rpb24gY29uZmlndXJlU2VydmVyIChhcHAsIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbiwgYWxsb3dDb3JzID0gdHJ1ZSwgYmFzZVBhdGggPSBERUZBVUxUX0JBU0VfUEFUSCkge1xuICBiYXNlUGF0aCA9IG5vcm1hbGl6ZUJhc2VQYXRoKGJhc2VQYXRoKTtcblxuICBhcHAudXNlKGVuZExvZ0Zvcm1hdHRlcik7XG5cbiAgLy8gc2V0IHVwIHN0YXRpYyBhc3NldHNcbiAgYXBwLnVzZShmYXZpY29uKHBhdGgucmVzb2x2ZShTVEFUSUNfRElSLCAnZmF2aWNvbi5pY28nKSkpO1xuICBhcHAudXNlKGV4cHJlc3Muc3RhdGljKFNUQVRJQ19ESVIpKTtcblxuICAvLyBjcmFzaCByb3V0ZXMsIGZvciB0ZXN0aW5nXG4gIGFwcC51c2UoYCR7YmFzZVBhdGh9L3Byb2R1Y2VfZXJyb3JgLCBwcm9kdWNlRXJyb3IpO1xuICBhcHAudXNlKGAke2Jhc2VQYXRofS9jcmFzaGAsIHByb2R1Y2VDcmFzaCk7XG5cbiAgLy8gYWRkIG1pZGRsZXdhcmVzXG4gIGlmIChhbGxvd0NvcnMpIHtcbiAgICBhcHAudXNlKGFsbG93Q3Jvc3NEb21haW4pO1xuICB9IGVsc2Uge1xuICAgIGFwcC51c2UoYWxsb3dDcm9zc0RvbWFpbkFzeW5jRXhlY3V0ZShiYXNlUGF0aCkpO1xuICB9XG4gIGFwcC51c2UoZml4UHl0aG9uQ29udGVudFR5cGUoYmFzZVBhdGgpKTtcbiAgYXBwLnVzZShkZWZhdWx0VG9KU09OQ29udGVudFR5cGUpO1xuICBhcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7ZXh0ZW5kZWQ6IHRydWV9KSk7XG4gIGFwcC51c2UobWV0aG9kT3ZlcnJpZGUoKSk7XG4gIGFwcC51c2UoY2F0Y2g0WFhIYW5kbGVyKTtcbiAgYXBwLnVzZShjYXRjaEFsbEhhbmRsZXIpO1xuXG4gIC8vIG1ha2Ugc3VyZSBhcHBpdW0gbmV2ZXIgZmFpbHMgYmVjYXVzZSBvZiBhIGZpbGUgc2l6ZSB1cGxvYWQgbGltaXRcbiAgYXBwLnVzZShib2R5UGFyc2VyLmpzb24oe2xpbWl0OiAnMWdiJ30pKTtcblxuICAvLyBzZXQgdXAgc3RhcnQgbG9nZ2luZyAod2hpY2ggZGVwZW5kcyBvbiBib2R5UGFyc2VyIGRvaW5nIGl0cyB0aGluZylcbiAgYXBwLnVzZShzdGFydExvZ0Zvcm1hdHRlcik7XG5cbiAgcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uKGFwcCwgYmFzZVBhdGgpO1xuXG4gIC8vIGR5bmFtaWMgcm91dGVzIGZvciB0ZXN0aW5nLCBldGMuXG4gIGFwcC5hbGwoJy93ZWxjb21lJywgd2VsY29tZSk7XG4gIGFwcC5hbGwoJy90ZXN0L2d1aW5lYS1waWcnLCBndWluZWFQaWcpO1xuICBhcHAuYWxsKCcvdGVzdC9ndWluZWEtcGlnLXNjcm9sbGFibGUnLCBndWluZWFQaWdTY3JvbGxhYmxlKTtcbiAgYXBwLmFsbCgnL3Rlc3QvZ3VpbmVhLXBpZy1hcHAtYmFubmVyJywgZ3VpbmVhUGlnQXBwQmFubmVyKTtcblxuICAvLyBjYXRjaCB0aGlzIGxhc3QsIHNvIGFueXRoaW5nIHRoYXQgZmFsbHMgdGhyb3VnaCBpcyA0MDRlZFxuICBhcHAudXNlKGNhdGNoNDA0SGFuZGxlcik7XG59XG5cbmV4cG9ydCB7IHNlcnZlciwgY29uZmlndXJlU2VydmVyLCBub3JtYWxpemVCYXNlUGF0aCB9O1xuIl0sImZpbGUiOiJsaWIvZXhwcmVzcy9zZXJ2ZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
