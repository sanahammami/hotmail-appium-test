"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.DEFAULT_WAD_PORT = exports.DEFAULT_WAD_HOST = exports.WinAppDriver = void 0;

require("source-map-support/register");

var _events = _interopRequireDefault(require("events"));

var _appiumBaseDriver = require("appium-base-driver");

var _logger = _interopRequireDefault(require("./logger"));

var _teen_process = require("teen_process");

var _installer = require("./installer");

var _asyncbox = require("asyncbox");

var _child_process = _interopRequireDefault(require("child_process"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const REQUIRED_PARAMS = [];
const DEFAULT_WAD_HOST = '127.0.0.1';
exports.DEFAULT_WAD_HOST = DEFAULT_WAD_HOST;
const DEFAULT_WAD_PORT = 4724;
exports.DEFAULT_WAD_PORT = DEFAULT_WAD_PORT;

class WinAppDriver extends _events.default.EventEmitter {
  constructor(opts = {}) {
    const {
      host,
      port
    } = opts;
    super();

    for (let req of REQUIRED_PARAMS) {
      if (!opts || !opts[req]) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.proxyHost = host || DEFAULT_WAD_HOST;
    this.proxyPort = port || DEFAULT_WAD_PORT;
    this.proc = null;
    this.state = WinAppDriver.STATE_STOPPED;
    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.proxyHost,
      port: this.proxyPort
    });
  }

  async start() {
    if (!(await (0, _installer.verifyWAD)())) {
      throw new Error('Could not verify WinAppDriver install; re-run install');
    }

    this.changeState(WinAppDriver.STATE_STARTING);
    let args = [this.proxyPort + '/wd/hub'];

    const startDetector = stdout => {
      return stdout.indexOf('listening for requests') !== -1;
    };

    let processIsAlive = false;

    try {
      await this.killAll();
      this.proc = new _teen_process.SubProcess(_installer.WAD_INSTALL_PATH, args, {
        encoding: 'ucs2'
      });
      processIsAlive = true;

      for (let stream of ['STDOUT', 'STDERR']) {
        this.proc.on(`lines-${stream.toLowerCase()}`, lines => {
          for (let l of lines) {
            _logger.default.info(`[${stream}] ${l.trim()}`);
          }
        });
      }

      this.proc.on('exit', (code, signal) => {
        processIsAlive = false;

        if (this.state !== WinAppDriver.STATE_STOPPED && this.state !== WinAppDriver.STATE_STOPPING) {
          let msg = `WinAppDriver exited unexpectedly with code ${code}, ` + `signal ${signal}`;

          _logger.default.error(msg);

          this.changeState(WinAppDriver.STATE_STOPPED);
        }
      });

      _logger.default.info(`Spawning winappdriver with: ${args.join(' ')}`);

      await this.proc.start(startDetector);
      await this.waitForOnline();
    } catch (e) {
      this.emit(WinAppDriver.EVENT_ERROR, e);

      if (processIsAlive) {
        await this.proc.stop();
      }

      _logger.default.errorAndThrow(e);
    }
  }

  sessionId() {
    if (this.state !== WinAppDriver.STATE_ONLINE) {
      return null;
    }

    return this.jwproxy.sessionId;
  }

  async waitForOnline() {
    let winappdriverStopped = false;
    await (0, _asyncbox.retryInterval)(20, 200, async () => {
      if ([WinAppDriver.STATE_STOPPED, WinAppDriver.STATE_ONLINE].indexOf(this.state) >= 0) {
        winappdriverStopped = this.state === WinAppDriver.STATE_STOPPED;
        return;
      }

      if (await this.getStatus()) {
        this.changeState(WinAppDriver.STATE_ONLINE);
      }
    });

    if (winappdriverStopped) {
      throw new Error('WinAppDriver crashed during startup.');
    }
  }

  async getStatus() {
    const resBlock = await this.jwproxy.proxy('/status', 'GET');

    if (resBlock[0].statusCode === 200) {
      _logger.default.info(`Status call returned 200. we're online and ready to run tests`);

      return true;
    }

    return false;
  }

  async startSession(caps) {
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    await this.jwproxy.command('/session', 'POST', {
      desiredCapabilities: caps
    });
  }

  async stop(emitStates = true) {
    if (emitStates) {
      this.changeState(WinAppDriver.STATE_STOPPING);
    }

    try {
      if (this.proc) {
        await this.proc.stop();
      }

      if (emitStates) {
        this.changeState(WinAppDriver.STATE_STOPPED);
      }
    } catch (e) {
      _logger.default.error(e);
    }
  }

  changeState(state) {
    this.state = state;

    _logger.default.debug(`WinAppDriver changed state to '${state}'`);

    this.emit(WinAppDriver.EVENT_CHANGED, {
      state
    });
  }

  async sendCommand(url, method, body) {
    return await this.jwproxy.command(url, method, body);
  }

  async proxyReq(req, res) {
    return await this.jwproxy.proxyReqRes(req, res);
  }

  async killAll() {
    let cmd;
    cmd = 'FOR /F "usebackq tokens=5" %a in (`netstat -nao ^| ' + 'findstr /R /C:"' + this.proxyPort + ' "`) do (' + 'FOR /F "usebackq" %b in (`TASKLIST /FI "PID eq %a" ^| ' + 'findstr /I winappdriver.exe`) do (IF NOT %b=="" TASKKILL ' + '/F /PID %a))';

    _logger.default.info(`Killing any old WinAppDrivers on same port, running: ${cmd}`);

    try {
      await _bluebird.default.promisify(_child_process.default.exec)(cmd);

      _logger.default.info('Successfully cleaned up old WinAppDrivers');
    } catch (err) {
      _logger.default.info('No old WinAppDrivers seemed to exist');
    }
  }

  async deleteSession() {
    _logger.default.debug('Deleting WinAppDriver server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation WinAppDriver deleteSession worked; ` + `Error was: ${err}`);
    }
  }

}

exports.WinAppDriver = WinAppDriver;
WinAppDriver.EVENT_ERROR = 'winappdriver_error';
WinAppDriver.EVENT_CHANGED = 'stateChanged';
WinAppDriver.STATE_STOPPED = 'stopped';
WinAppDriver.STATE_STARTING = 'starting';
WinAppDriver.STATE_ONLINE = 'online';
WinAppDriver.STATE_STOPPING = 'stopping';
var _default = WinAppDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93aW5hcHBkcml2ZXIuanMiXSwibmFtZXMiOlsiUkVRVUlSRURfUEFSQU1TIiwiREVGQVVMVF9XQURfSE9TVCIsIkRFRkFVTFRfV0FEX1BPUlQiLCJXaW5BcHBEcml2ZXIiLCJldmVudHMiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJob3N0IiwicG9ydCIsInJlcSIsIkVycm9yIiwicHJveHlIb3N0IiwicHJveHlQb3J0IiwicHJvYyIsInN0YXRlIiwiU1RBVEVfU1RPUFBFRCIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwic3RhcnQiLCJjaGFuZ2VTdGF0ZSIsIlNUQVRFX1NUQVJUSU5HIiwiYXJncyIsInN0YXJ0RGV0ZWN0b3IiLCJzdGRvdXQiLCJpbmRleE9mIiwicHJvY2Vzc0lzQWxpdmUiLCJraWxsQWxsIiwiU3ViUHJvY2VzcyIsIldBRF9JTlNUQUxMX1BBVEgiLCJlbmNvZGluZyIsInN0cmVhbSIsIm9uIiwidG9Mb3dlckNhc2UiLCJsaW5lcyIsImwiLCJsb2ciLCJpbmZvIiwidHJpbSIsImNvZGUiLCJzaWduYWwiLCJTVEFURV9TVE9QUElORyIsIm1zZyIsImVycm9yIiwiam9pbiIsIndhaXRGb3JPbmxpbmUiLCJlIiwiZW1pdCIsIkVWRU5UX0VSUk9SIiwic3RvcCIsImVycm9yQW5kVGhyb3ciLCJzZXNzaW9uSWQiLCJTVEFURV9PTkxJTkUiLCJ3aW5hcHBkcml2ZXJTdG9wcGVkIiwiZ2V0U3RhdHVzIiwicmVzQmxvY2siLCJwcm94eSIsInN0YXR1c0NvZGUiLCJzdGFydFNlc3Npb24iLCJjYXBzIiwicHJveHlSZXFSZXMiLCJiaW5kIiwiY29tbWFuZCIsImRlc2lyZWRDYXBhYmlsaXRpZXMiLCJlbWl0U3RhdGVzIiwiZGVidWciLCJFVkVOVF9DSEFOR0VEIiwic2VuZENvbW1hbmQiLCJ1cmwiLCJtZXRob2QiLCJib2R5IiwicHJveHlSZXEiLCJyZXMiLCJjbWQiLCJCIiwicHJvbWlzaWZ5IiwiY3AiLCJleGVjIiwiZXJyIiwiZGVsZXRlU2Vzc2lvbiIsIndhcm4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsZUFBZSxHQUFHLEVBQXhCO0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsV0FBekI7O0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsSUFBekI7OztBQUVBLE1BQU1DLFlBQU4sU0FBMkJDLGdCQUFPQyxZQUFsQyxDQUErQztBQUM3Q0MsRUFBQUEsV0FBVyxDQUFFQyxJQUFJLEdBQUcsRUFBVCxFQUFhO0FBQ3RCLFVBQU07QUFBQ0MsTUFBQUEsSUFBRDtBQUFPQyxNQUFBQTtBQUFQLFFBQWVGLElBQXJCO0FBQ0E7O0FBRUEsU0FBSyxJQUFJRyxHQUFULElBQWdCVixlQUFoQixFQUFpQztBQUMvQixVQUFJLENBQUNPLElBQUQsSUFBUyxDQUFDQSxJQUFJLENBQUNHLEdBQUQsQ0FBbEIsRUFBeUI7QUFDdkIsY0FBTSxJQUFJQyxLQUFKLENBQVcsV0FBVUQsR0FBSSxnQkFBekIsQ0FBTjtBQUNEOztBQUNELFdBQUtBLEdBQUwsSUFBWUgsSUFBSSxDQUFDRyxHQUFELENBQWhCO0FBQ0Q7O0FBRUQsU0FBS0UsU0FBTCxHQUFpQkosSUFBSSxJQUFJUCxnQkFBekI7QUFDQSxTQUFLWSxTQUFMLEdBQWlCSixJQUFJLElBQUlQLGdCQUF6QjtBQUNBLFNBQUtZLElBQUwsR0FBWSxJQUFaO0FBQ0EsU0FBS0MsS0FBTCxHQUFhWixZQUFZLENBQUNhLGFBQTFCO0FBQ0EsU0FBS0MsT0FBTCxHQUFlLElBQUlDLHlCQUFKLENBQVk7QUFBQ0MsTUFBQUEsTUFBTSxFQUFFLEtBQUtQLFNBQWQ7QUFBeUJILE1BQUFBLElBQUksRUFBRSxLQUFLSTtBQUFwQyxLQUFaLENBQWY7QUFDRDs7QUFFRCxRQUFNTyxLQUFOLEdBQWU7QUFDYixRQUFJLEVBQUMsTUFBTSwyQkFBUCxDQUFKLEVBQXdCO0FBQ3RCLFlBQU0sSUFBSVQsS0FBSixDQUFVLHVEQUFWLENBQU47QUFDRDs7QUFFRCxTQUFLVSxXQUFMLENBQWlCbEIsWUFBWSxDQUFDbUIsY0FBOUI7QUFHQSxRQUFJQyxJQUFJLEdBQUcsQ0FBQyxLQUFLVixTQUFMLEdBQWlCLFNBQWxCLENBQVg7O0FBRUEsVUFBTVcsYUFBYSxHQUFJQyxNQUFELElBQVk7QUFDaEMsYUFBT0EsTUFBTSxDQUFDQyxPQUFQLENBQWUsd0JBQWYsTUFBNkMsQ0FBQyxDQUFyRDtBQUNELEtBRkQ7O0FBSUEsUUFBSUMsY0FBYyxHQUFHLEtBQXJCOztBQUNBLFFBQUk7QUFDRixZQUFNLEtBQUtDLE9BQUwsRUFBTjtBQUdBLFdBQUtkLElBQUwsR0FBWSxJQUFJZSx3QkFBSixDQUFlQywyQkFBZixFQUFpQ1AsSUFBakMsRUFBdUM7QUFDakRRLFFBQUFBLFFBQVEsRUFBRTtBQUR1QyxPQUF2QyxDQUFaO0FBR0FKLE1BQUFBLGNBQWMsR0FBRyxJQUFqQjs7QUFHQSxXQUFLLElBQUlLLE1BQVQsSUFBbUIsQ0FBQyxRQUFELEVBQVcsUUFBWCxDQUFuQixFQUF5QztBQUN2QyxhQUFLbEIsSUFBTCxDQUFVbUIsRUFBVixDQUFjLFNBQVFELE1BQU0sQ0FBQ0UsV0FBUCxFQUFxQixFQUEzQyxFQUErQ0MsS0FBRCxJQUFXO0FBQ3ZELGVBQUssSUFBSUMsQ0FBVCxJQUFjRCxLQUFkLEVBQXFCO0FBQ25CRSw0QkFBSUMsSUFBSixDQUFVLElBQUdOLE1BQU8sS0FBSUksQ0FBQyxDQUFDRyxJQUFGLEVBQVMsRUFBakM7QUFDRDtBQUNGLFNBSkQ7QUFLRDs7QUFHRCxXQUFLekIsSUFBTCxDQUFVbUIsRUFBVixDQUFhLE1BQWIsRUFBcUIsQ0FBQ08sSUFBRCxFQUFPQyxNQUFQLEtBQWtCO0FBQ3JDZCxRQUFBQSxjQUFjLEdBQUcsS0FBakI7O0FBQ0EsWUFBSSxLQUFLWixLQUFMLEtBQWVaLFlBQVksQ0FBQ2EsYUFBNUIsSUFDQSxLQUFLRCxLQUFMLEtBQWVaLFlBQVksQ0FBQ3VDLGNBRGhDLEVBQ2dEO0FBQzlDLGNBQUlDLEdBQUcsR0FBSSw4Q0FBNkNILElBQUssSUFBbkQsR0FDQyxVQUFTQyxNQUFPLEVBRDNCOztBQUVBSiwwQkFBSU8sS0FBSixDQUFVRCxHQUFWOztBQUNBLGVBQUt0QixXQUFMLENBQWlCbEIsWUFBWSxDQUFDYSxhQUE5QjtBQUNEO0FBQ0YsT0FURDs7QUFVQXFCLHNCQUFJQyxJQUFKLENBQVUsK0JBQThCZixJQUFJLENBQUNzQixJQUFMLENBQVUsR0FBVixDQUFlLEVBQXZEOztBQUdBLFlBQU0sS0FBSy9CLElBQUwsQ0FBVU0sS0FBVixDQUFnQkksYUFBaEIsQ0FBTjtBQUNBLFlBQU0sS0FBS3NCLGFBQUwsRUFBTjtBQUVELEtBbkNELENBbUNFLE9BQU9DLENBQVAsRUFBVTtBQUNWLFdBQUtDLElBQUwsQ0FBVTdDLFlBQVksQ0FBQzhDLFdBQXZCLEVBQW9DRixDQUFwQzs7QUFHQSxVQUFJcEIsY0FBSixFQUFvQjtBQUNsQixjQUFNLEtBQUtiLElBQUwsQ0FBVW9DLElBQVYsRUFBTjtBQUNEOztBQUNEYixzQkFBSWMsYUFBSixDQUFrQkosQ0FBbEI7QUFDRDtBQUNGOztBQUVESyxFQUFBQSxTQUFTLEdBQUk7QUFDWCxRQUFJLEtBQUtyQyxLQUFMLEtBQWVaLFlBQVksQ0FBQ2tELFlBQWhDLEVBQThDO0FBQzVDLGFBQU8sSUFBUDtBQUNEOztBQUVELFdBQU8sS0FBS3BDLE9BQUwsQ0FBYW1DLFNBQXBCO0FBQ0Q7O0FBRUQsUUFBTU4sYUFBTixHQUF1QjtBQUdyQixRQUFJUSxtQkFBbUIsR0FBRyxLQUExQjtBQUNBLFVBQU0sNkJBQWMsRUFBZCxFQUFrQixHQUFsQixFQUF1QixZQUFZO0FBQ3ZDLFVBQUksQ0FBQ25ELFlBQVksQ0FBQ2EsYUFBZCxFQUE2QmIsWUFBWSxDQUFDa0QsWUFBMUMsRUFBd0QzQixPQUF4RCxDQUFnRSxLQUFLWCxLQUFyRSxLQUErRSxDQUFuRixFQUFzRjtBQUVwRnVDLFFBQUFBLG1CQUFtQixHQUFHLEtBQUt2QyxLQUFMLEtBQWVaLFlBQVksQ0FBQ2EsYUFBbEQ7QUFDQTtBQUNEOztBQUVELFVBQUksTUFBTSxLQUFLdUMsU0FBTCxFQUFWLEVBQTRCO0FBQzFCLGFBQUtsQyxXQUFMLENBQWlCbEIsWUFBWSxDQUFDa0QsWUFBOUI7QUFDRDtBQUNGLEtBVkssQ0FBTjs7QUFZQSxRQUFJQyxtQkFBSixFQUF5QjtBQUN2QixZQUFNLElBQUkzQyxLQUFKLENBQVUsc0NBQVYsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsUUFBTTRDLFNBQU4sR0FBbUI7QUFDakIsVUFBTUMsUUFBUSxHQUFHLE1BQU0sS0FBS3ZDLE9BQUwsQ0FBYXdDLEtBQWIsQ0FBbUIsU0FBbkIsRUFBOEIsS0FBOUIsQ0FBdkI7O0FBQ0EsUUFBSUQsUUFBUSxDQUFDLENBQUQsQ0FBUixDQUFZRSxVQUFaLEtBQTJCLEdBQS9CLEVBQW9DO0FBQ2xDckIsc0JBQUlDLElBQUosQ0FBVSwrREFBVjs7QUFDQSxhQUFPLElBQVA7QUFDRDs7QUFDRCxXQUFPLEtBQVA7QUFDRDs7QUFFRCxRQUFNcUIsWUFBTixDQUFvQkMsSUFBcEIsRUFBMEI7QUFDeEIsU0FBS0MsV0FBTCxHQUFtQixLQUFLNUMsT0FBTCxDQUFhNEMsV0FBYixDQUF5QkMsSUFBekIsQ0FBOEIsS0FBSzdDLE9BQW5DLENBQW5CO0FBQ0EsVUFBTSxLQUFLQSxPQUFMLENBQWE4QyxPQUFiLENBQXFCLFVBQXJCLEVBQWlDLE1BQWpDLEVBQXlDO0FBQUNDLE1BQUFBLG1CQUFtQixFQUFFSjtBQUF0QixLQUF6QyxDQUFOO0FBQ0Q7O0FBRUQsUUFBTVYsSUFBTixDQUFZZSxVQUFVLEdBQUcsSUFBekIsRUFBK0I7QUFDN0IsUUFBSUEsVUFBSixFQUFnQjtBQUNkLFdBQUs1QyxXQUFMLENBQWlCbEIsWUFBWSxDQUFDdUMsY0FBOUI7QUFDRDs7QUFDRCxRQUFJO0FBQ0YsVUFBSSxLQUFLNUIsSUFBVCxFQUFlO0FBQ2IsY0FBTSxLQUFLQSxJQUFMLENBQVVvQyxJQUFWLEVBQU47QUFDRDs7QUFDRCxVQUFJZSxVQUFKLEVBQWdCO0FBQ2QsYUFBSzVDLFdBQUwsQ0FBaUJsQixZQUFZLENBQUNhLGFBQTlCO0FBQ0Q7QUFDRixLQVBELENBT0UsT0FBTytCLENBQVAsRUFBVTtBQUNWVixzQkFBSU8sS0FBSixDQUFVRyxDQUFWO0FBQ0Q7QUFDRjs7QUFFRDFCLEVBQUFBLFdBQVcsQ0FBRU4sS0FBRixFQUFTO0FBQ2xCLFNBQUtBLEtBQUwsR0FBYUEsS0FBYjs7QUFDQXNCLG9CQUFJNkIsS0FBSixDQUFXLGtDQUFpQ25ELEtBQU0sR0FBbEQ7O0FBQ0EsU0FBS2lDLElBQUwsQ0FBVTdDLFlBQVksQ0FBQ2dFLGFBQXZCLEVBQXNDO0FBQUNwRCxNQUFBQTtBQUFELEtBQXRDO0FBQ0Q7O0FBRUQsUUFBTXFELFdBQU4sQ0FBbUJDLEdBQW5CLEVBQXdCQyxNQUF4QixFQUFnQ0MsSUFBaEMsRUFBc0M7QUFDcEMsV0FBTyxNQUFNLEtBQUt0RCxPQUFMLENBQWE4QyxPQUFiLENBQXFCTSxHQUFyQixFQUEwQkMsTUFBMUIsRUFBa0NDLElBQWxDLENBQWI7QUFDRDs7QUFFRCxRQUFNQyxRQUFOLENBQWdCOUQsR0FBaEIsRUFBcUIrRCxHQUFyQixFQUEwQjtBQUN4QixXQUFPLE1BQU0sS0FBS3hELE9BQUwsQ0FBYTRDLFdBQWIsQ0FBeUJuRCxHQUF6QixFQUE4QitELEdBQTlCLENBQWI7QUFDRDs7QUFFRCxRQUFNN0MsT0FBTixHQUFpQjtBQUNmLFFBQUk4QyxHQUFKO0FBRUFBLElBQUFBLEdBQUcsR0FBRyx3REFDQSxpQkFEQSxHQUNvQixLQUFLN0QsU0FEekIsR0FDcUMsV0FEckMsR0FFQSx3REFGQSxHQUdBLDJEQUhBLEdBSUEsY0FKTjs7QUFLQXdCLG9CQUFJQyxJQUFKLENBQVUsd0RBQXVEb0MsR0FBSSxFQUFyRTs7QUFDQSxRQUFJO0FBRUYsWUFBT0Msa0JBQUVDLFNBQUYsQ0FBWUMsdUJBQUdDLElBQWYsQ0FBRCxDQUF1QkosR0FBdkIsQ0FBTjs7QUFDQXJDLHNCQUFJQyxJQUFKLENBQVMsMkNBQVQ7QUFDRCxLQUpELENBSUUsT0FBT3lDLEdBQVAsRUFBWTtBQUNaMUMsc0JBQUlDLElBQUosQ0FBUyxzQ0FBVDtBQUNEO0FBQ0Y7O0FBRUQsUUFBTTBDLGFBQU4sR0FBdUI7QUFDckIzQyxvQkFBSTZCLEtBQUosQ0FBVSxzQ0FBVjs7QUFHQSxRQUFJO0FBQ0YsWUFBTSxLQUFLakQsT0FBTCxDQUFhOEMsT0FBYixDQUFxQixHQUFyQixFQUEwQixRQUExQixDQUFOO0FBQ0QsS0FGRCxDQUVFLE9BQU9nQixHQUFQLEVBQVk7QUFDWjFDLHNCQUFJNEMsSUFBSixDQUFVLDhEQUFELEdBQ04sY0FBYUYsR0FBSSxFQURwQjtBQUVEO0FBQ0Y7O0FBckw0Qzs7O0FBd0wvQzVFLFlBQVksQ0FBQzhDLFdBQWIsR0FBMkIsb0JBQTNCO0FBQ0E5QyxZQUFZLENBQUNnRSxhQUFiLEdBQTZCLGNBQTdCO0FBQ0FoRSxZQUFZLENBQUNhLGFBQWIsR0FBNkIsU0FBN0I7QUFDQWIsWUFBWSxDQUFDbUIsY0FBYixHQUE4QixVQUE5QjtBQUNBbkIsWUFBWSxDQUFDa0QsWUFBYixHQUE0QixRQUE1QjtBQUNBbEQsWUFBWSxDQUFDdUMsY0FBYixHQUE4QixVQUE5QjtlQUdldkMsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBldmVudHMgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBTdWJQcm9jZXNzIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IFdBRF9JTlNUQUxMX1BBVEgsIHZlcmlmeVdBRCB9IGZyb20gJy4vaW5zdGFsbGVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgY3AgZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cbmNvbnN0IFJFUVVJUkVEX1BBUkFNUyA9IFtdOyAvLyBYWFlEIDEtNS0yMDE4OiByZW1vdmVkIGFwcCBmcm9tIHJlcXVpcmVkIHBhcmFtcyBiZWNhdXNlIHlvdSBjYW4gYWx0ZXJuYXRpdmVseSB1c2UgYXBwVG9wTGV2ZWxXaW5kb3dcbmNvbnN0IERFRkFVTFRfV0FEX0hPU1QgPSAnMTI3LjAuMC4xJztcbmNvbnN0IERFRkFVTFRfV0FEX1BPUlQgPSA0NzI0OyAvLyAgc2hvdWxkIGJlIG5vbi00NzIzIHRvIGF2b2lkIGNvbmZsaWN0IG9uIHRoZSBzYW1lIGJveFxuXG5jbGFzcyBXaW5BcHBEcml2ZXIgZXh0ZW5kcyBldmVudHMuRXZlbnRFbWl0dGVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGNvbnN0IHtob3N0LCBwb3J0fSA9IG9wdHM7XG4gICAgc3VwZXIoKTtcblxuICAgIGZvciAobGV0IHJlcSBvZiBSRVFVSVJFRF9QQVJBTVMpIHtcbiAgICAgIGlmICghb3B0cyB8fCAhb3B0c1tyZXFdKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgT3B0aW9uICcke3JlcX0nIGlzIHJlcXVpcmVkIWApO1xuICAgICAgfVxuICAgICAgdGhpc1tyZXFdID0gb3B0c1tyZXFdO1xuICAgIH1cblxuICAgIHRoaXMucHJveHlIb3N0ID0gaG9zdCB8fCBERUZBVUxUX1dBRF9IT1NUO1xuICAgIHRoaXMucHJveHlQb3J0ID0gcG9ydCB8fCBERUZBVUxUX1dBRF9QT1JUO1xuICAgIHRoaXMucHJvYyA9IG51bGw7XG4gICAgdGhpcy5zdGF0ZSA9IFdpbkFwcERyaXZlci5TVEFURV9TVE9QUEVEO1xuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtzZXJ2ZXI6IHRoaXMucHJveHlIb3N0LCBwb3J0OiB0aGlzLnByb3h5UG9ydH0pO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIGlmICghYXdhaXQgdmVyaWZ5V0FEKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IHZlcmlmeSBXaW5BcHBEcml2ZXIgaW5zdGFsbDsgcmUtcnVuIGluc3RhbGwnKTtcbiAgICB9XG5cbiAgICB0aGlzLmNoYW5nZVN0YXRlKFdpbkFwcERyaXZlci5TVEFURV9TVEFSVElORyk7XG5cbiAgICAvLyBYWFhZRCBUT0RPOiB3b3VsZCBiZSBiZXR0ZXIgaWYgV2luQXBwRHJpdmVyIGRpZG4ndCByZXF1aXJlIHBhc3NpbmcgaW4gL3dkL2h1YiBhcyBhIHBhcmFtXG4gICAgbGV0IGFyZ3MgPSBbdGhpcy5wcm94eVBvcnQgKyAnL3dkL2h1YiddO1xuXG4gICAgY29uc3Qgc3RhcnREZXRlY3RvciA9IChzdGRvdXQpID0+IHtcbiAgICAgIHJldHVybiBzdGRvdXQuaW5kZXhPZignbGlzdGVuaW5nIGZvciByZXF1ZXN0cycpICE9PSAtMTtcbiAgICB9O1xuXG4gICAgbGV0IHByb2Nlc3NJc0FsaXZlID0gZmFsc2U7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMua2lsbEFsbCgpO1xuXG4gICAgICAvLyBzZXQgdXAgb3VyIHN1YnByb2Nlc3Mgb2JqZWN0XG4gICAgICB0aGlzLnByb2MgPSBuZXcgU3ViUHJvY2VzcyhXQURfSU5TVEFMTF9QQVRILCBhcmdzLCB7XG4gICAgICAgIGVuY29kaW5nOiAndWNzMidcbiAgICAgIH0pO1xuICAgICAgcHJvY2Vzc0lzQWxpdmUgPSB0cnVlO1xuXG4gICAgICAvLyBoYW5kbGUgbG9nIG91dHB1dFxuICAgICAgZm9yIChsZXQgc3RyZWFtIG9mIFsnU1RET1VUJywgJ1NUREVSUiddKSB7XG4gICAgICAgIHRoaXMucHJvYy5vbihgbGluZXMtJHtzdHJlYW0udG9Mb3dlckNhc2UoKX1gLCAobGluZXMpID0+IHtcbiAgICAgICAgICBmb3IgKGxldCBsIG9mIGxpbmVzKSB7XG4gICAgICAgICAgICBsb2cuaW5mbyhgWyR7c3RyZWFtfV0gJHtsLnRyaW0oKX1gKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBoYW5kbGUgb3V0LW9mLWJvdW5kIGV4aXQgYnkgc2ltcGx5IGVtaXR0aW5nIGEgc3RvcHBlZCBzdGF0ZVxuICAgICAgdGhpcy5wcm9jLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgICBwcm9jZXNzSXNBbGl2ZSA9IGZhbHNlO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQgJiZcbiAgICAgICAgICAgIHRoaXMuc3RhdGUgIT09IFdpbkFwcERyaXZlci5TVEFURV9TVE9QUElORykge1xuICAgICAgICAgIGxldCBtc2cgPSBgV2luQXBwRHJpdmVyIGV4aXRlZCB1bmV4cGVjdGVkbHkgd2l0aCBjb2RlICR7Y29kZX0sIGAgK1xuICAgICAgICAgICAgICAgICAgICBgc2lnbmFsICR7c2lnbmFsfWA7XG4gICAgICAgICAgbG9nLmVycm9yKG1zZyk7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShXaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBFRCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgbG9nLmluZm8oYFNwYXduaW5nIHdpbmFwcGRyaXZlciB3aXRoOiAke2FyZ3Muam9pbignICcpfWApO1xuXG4gICAgICAvLyBzdGFydCBzdWJwcm9jIGFuZCB3YWl0IGZvciBzdGFydERldGVjdG9yXG4gICAgICBhd2FpdCB0aGlzLnByb2Muc3RhcnQoc3RhcnREZXRlY3Rvcik7XG4gICAgICBhd2FpdCB0aGlzLndhaXRGb3JPbmxpbmUoKTtcblxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuZW1pdChXaW5BcHBEcml2ZXIuRVZFTlRfRVJST1IsIGUpO1xuICAgICAgLy8ganVzdCBiZWNhdXNlIHdlIGhhZCBhbiBlcnJvciBkb2Vzbid0IG1lYW4gdGhlIHdpbmFwcGRyaXZlciBwcm9jZXNzXG4gICAgICAvLyBmaW5pc2hlZDsgd2Ugc2hvdWxkIGNsZWFuIHVwIGlmIG5lY2Vzc2FyeVxuICAgICAgaWYgKHByb2Nlc3NJc0FsaXZlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCk7XG4gICAgICB9XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhlKTtcbiAgICB9XG4gIH1cblxuICBzZXNzaW9uSWQgKCkge1xuICAgIGlmICh0aGlzLnN0YXRlICE9PSBXaW5BcHBEcml2ZXIuU1RBVEVfT05MSU5FKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5qd3Byb3h5LnNlc3Npb25JZDtcbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JPbmxpbmUgKCkge1xuXG4gICAgLy8gd2UgbmVlZCB0byBtYWtlIHN1cmUgV0FEIGhhc24ndCBjcmFzaGVkXG4gICAgbGV0IHdpbmFwcGRyaXZlclN0b3BwZWQgPSBmYWxzZTtcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDIwLCAyMDAsIGFzeW5jICgpID0+IHtcbiAgICAgIGlmIChbV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQsIFdpbkFwcERyaXZlci5TVEFURV9PTkxJTkVdLmluZGV4T2YodGhpcy5zdGF0ZSkgPj0gMCkge1xuICAgICAgICAvLyB3ZSBhcmUgZWl0aGVyIHN0b3BwZWQsIHN0b3BwaW5nLCBvciB3ZSdyZSBvbmxpbmVcbiAgICAgICAgd2luYXBwZHJpdmVyU3RvcHBlZCA9IHRoaXMuc3RhdGUgPT09IFdpbkFwcERyaXZlci5TVEFURV9TVE9QUEVEO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChhd2FpdCB0aGlzLmdldFN0YXR1cygpKSB7XG4gICAgICAgIHRoaXMuY2hhbmdlU3RhdGUoV2luQXBwRHJpdmVyLlNUQVRFX09OTElORSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAod2luYXBwZHJpdmVyU3RvcHBlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdXaW5BcHBEcml2ZXIgY3Jhc2hlZCBkdXJpbmcgc3RhcnR1cC4nKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRTdGF0dXMgKCkge1xuICAgIGNvbnN0IHJlc0Jsb2NrID0gYXdhaXQgdGhpcy5qd3Byb3h5LnByb3h5KCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgIGlmIChyZXNCbG9ja1swXS5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgIGxvZy5pbmZvKGBTdGF0dXMgY2FsbCByZXR1cm5lZCAyMDAuIHdlJ3JlIG9ubGluZSBhbmQgcmVhZHkgdG8gcnVuIHRlc3RzYCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChjYXBzKSB7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuandwcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMuandwcm94eSk7XG4gICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogY2Fwc30pO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoZW1pdFN0YXRlcyA9IHRydWUpIHtcbiAgICBpZiAoZW1pdFN0YXRlcykge1xuICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShXaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBJTkcpO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgaWYgKHRoaXMucHJvYykge1xuICAgICAgICBhd2FpdCB0aGlzLnByb2Muc3RvcCgpO1xuICAgICAgfVxuICAgICAgaWYgKGVtaXRTdGF0ZXMpIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShXaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBFRCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLmVycm9yKGUpO1xuICAgIH1cbiAgfVxuXG4gIGNoYW5nZVN0YXRlIChzdGF0ZSkge1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICBsb2cuZGVidWcoYFdpbkFwcERyaXZlciBjaGFuZ2VkIHN0YXRlIHRvICcke3N0YXRlfSdgKTtcbiAgICB0aGlzLmVtaXQoV2luQXBwRHJpdmVyLkVWRU5UX0NIQU5HRUQsIHtzdGF0ZX0pO1xuICB9XG5cbiAgYXN5bmMgc2VuZENvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5UmVxIChyZXEsIHJlcykge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMocmVxLCByZXMpO1xuICB9XG5cbiAgYXN5bmMga2lsbEFsbCAoKSB7XG4gICAgbGV0IGNtZDtcbiAgICAvLyBqcyBoaW50IGNhbm5vdCBoYW5kbGUgYmFja3RpY2tzLCBldmVuIGVzY2FwZWQsIHdpdGhpbiB0ZW1wbGF0ZSBsaXRlcmFsc1xuICAgIGNtZCA9ICdGT1IgL0YgXCJ1c2ViYWNrcSB0b2tlbnM9NVwiICVhIGluIChgbmV0c3RhdCAtbmFvIF58ICcgK1xuICAgICAgICAgICdmaW5kc3RyIC9SIC9DOlwiJyArIHRoaXMucHJveHlQb3J0ICsgJyBcImApIGRvICgnICtcbiAgICAgICAgICAnRk9SIC9GIFwidXNlYmFja3FcIiAlYiBpbiAoYFRBU0tMSVNUIC9GSSBcIlBJRCBlcSAlYVwiIF58ICcgK1xuICAgICAgICAgICdmaW5kc3RyIC9JIHdpbmFwcGRyaXZlci5leGVgKSBkbyAoSUYgTk9UICViPT1cIlwiIFRBU0tLSUxMICcgK1xuICAgICAgICAgICcvRiAvUElEICVhKSknO1xuICAgIGxvZy5pbmZvKGBLaWxsaW5nIGFueSBvbGQgV2luQXBwRHJpdmVycyBvbiBzYW1lIHBvcnQsIHJ1bm5pbmc6ICR7Y21kfWApO1xuICAgIHRyeSB7XG4gICAgICAvLyB1c2UgY3AuZXhlYyBpbnN0ZWFkIG9mIHRlZW4gcHJvY2VzcyBiZWNhdXNlIG9mIGNyYXp5IHdpbmRvd3MgcXVvdGluZ1xuICAgICAgYXdhaXQgKEIucHJvbWlzaWZ5KGNwLmV4ZWMpKShjbWQpO1xuICAgICAgbG9nLmluZm8oJ1N1Y2Nlc3NmdWxseSBjbGVhbmVkIHVwIG9sZCBXaW5BcHBEcml2ZXJzJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuaW5mbygnTm8gb2xkIFdpbkFwcERyaXZlcnMgc2VlbWVkIHRvIGV4aXN0Jyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nLmRlYnVnKCdEZWxldGluZyBXaW5BcHBEcml2ZXIgc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIFdpbkFwcERyaXZlciBkZWxldGVTZXNzaW9uIHdvcmtlZDsgYCArXG4gICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxufVxuXG5XaW5BcHBEcml2ZXIuRVZFTlRfRVJST1IgPSAnd2luYXBwZHJpdmVyX2Vycm9yJztcbldpbkFwcERyaXZlci5FVkVOVF9DSEFOR0VEID0gJ3N0YXRlQ2hhbmdlZCc7XG5XaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBFRCA9ICdzdG9wcGVkJztcbldpbkFwcERyaXZlci5TVEFURV9TVEFSVElORyA9ICdzdGFydGluZyc7XG5XaW5BcHBEcml2ZXIuU1RBVEVfT05MSU5FID0gJ29ubGluZSc7XG5XaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBJTkcgPSAnc3RvcHBpbmcnO1xuXG5leHBvcnQgeyBXaW5BcHBEcml2ZXIsIERFRkFVTFRfV0FEX0hPU1QsIERFRkFVTFRfV0FEX1BPUlR9O1xuZXhwb3J0IGRlZmF1bHQgV2luQXBwRHJpdmVyO1xuIl0sImZpbGUiOiJsaWIvd2luYXBwZHJpdmVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
