"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger.js"));

var _helpers = require("../helpers.js");

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _shellQuote = require("shell-quote");

let manifestMethods = {};

async function extractApkInfoWithApkTools(localApk, aaptPath, jarPath, tmpRoot) {
  _logger.default.info('Extracting package and launch activity from manifest');

  let args = ['dump', 'badging', localApk];
  let stdout = (await (0, _teen_process.exec)(aaptPath, args)).stdout;
  let apkPackage = new RegExp(/package: name='([^']+)'/g).exec(stdout);

  if (!apkPackage || apkPackage.length < 2) {
    throw new Error(`Cannot parse package name from ` + `'${_lodash.default.join([aaptPath, 'dump', 'badging', '"' + localApk + '"'], ' ')}' command  output`);
  }

  apkPackage = apkPackage[1];
  let apkActivity = new RegExp(/launchable-activity: name='([^']+)'/g).exec(stdout);

  if (apkActivity && apkActivity.length >= 2) {
    apkActivity = apkActivity[1];
    return {
      apkPackage,
      apkActivity
    };
  }

  let outputPath = _path.default.resolve(tmpRoot, apkPackage);

  let getLaunchActivity = ['-jar', jarPath, 'printLaunchActivity', localApk, outputPath];
  const output = await (0, _teen_process.exec)('java', getLaunchActivity);

  if (output.stderr) {
    throw new Error(`Cannot parse launchActivity from manifest: ${output.stderr}`);
  }

  stdout = output.stdout;
  let act = new RegExp(/Launch activity parsed:([^']+)/g).exec(stdout);

  if (act && act.length >= 2) {
    apkActivity = act[1];
    return {
      apkPackage,
      apkActivity
    };
  }

  throw new Error(`Cannot parse main activity name from '${stdout}' command  output`);
}

async function extractApkInfoWithApkanalyzer(localApk, apkanalyzerPath) {
  const args = ['-h', 'manifest', 'print', localApk];

  _logger.default.debug(`Starting '${apkanalyzerPath}' with args ${JSON.stringify(args)}`);

  const {
    stdout
  } = await (0, _teen_process.exec)(apkanalyzerPath, args, {
    shell: true,
    cwd: _path.default.dirname(apkanalyzerPath)
  });
  const {
    pkg,
    activity
  } = (0, _helpers.parseManifest)(stdout);

  if (!pkg) {
    throw new Error(`Cannot parse package name from ${stdout}`);
  }

  if (!activity) {
    throw new Error(`Cannot parse main activity name from ${stdout}`);
  }

  return {
    apkPackage: pkg,
    apkActivity: activity
  };
}

manifestMethods.packageAndLaunchActivityFromManifest = async function packageAndLaunchActivityFromManifest(appPath) {
  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  const apkInfoGetters = [async () => {
    const apkanalyzerPath = await (0, _helpers.getApkanalyzerForOs)(this);
    return await extractApkInfoWithApkanalyzer(appPath, apkanalyzerPath);
  }, async () => {
    await this.initAapt();
    return await extractApkInfoWithApkTools(appPath, this.binaries.aapt, this.jars['appium_apk_tools.jar'], this.tmpDir);
  }];
  let savedError;

  for (const infoGetter of apkInfoGetters) {
    try {
      const {
        apkPackage,
        apkActivity
      } = await infoGetter();

      _logger.default.info(`Package name: '${apkPackage}'`);

      _logger.default.info(`Main activity name: '${apkActivity}'`);

      return {
        apkPackage,
        apkActivity
      };
    } catch (e) {
      if (infoGetter !== _lodash.default.last(apkInfoGetters)) {
        _logger.default.info(`Using the alternative activity name detection method because of: ${e.message}`);
      }

      savedError = e;
    }
  }

  throw new Error(`packageAndLaunchActivityFromManifest failed. Original error: ${savedError.message}` + (savedError.stderr ? `; StdErr: ${savedError.stderr}` : ''));
};

manifestMethods.targetSdkVersionFromManifest = async function targetSdkVersionFromManifest(appPath) {
  const originalAppPath = appPath;

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  _logger.default.info('Extracting target SDK version from the manifest');

  try {
    const apkanalyzerPath = await (0, _helpers.getApkanalyzerForOs)(this);
    const {
      stdout
    } = await (0, _teen_process.exec)(apkanalyzerPath, ['manifest', 'target-sdk', appPath], {
      shell: true,
      cwd: _path.default.dirname(apkanalyzerPath)
    });

    if (isNaN(_lodash.default.trim(stdout))) {
      throw new Error(`Cannot parse the minimum SDK version from '${stdout}'`);
    }

    return parseInt(_lodash.default.trim(stdout), 10);
  } catch (e) {
    _logger.default.info(`Cannot extract targetSdkVersion using apkanalyzer. Falling back to aapt. ` + `Original error: ${e.message}`);

    await this.initAapt();
    const args = ['dump', 'badging', appPath];
    let output;

    try {
      const {
        stdout
      } = await (0, _teen_process.exec)(this.binaries.aapt, args);
      output = stdout;
    } catch (e) {
      throw new Error(`Fetching targetSdkVersion from '${originalAppPath}' failed. ` + `Original error: ${e.message}`);
    }

    const targetSdkVersion = new RegExp(/targetSdkVersion:'([^']+)'/g).exec(output);

    if (!targetSdkVersion) {
      throw new Error(`targetSdkVersion is not specified in the '${originalAppPath}' application`);
    }

    return parseInt(targetSdkVersion[1], 10);
  }
};

manifestMethods.targetSdkVersionUsingPKG = async function targetSdkVersionUsingPKG(pkg, cmdOutput = null) {
  let stdout = cmdOutput || (await this.shell(['dumpsys', 'package', pkg]));
  let targetSdkVersion = new RegExp(/targetSdk=([^\s\s]+)/g).exec(stdout);

  if (targetSdkVersion && targetSdkVersion.length >= 2) {
    targetSdkVersion = targetSdkVersion[1];
  } else {
    targetSdkVersion = 0;
  }

  return parseInt(targetSdkVersion, 10);
};

manifestMethods.compileManifest = async function compileManifest(manifest, manifestPackage, targetPackage) {
  const {
    platform,
    platformPath
  } = await (0, _helpers.getAndroidPlatformAndPath)();

  if (!platform) {
    throw new Error('Cannot compile the manifest. The required platform does not exist (API level >= 17)');
  }

  const resultPath = `${manifest}.apk`;

  const androidJarPath = _path.default.resolve(platformPath, 'android.jar');

  if (await _appiumSupport.fs.exists(resultPath)) {
    await _appiumSupport.fs.rimraf(resultPath);
  }

  try {
    await this.initAapt2();
    const args = ['link', '-o', resultPath, '--manifest', manifest, '--rename-manifest-package', manifestPackage, '--rename-instrumentation-target-package', targetPackage, '-I', androidJarPath, '-v'];

    _logger.default.debug(`Compiling the manifest using '${(0, _shellQuote.quote)([this.binaries.aapt2, ...args])}'`);

    await (0, _teen_process.exec)(this.binaries.aapt2, args);
  } catch (e) {
    _logger.default.debug('Cannot compile the manifest using aapt2. Defaulting to aapt. ' + `Original error: ${e.stderr || e.message}`);

    await this.initAapt();
    const args = ['package', '-M', manifest, '--rename-manifest-package', manifestPackage, '--rename-instrumentation-target-package', targetPackage, '-I', androidJarPath, '-F', resultPath, '-f'];

    _logger.default.debug(`Compiling the manifest using '${(0, _shellQuote.quote)([this.binaries.aapt, ...args])}'`);

    try {
      await (0, _teen_process.exec)(this.binaries.aapt, args);
    } catch (e1) {
      throw new Error(`Cannot compile the manifest. Original error: ${e1.stderr || e1.message}`);
    }
  }

  _logger.default.debug(`Compiled the manifest at '${resultPath}'`);
};

manifestMethods.insertManifest = async function insertManifest(manifest, srcApk, dstApk) {
  _logger.default.debug(`Inserting manifest '${manifest}', src: '${srcApk}', dst: '${dstApk}'`);

  await _appiumSupport.zip.assertValidZip(srcApk);
  await (0, _helpers.unzipFile)(`${manifest}.apk`);

  const manifestName = _path.default.basename(manifest);

  try {
    await this.initAapt();
    await _appiumSupport.fs.copyFile(srcApk, dstApk);

    _logger.default.debug('Moving manifest');

    try {
      await (0, _teen_process.exec)(this.binaries.aapt, ['remove', dstApk, manifestName]);
    } catch (ign) {}

    await (0, _teen_process.exec)(this.binaries.aapt, ['add', dstApk, manifestName], {
      cwd: _path.default.dirname(manifest)
    });
  } catch (e) {
    _logger.default.debug('Cannot insert manifest using aapt. Defaulting to zip. ' + `Original error: ${e.stderr || e.message}`);

    const tmpRoot = await _appiumSupport.tempDir.openDir();

    try {
      _logger.default.debug(`Extracting the source apk at '${srcApk}'`);

      await _appiumSupport.zip.extractAllTo(srcApk, tmpRoot);

      _logger.default.debug('Moving manifest');

      await _appiumSupport.fs.mv(manifest, _path.default.resolve(tmpRoot, manifestName));

      _logger.default.debug(`Collecting the destination apk at '${dstApk}'`);

      await _appiumSupport.zip.toArchive(dstApk, {
        cwd: tmpRoot
      });
    } finally {
      await _appiumSupport.fs.rimraf(tmpRoot);
    }
  }

  _logger.default.debug(`Manifest insertion into '${dstApk}' is completed`);
};

manifestMethods.hasInternetPermissionFromManifest = async function hasInternetPermissionFromManifest(appPath) {
  const originalAppPath = appPath;

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  _logger.default.debug(`Checking if '${originalAppPath}' requires internet access permission in the manifest`);

  const internetPermissionPattern = /\bandroid\.permission\.INTERNET\b/;

  try {
    const apkanalyzerPath = await (0, _helpers.getApkanalyzerForOs)(this);
    const args = ['manifest', 'permissions', appPath];

    _logger.default.debug(`Starting '${apkanalyzerPath}' with args ${JSON.stringify(args)}`);

    const {
      stdout
    } = await (0, _teen_process.exec)(apkanalyzerPath, args, {
      shell: true,
      cwd: _path.default.dirname(apkanalyzerPath)
    });
    return internetPermissionPattern.test(stdout);
  } catch (e) {
    _logger.default.debug('Cannot get apk permissions using apkanalyzer. Falling back to aapt. ' + `Original error: ${e.stderr || e.message}`);

    await this.initAapt();

    try {
      const {
        stdout
      } = await (0, _teen_process.exec)(this.binaries.aapt, ['dump', 'badging', appPath]);
      return internetPermissionPattern.test(stdout);
    } catch (e1) {
      throw new Error(`Cannot check if '${originalAppPath}' requires internet access permission. ` + `Original error: ${e1.stderr || e1.message}`);
    }
  }
};

var _default = manifestMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hbmRyb2lkLW1hbmlmZXN0LmpzIl0sIm5hbWVzIjpbIm1hbmlmZXN0TWV0aG9kcyIsImV4dHJhY3RBcGtJbmZvV2l0aEFwa1Rvb2xzIiwibG9jYWxBcGsiLCJhYXB0UGF0aCIsImphclBhdGgiLCJ0bXBSb290IiwibG9nIiwiaW5mbyIsImFyZ3MiLCJzdGRvdXQiLCJhcGtQYWNrYWdlIiwiUmVnRXhwIiwiZXhlYyIsImxlbmd0aCIsIkVycm9yIiwiXyIsImpvaW4iLCJhcGtBY3Rpdml0eSIsIm91dHB1dFBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsImdldExhdW5jaEFjdGl2aXR5Iiwib3V0cHV0Iiwic3RkZXJyIiwiYWN0IiwiZXh0cmFjdEFwa0luZm9XaXRoQXBrYW5hbHl6ZXIiLCJhcGthbmFseXplclBhdGgiLCJkZWJ1ZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJzaGVsbCIsImN3ZCIsImRpcm5hbWUiLCJwa2ciLCJhY3Rpdml0eSIsInBhY2thZ2VBbmRMYXVuY2hBY3Rpdml0eUZyb21NYW5pZmVzdCIsImFwcFBhdGgiLCJlbmRzV2l0aCIsIkFQS1NfRVhURU5TSU9OIiwiZXh0cmFjdEJhc2VBcGsiLCJhcGtJbmZvR2V0dGVycyIsImluaXRBYXB0IiwiYmluYXJpZXMiLCJhYXB0IiwiamFycyIsInRtcERpciIsInNhdmVkRXJyb3IiLCJpbmZvR2V0dGVyIiwiZSIsImxhc3QiLCJtZXNzYWdlIiwidGFyZ2V0U2RrVmVyc2lvbkZyb21NYW5pZmVzdCIsIm9yaWdpbmFsQXBwUGF0aCIsImlzTmFOIiwidHJpbSIsInBhcnNlSW50IiwidGFyZ2V0U2RrVmVyc2lvbiIsInRhcmdldFNka1ZlcnNpb25Vc2luZ1BLRyIsImNtZE91dHB1dCIsImNvbXBpbGVNYW5pZmVzdCIsIm1hbmlmZXN0IiwibWFuaWZlc3RQYWNrYWdlIiwidGFyZ2V0UGFja2FnZSIsInBsYXRmb3JtIiwicGxhdGZvcm1QYXRoIiwicmVzdWx0UGF0aCIsImFuZHJvaWRKYXJQYXRoIiwiZnMiLCJleGlzdHMiLCJyaW1yYWYiLCJpbml0QWFwdDIiLCJhYXB0MiIsImUxIiwiaW5zZXJ0TWFuaWZlc3QiLCJzcmNBcGsiLCJkc3RBcGsiLCJ6aXAiLCJhc3NlcnRWYWxpZFppcCIsIm1hbmlmZXN0TmFtZSIsImJhc2VuYW1lIiwiY29weUZpbGUiLCJpZ24iLCJ0ZW1wRGlyIiwib3BlbkRpciIsImV4dHJhY3RBbGxUbyIsIm12IiwidG9BcmNoaXZlIiwiaGFzSW50ZXJuZXRQZXJtaXNzaW9uRnJvbU1hbmlmZXN0IiwiaW50ZXJuZXRQZXJtaXNzaW9uUGF0dGVybiIsInRlc3QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsZUFBZSxHQUFHLEVBQXRCOztBQW9CQSxlQUFlQywwQkFBZixDQUEyQ0MsUUFBM0MsRUFBcURDLFFBQXJELEVBQStEQyxPQUEvRCxFQUF3RUMsT0FBeEUsRUFBaUY7QUFDL0VDLGtCQUFJQyxJQUFKLENBQVMsc0RBQVQ7O0FBQ0EsTUFBSUMsSUFBSSxHQUFHLENBQUMsTUFBRCxFQUFTLFNBQVQsRUFBb0JOLFFBQXBCLENBQVg7QUFDQSxNQUFJTyxNQUFNLEdBQUcsQ0FBQyxNQUFNLHdCQUFLTixRQUFMLEVBQWVLLElBQWYsQ0FBUCxFQUE2QkMsTUFBMUM7QUFDQSxNQUFJQyxVQUFVLEdBQUcsSUFBSUMsTUFBSixDQUFXLDBCQUFYLEVBQXVDQyxJQUF2QyxDQUE0Q0gsTUFBNUMsQ0FBakI7O0FBQ0EsTUFBSSxDQUFDQyxVQUFELElBQWVBLFVBQVUsQ0FBQ0csTUFBWCxHQUFvQixDQUF2QyxFQUEwQztBQUN4QyxVQUFNLElBQUlDLEtBQUosQ0FBVyxpQ0FBRCxHQUNiLElBQUdDLGdCQUFFQyxJQUFGLENBQU8sQ0FBQ2IsUUFBRCxFQUFXLE1BQVgsRUFBbUIsU0FBbkIsRUFBOEIsTUFBTUQsUUFBTixHQUFpQixHQUEvQyxDQUFQLEVBQTRELEdBQTVELENBQWlFLG1CQURqRSxDQUFO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Q0FBQ0MsSUFBMUIsQ0FBK0JoRixNQUEvQixDQUFQO0FBQ0QsR0FURCxDQVNFLE9BQU91QyxDQUFQLEVBQVU7QUFDVjFDLG9CQUFJcUIsS0FBSixDQUFVLHlFQUNQLG1CQUFrQnFCLENBQUMsQ0FBQ3pCLE1BQUYsSUFBWXlCLENBQUMsQ0FBQ0UsT0FBUSxFQUQzQzs7QUFFQSxVQUFNLEtBQUtULFFBQUwsRUFBTjs7QUFDQSxRQUFJO0FBQ0YsWUFBTTtBQUFDaEMsUUFBQUE7QUFBRCxVQUFXLE1BQU0sd0JBQUssS0FBS2lDLFFBQUwsQ0FBY0MsSUFBbkIsRUFBeUIsQ0FBQyxNQUFELEVBQVMsU0FBVCxFQUFvQlAsT0FBcEIsQ0FBekIsQ0FBdkI7QUFDQSxhQUFPb0QseUJBQXlCLENBQUNDLElBQTFCLENBQStCaEYsTUFBL0IsQ0FBUDtBQUNELEtBSEQsQ0FHRSxPQUFPK0QsRUFBUCxFQUFXO0FBQ1gsWUFBTSxJQUFJMUQsS0FBSixDQUFXLG9CQUFtQnNDLGVBQWdCLHlDQUFwQyxHQUNDLG1CQUFrQm9CLEVBQUUsQ0FBQ2pELE1BQUgsSUFBYWlELEVBQUUsQ0FBQ3RCLE9BQVEsRUFEckQsQ0FBTjtBQUVEO0FBQ0Y7QUFDRixDQTlCRDs7ZUFnQ2VsRCxlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlci5qcyc7XG5pbXBvcnQge1xuICBnZXRBbmRyb2lkUGxhdGZvcm1BbmRQYXRoLCB1bnppcEZpbGUsXG4gIGdldEFwa2FuYWx5emVyRm9yT3MsIEFQS1NfRVhURU5TSU9OLCBwYXJzZU1hbmlmZXN0IH0gZnJvbSAnLi4vaGVscGVycy5qcyc7XG5pbXBvcnQgeyBmcywgemlwLCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcXVvdGUgfSBmcm9tICdzaGVsbC1xdW90ZSc7XG5cbmxldCBtYW5pZmVzdE1ldGhvZHMgPSB7fTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBBUEtJbmZvXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYXBrUGFja2FnZSAtIFRoZSBuYW1lIG9mIGFwcGxpY2F0aW9uIHBhY2thZ2UsIGZvciBleGFtcGxlICdjb20uYWNtZS5hcHAnLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGFwa0FjdGl2aXR5IC0gVGhlIG5hbWUgb2YgbWFpbiBhcHBsaWNhdGlvbiBhY3Rpdml0eS5cbiAqL1xuXG4vKipcbiAqIEV4dHJhY3QgcGFja2FnZSBhbmQgbWFpbiBhY3Rpdml0eSBuYW1lIGZyb20gYXBwbGljYXRpb24gbWFuaWZlc3QgdXNpbmdcbiAqIHRoZSBjdXN0b20gYXBrIHRvb2xzLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhbEFwayAtIFRoZSBmdWxsIHBhdGggdG8gYXBwbGljYXRpb24gcGFja2FnZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBhYXB0UGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gYXBwdCBiaW5hcnkuXG4gKiBAcGFyYW0ge3N0cmluZ30gamFyUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gYXBwaXVtX2Fwa190b29scy5qYXIgdXRpbGl0eVxuICogQHBhcmFtIHtzdHJpbmd9IHRtcFJvb3QgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBjbGFzcy13aWRlIHRlbXBvcmFyeSBmb2xkZXIuXG4gKiBAcmV0dXJuIHtBUEtJbmZvfSBUaGUgcGFyc2VkIGFwcGxpY2F0aW9uIGluZm8uXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIGRhdGEgZnJvbSB0aGUgZ2l2ZW5cbiAqICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICovXG5hc3luYyBmdW5jdGlvbiBleHRyYWN0QXBrSW5mb1dpdGhBcGtUb29scyAobG9jYWxBcGssIGFhcHRQYXRoLCBqYXJQYXRoLCB0bXBSb290KSB7XG4gIGxvZy5pbmZvKCdFeHRyYWN0aW5nIHBhY2thZ2UgYW5kIGxhdW5jaCBhY3Rpdml0eSBmcm9tIG1hbmlmZXN0Jyk7XG4gIGxldCBhcmdzID0gWydkdW1wJywgJ2JhZGdpbmcnLCBsb2NhbEFwa107XG4gIGxldCBzdGRvdXQgPSAoYXdhaXQgZXhlYyhhYXB0UGF0aCwgYXJncykpLnN0ZG91dDtcbiAgbGV0IGFwa1BhY2thZ2UgPSBuZXcgUmVnRXhwKC9wYWNrYWdlOiBuYW1lPScoW14nXSspJy9nKS5leGVjKHN0ZG91dCk7XG4gIGlmICghYXBrUGFja2FnZSB8fCBhcGtQYWNrYWdlLmxlbmd0aCA8IDIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBwYXJzZSBwYWNrYWdlIG5hbWUgZnJvbSBgICtcbiAgICAgIGAnJHtfLmpvaW4oW2FhcHRQYXRoLCAnZHVtcCcsICdiYWRnaW5nJywgJ1wiJyArIGxvY2FsQXBrICsgJ1wiJ10sICcgJyl9JyBjb21tYW5kICBvdXRwdXRgKTtcbiAgfVxuICBhcGtQYWNrYWdlID0gYXBrUGFja2FnZVsxXTtcbiAgbGV0IGFwa0FjdGl2aXR5ID0gbmV3IFJlZ0V4cCgvbGF1bmNoYWJsZS1hY3Rpdml0eTogbmFtZT0nKFteJ10rKScvZykuZXhlYyhzdGRvdXQpO1xuICBpZiAoYXBrQWN0aXZpdHkgJiYgYXBrQWN0aXZpdHkubGVuZ3RoID49IDIpIHtcbiAgICBhcGtBY3Rpdml0eSA9IGFwa0FjdGl2aXR5WzFdO1xuICAgIHJldHVybiB7YXBrUGFja2FnZSwgYXBrQWN0aXZpdHl9O1xuICB9XG5cbiAgbGV0IG91dHB1dFBhdGggPSBwYXRoLnJlc29sdmUodG1wUm9vdCwgYXBrUGFja2FnZSk7XG4gIGxldCBnZXRMYXVuY2hBY3Rpdml0eSA9IFtcbiAgICAnLWphcicsIGphclBhdGgsXG4gICAgJ3ByaW50TGF1bmNoQWN0aXZpdHknLCBsb2NhbEFwayxcbiAgICBvdXRwdXRQYXRoXG4gIF07XG4gIGNvbnN0IG91dHB1dCA9IGF3YWl0IGV4ZWMoJ2phdmEnLCBnZXRMYXVuY2hBY3Rpdml0eSk7XG4gIGlmIChvdXRwdXQuc3RkZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgbGF1bmNoQWN0aXZpdHkgZnJvbSBtYW5pZmVzdDogJHtvdXRwdXQuc3RkZXJyfWApO1xuICB9XG4gIHN0ZG91dCA9IG91dHB1dC5zdGRvdXQ7XG4gIGxldCBhY3QgPSBuZXcgUmVnRXhwKC9MYXVuY2ggYWN0aXZpdHkgcGFyc2VkOihbXiddKykvZykuZXhlYyhzdGRvdXQpO1xuICBpZiAoYWN0ICYmIGFjdC5sZW5ndGggPj0gMikge1xuICAgIGFwa0FjdGl2aXR5ID0gYWN0WzFdO1xuICAgIHJldHVybiB7YXBrUGFja2FnZSwgYXBrQWN0aXZpdHl9O1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHBhcnNlIG1haW4gYWN0aXZpdHkgbmFtZSBmcm9tICcke3N0ZG91dH0nIGNvbW1hbmQgIG91dHB1dGApO1xufVxuXG4vKipcbiAqIEV4dHJhY3QgcGFja2FnZSBhbmQgbWFpbiBhY3Rpdml0eSBuYW1lIGZyb20gYXBwbGljYXRpb24gbWFuaWZlc3QgdXNpbmdcbiAqIGFwa2FuYWx5emVyIHRvb2wuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGxvY2FsQXBrIC0gVGhlIGZ1bGwgcGF0aCB0byBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICogQHBhcmFtIHtzdHJpbmd9IGFwa2FuYWx5emVyUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gYXBrYW5hbHl6ZXIgdG9vbC5cbiAqIEByZXR1cm4ge0FQS0luZm99IFRoZSBwYXJzZWQgYXBwbGljYXRpb24gaW5mby5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgZ2V0dGluZyB0aGUgZGF0YSBmcm9tIHRoZSBnaXZlblxuICogICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIHBhY2thZ2Ugb3IgaWYgdGhlIHRvb2wgaXRzZWxmXG4gKiAgICAgICAgICAgICAgICAgaXMgbm90IHByZXNlbnQgb24gdGhlIGxvY2FsIGZpbGUgc3lzdGVtLlxuICovXG5hc3luYyBmdW5jdGlvbiBleHRyYWN0QXBrSW5mb1dpdGhBcGthbmFseXplciAobG9jYWxBcGssIGFwa2FuYWx5emVyUGF0aCkge1xuICBjb25zdCBhcmdzID0gWyctaCcsICdtYW5pZmVzdCcsICdwcmludCcsIGxvY2FsQXBrXTtcbiAgbG9nLmRlYnVnKGBTdGFydGluZyAnJHthcGthbmFseXplclBhdGh9JyB3aXRoIGFyZ3MgJHtKU09OLnN0cmluZ2lmeShhcmdzKX1gKTtcbiAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKGFwa2FuYWx5emVyUGF0aCwgYXJncywge1xuICAgIHNoZWxsOiB0cnVlLFxuICAgIGN3ZDogcGF0aC5kaXJuYW1lKGFwa2FuYWx5emVyUGF0aClcbiAgfSk7XG4gIGNvbnN0IHtwa2csIGFjdGl2aXR5fSA9IHBhcnNlTWFuaWZlc3Qoc3Rkb3V0KTtcbiAgaWYgKCFwa2cpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBwYXJzZSBwYWNrYWdlIG5hbWUgZnJvbSAke3N0ZG91dH1gKTtcbiAgfVxuICBpZiAoIWFjdGl2aXR5KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgbWFpbiBhY3Rpdml0eSBuYW1lIGZyb20gJHtzdGRvdXR9YCk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBhcGtQYWNrYWdlOiBwa2csXG4gICAgYXBrQWN0aXZpdHk6IGFjdGl2aXR5LFxuICB9O1xufVxuXG4vKipcbiAqIEV4dHJhY3QgcGFja2FnZSBhbmQgbWFpbiBhY3Rpdml0eSBuYW1lIGZyb20gYXBwbGljYXRpb24gbWFuaWZlc3QuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcFBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIGFwcGxpY2F0aW9uIC5hcGsocykgcGFja2FnZVxuICogQHJldHVybiB7QVBLSW5mb30gVGhlIHBhcnNlZCBhcHBsaWNhdGlvbiBpbmZvLlxuICogQHRocm93cyB7ZXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBnZXR0aW5nIHRoZSBkYXRhIGZyb20gdGhlIGdpdmVuXG4gKiAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24gcGFja2FnZS5cbiAqL1xubWFuaWZlc3RNZXRob2RzLnBhY2thZ2VBbmRMYXVuY2hBY3Rpdml0eUZyb21NYW5pZmVzdCA9IGFzeW5jIGZ1bmN0aW9uIHBhY2thZ2VBbmRMYXVuY2hBY3Rpdml0eUZyb21NYW5pZmVzdCAoYXBwUGF0aCkge1xuICBpZiAoYXBwUGF0aC5lbmRzV2l0aChBUEtTX0VYVEVOU0lPTikpIHtcbiAgICBhcHBQYXRoID0gYXdhaXQgdGhpcy5leHRyYWN0QmFzZUFwayhhcHBQYXRoKTtcbiAgfVxuXG4gIGNvbnN0IGFwa0luZm9HZXR0ZXJzID0gW1xuICAgIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGFwa2FuYWx5emVyUGF0aCA9IGF3YWl0IGdldEFwa2FuYWx5emVyRm9yT3ModGhpcyk7XG4gICAgICByZXR1cm4gYXdhaXQgZXh0cmFjdEFwa0luZm9XaXRoQXBrYW5hbHl6ZXIoYXBwUGF0aCwgYXBrYW5hbHl6ZXJQYXRoKTtcbiAgICB9LFxuICAgIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMuaW5pdEFhcHQoKTtcbiAgICAgIHJldHVybiBhd2FpdCBleHRyYWN0QXBrSW5mb1dpdGhBcGtUb29scyhhcHBQYXRoLFxuICAgICAgICB0aGlzLmJpbmFyaWVzLmFhcHQsIHRoaXMuamFyc1snYXBwaXVtX2Fwa190b29scy5qYXInXSwgdGhpcy50bXBEaXIpO1xuICAgIH0sXG4gIF07XG5cbiAgbGV0IHNhdmVkRXJyb3I7XG4gIGZvciAoY29uc3QgaW5mb0dldHRlciBvZiBhcGtJbmZvR2V0dGVycykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7YXBrUGFja2FnZSwgYXBrQWN0aXZpdHl9ID0gYXdhaXQgaW5mb0dldHRlcigpO1xuICAgICAgbG9nLmluZm8oYFBhY2thZ2UgbmFtZTogJyR7YXBrUGFja2FnZX0nYCk7XG4gICAgICBsb2cuaW5mbyhgTWFpbiBhY3Rpdml0eSBuYW1lOiAnJHthcGtBY3Rpdml0eX0nYCk7XG4gICAgICByZXR1cm4ge2Fwa1BhY2thZ2UsIGFwa0FjdGl2aXR5fTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoaW5mb0dldHRlciAhPT0gXy5sYXN0KGFwa0luZm9HZXR0ZXJzKSkge1xuICAgICAgICBsb2cuaW5mbyhgVXNpbmcgdGhlIGFsdGVybmF0aXZlIGFjdGl2aXR5IG5hbWUgZGV0ZWN0aW9uIG1ldGhvZCBiZWNhdXNlIG9mOiAke2UubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICAgIHNhdmVkRXJyb3IgPSBlO1xuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYHBhY2thZ2VBbmRMYXVuY2hBY3Rpdml0eUZyb21NYW5pZmVzdCBmYWlsZWQuIE9yaWdpbmFsIGVycm9yOiAke3NhdmVkRXJyb3IubWVzc2FnZX1gICtcbiAgICAgICAgICAgICAgICAgIChzYXZlZEVycm9yLnN0ZGVyciA/IGA7IFN0ZEVycjogJHtzYXZlZEVycm9yLnN0ZGVycn1gIDogJycpKTtcbn07XG5cbi8qKlxuICogRXh0cmFjdCB0YXJnZXQgU0RLIHZlcnNpb24gZnJvbSBhcHBsaWNhdGlvbiBtYW5pZmVzdC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gLmFwayhzKSBwYWNrYWdlLlxuICogQHJldHVybiB7bnVtYmVyfSBUaGUgdmVyc2lvbiBvZiB0aGUgdGFyZ2V0IFNESy5cbiAqIEB0aHJvd3Mge2Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgZ2V0dGluZyB0aGUgZGF0YSBmcm9tIHRoZSBnaXZlblxuICogICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy50YXJnZXRTZGtWZXJzaW9uRnJvbU1hbmlmZXN0ID0gYXN5bmMgZnVuY3Rpb24gdGFyZ2V0U2RrVmVyc2lvbkZyb21NYW5pZmVzdCAoYXBwUGF0aCkge1xuICBjb25zdCBvcmlnaW5hbEFwcFBhdGggPSBhcHBQYXRoO1xuICBpZiAoYXBwUGF0aC5lbmRzV2l0aChBUEtTX0VYVEVOU0lPTikpIHtcbiAgICBhcHBQYXRoID0gYXdhaXQgdGhpcy5leHRyYWN0QmFzZUFwayhhcHBQYXRoKTtcbiAgfVxuXG4gIGxvZy5pbmZvKCdFeHRyYWN0aW5nIHRhcmdldCBTREsgdmVyc2lvbiBmcm9tIHRoZSBtYW5pZmVzdCcpO1xuICB0cnkge1xuICAgIGNvbnN0IGFwa2FuYWx5emVyUGF0aCA9IGF3YWl0IGdldEFwa2FuYWx5emVyRm9yT3ModGhpcyk7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKGFwa2FuYWx5emVyUGF0aCwgWydtYW5pZmVzdCcsICd0YXJnZXQtc2RrJywgYXBwUGF0aF0sIHtcbiAgICAgIHNoZWxsOiB0cnVlLFxuICAgICAgY3dkOiBwYXRoLmRpcm5hbWUoYXBrYW5hbHl6ZXJQYXRoKSxcbiAgICB9KTtcbiAgICBpZiAoaXNOYU4oXy50cmltKHN0ZG91dCkpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBwYXJzZSB0aGUgbWluaW11bSBTREsgdmVyc2lvbiBmcm9tICcke3N0ZG91dH0nYCk7XG4gICAgfVxuICAgIHJldHVybiBwYXJzZUludChfLnRyaW0oc3Rkb3V0KSwgMTApO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmluZm8oYENhbm5vdCBleHRyYWN0IHRhcmdldFNka1ZlcnNpb24gdXNpbmcgYXBrYW5hbHl6ZXIuIEZhbGxpbmcgYmFjayB0byBhYXB0LiBgICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgYXdhaXQgdGhpcy5pbml0QWFwdCgpO1xuICAgIGNvbnN0IGFyZ3MgPSBbJ2R1bXAnLCAnYmFkZ2luZycsIGFwcFBhdGhdO1xuICAgIGxldCBvdXRwdXQ7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLmFhcHQsIGFyZ3MpO1xuICAgICAgb3V0cHV0ID0gc3Rkb3V0O1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmV0Y2hpbmcgdGFyZ2V0U2RrVmVyc2lvbiBmcm9tICcke29yaWdpbmFsQXBwUGF0aH0nIGZhaWxlZC4gYCArXG4gICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICAgIGNvbnN0IHRhcmdldFNka1ZlcnNpb24gPSBuZXcgUmVnRXhwKC90YXJnZXRTZGtWZXJzaW9uOicoW14nXSspJy9nKS5leGVjKG91dHB1dCk7XG4gICAgaWYgKCF0YXJnZXRTZGtWZXJzaW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHRhcmdldFNka1ZlcnNpb24gaXMgbm90IHNwZWNpZmllZCBpbiB0aGUgJyR7b3JpZ2luYWxBcHBQYXRofScgYXBwbGljYXRpb25gKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcnNlSW50KHRhcmdldFNka1ZlcnNpb25bMV0sIDEwKTtcbiAgfVxufTtcblxuLyoqXG4gKiBFeHRyYWN0IHRhcmdldCBTREsgdmVyc2lvbiBmcm9tIHBhY2thZ2UgaW5mb3JtYXRpb24uXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBrZyAtIFRoZSBjbGFzcyBuYW1lIG9mIHRoZSBwYWNrYWdlIGluc3RhbGxlZCBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiBAcGFyYW0gez9zdHJpbmd9IGNtZE91dHB1dCAtIE9wdGlvbmFsIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSBvdXRwdXQgb2ZcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2R1bXBzeXMgcGFja2FnZV8gY29tbWFuZC4gSXQgbWF5IHNwZWVkIHVwIHRoZSBtZXRob2QgZXhlY3V0aW9uLlxuICogQHJldHVybiB7bnVtYmVyfSBUaGUgdmVyc2lvbiBvZiB0aGUgdGFyZ2V0IFNESy5cbiAqL1xubWFuaWZlc3RNZXRob2RzLnRhcmdldFNka1ZlcnNpb25Vc2luZ1BLRyA9IGFzeW5jIGZ1bmN0aW9uIHRhcmdldFNka1ZlcnNpb25Vc2luZ1BLRyAocGtnLCBjbWRPdXRwdXQgPSBudWxsKSB7XG4gIGxldCBzdGRvdXQgPSBjbWRPdXRwdXQgfHwgYXdhaXQgdGhpcy5zaGVsbChbJ2R1bXBzeXMnLCAncGFja2FnZScsIHBrZ10pO1xuICBsZXQgdGFyZ2V0U2RrVmVyc2lvbiA9IG5ldyBSZWdFeHAoL3RhcmdldFNkaz0oW15cXHNcXHNdKykvZykuZXhlYyhzdGRvdXQpO1xuICBpZiAodGFyZ2V0U2RrVmVyc2lvbiAmJiB0YXJnZXRTZGtWZXJzaW9uLmxlbmd0aCA+PSAyKSB7XG4gICAgdGFyZ2V0U2RrVmVyc2lvbiA9IHRhcmdldFNka1ZlcnNpb25bMV07XG4gIH0gZWxzZSB7XG4gICAgLy8gdGFyZ2V0U2RrIG5vdCBmb3VuZCBpbiB0aGUgZHVtcCwgYXNzaWduaW5nIDAgdG8gdGFyZ2V0U2RrVmVyc2lvblxuICAgIHRhcmdldFNka1ZlcnNpb24gPSAwO1xuICB9XG4gIHJldHVybiBwYXJzZUludCh0YXJnZXRTZGtWZXJzaW9uLCAxMCk7XG59O1xuXG4vKipcbiAqIENyZWF0ZSBiaW5hcnkgcmVwcmVzZW50YXRpb24gb2YgcGFja2FnZSBtYW5pZmVzdCAodXN1YWxseSBBbmRyb2lkTWFuaWZlc3QueG1sKS5cbiAqIGAke21hbmlmZXN0fS5hcGtgIGZpbGUgd2lsbCBiZSBjcmVhdGVkIGFzIHRoZSByZXN1bHQgb2YgdGhpcyBtZXRob2RcbiAqIGNvbnRhaW5pbmcgdGhlIGNvbXBpbGVkIG1hbmlmZXN0LlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBtYW5pZmVzdCAtIEZ1bGwgcGF0aCB0byB0aGUgaW5pdGlhbCBtYW5pZmVzdCB0ZW1wbGF0ZVxuICogQHBhcmFtIHtzdHJpbmd9IG1hbmlmZXN0UGFja2FnZSAtIFRoZSBuYW1lIG9mIHRoZSBtYW5pZmVzdCBwYWNrYWdlXG4gKiBAcGFyYW0ge3N0cmluZ30gdGFyZ2V0UGFja2FnZSAtIFRoZSBuYW1lIG9mIHRoZSBkZXN0aW5hdGlvbiBwYWNrYWdlXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy5jb21waWxlTWFuaWZlc3QgPSBhc3luYyBmdW5jdGlvbiBjb21waWxlTWFuaWZlc3QgKG1hbmlmZXN0LCBtYW5pZmVzdFBhY2thZ2UsIHRhcmdldFBhY2thZ2UpIHtcbiAgY29uc3Qge3BsYXRmb3JtLCBwbGF0Zm9ybVBhdGh9ID0gYXdhaXQgZ2V0QW5kcm9pZFBsYXRmb3JtQW5kUGF0aCgpO1xuICBpZiAoIXBsYXRmb3JtKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgY29tcGlsZSB0aGUgbWFuaWZlc3QuIFRoZSByZXF1aXJlZCBwbGF0Zm9ybSBkb2VzIG5vdCBleGlzdCAoQVBJIGxldmVsID49IDE3KScpO1xuICB9XG4gIGNvbnN0IHJlc3VsdFBhdGggPSBgJHttYW5pZmVzdH0uYXBrYDtcbiAgY29uc3QgYW5kcm9pZEphclBhdGggPSBwYXRoLnJlc29sdmUocGxhdGZvcm1QYXRoLCAnYW5kcm9pZC5qYXInKTtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhyZXN1bHRQYXRoKSkge1xuICAgIGF3YWl0IGZzLnJpbXJhZihyZXN1bHRQYXRoKTtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuaW5pdEFhcHQyKCk7XG4gICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vc3R1ZGlvL2NvbW1hbmQtbGluZS9hYXB0MlxuICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICAnbGluaycsXG4gICAgICAnLW8nLCByZXN1bHRQYXRoLFxuICAgICAgJy0tbWFuaWZlc3QnLCBtYW5pZmVzdCxcbiAgICAgICctLXJlbmFtZS1tYW5pZmVzdC1wYWNrYWdlJywgbWFuaWZlc3RQYWNrYWdlLFxuICAgICAgJy0tcmVuYW1lLWluc3RydW1lbnRhdGlvbi10YXJnZXQtcGFja2FnZScsIHRhcmdldFBhY2thZ2UsXG4gICAgICAnLUknLCBhbmRyb2lkSmFyUGF0aCxcbiAgICAgICctdicsXG4gICAgXTtcbiAgICBsb2cuZGVidWcoYENvbXBpbGluZyB0aGUgbWFuaWZlc3QgdXNpbmcgJyR7cXVvdGUoW3RoaXMuYmluYXJpZXMuYWFwdDIsIC4uLmFyZ3NdKX0nYCk7XG4gICAgYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLmFhcHQyLCBhcmdzKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5kZWJ1ZygnQ2Fubm90IGNvbXBpbGUgdGhlIG1hbmlmZXN0IHVzaW5nIGFhcHQyLiBEZWZhdWx0aW5nIHRvIGFhcHQuICcgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Uuc3RkZXJyIHx8IGUubWVzc2FnZX1gKTtcbiAgICBhd2FpdCB0aGlzLmluaXRBYXB0KCk7XG4gICAgY29uc3QgYXJncyA9IFtcbiAgICAgICdwYWNrYWdlJyxcbiAgICAgICctTScsIG1hbmlmZXN0LFxuICAgICAgJy0tcmVuYW1lLW1hbmlmZXN0LXBhY2thZ2UnLCBtYW5pZmVzdFBhY2thZ2UsXG4gICAgICAnLS1yZW5hbWUtaW5zdHJ1bWVudGF0aW9uLXRhcmdldC1wYWNrYWdlJywgdGFyZ2V0UGFja2FnZSxcbiAgICAgICctSScsIGFuZHJvaWRKYXJQYXRoLFxuICAgICAgJy1GJywgcmVzdWx0UGF0aCxcbiAgICAgICctZicsXG4gICAgXTtcbiAgICBsb2cuZGVidWcoYENvbXBpbGluZyB0aGUgbWFuaWZlc3QgdXNpbmcgJyR7cXVvdGUoW3RoaXMuYmluYXJpZXMuYWFwdCwgLi4uYXJnc10pfSdgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLmFhcHQsIGFyZ3MpO1xuICAgIH0gY2F0Y2ggKGUxKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBjb21waWxlIHRoZSBtYW5pZmVzdC4gT3JpZ2luYWwgZXJyb3I6ICR7ZTEuc3RkZXJyIHx8IGUxLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG4gIGxvZy5kZWJ1ZyhgQ29tcGlsZWQgdGhlIG1hbmlmZXN0IGF0ICcke3Jlc3VsdFBhdGh9J2ApO1xufTtcblxuLyoqXG4gKiBSZXBsYWNlL2luc2VydCB0aGUgc3BlY2lhbGx5IHByZWNvbXBpbGVkIG1hbmlmZXN0IGZpbGUgaW50byB0aGVcbiAqIHBhcnRpY3VsYXIgcGFja2FnZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gbWFuaWZlc3QgLSBGdWxsIHBhdGggdG8gdGhlIHByZWNvbXBpbGVkIG1hbmlmZXN0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkIGJ5IGBjb21waWxlTWFuaWZlc3RgIG1ldGhvZCBjYWxsXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRob3V0IC5hcGsgZXh0ZW5zaW9uXG4gKiBAcGFyYW0ge3N0cmluZ30gc3JjQXBrIC0gRnVsbCBwYXRoIHRvIHRoZSBleGlzdGluZyB2YWxpZCBhcHBsaWNhdGlvbiBwYWNrYWdlLCB3aGVyZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMgbWFuaWZlc3QgaGFzIHRvIGJlIGluc2V0cmVkIHRvLiBUaGlzIHBhY2thZ2VcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsIE5PVCBiZSBtb2RpZmllZC5cbiAqIEBwYXJhbSB7c3RyaW5nfSBkc3RBcGsgLSBGdWxsIHBhdGggdG8gdGhlIHJlc3VsdGluZyBwYWNrYWdlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBmaWxlIHdpbGwgYmUgb3ZlcnJpZGRlbiBpZiBpdCBhbHJlYWR5IGV4aXN0cy5cbiAqL1xubWFuaWZlc3RNZXRob2RzLmluc2VydE1hbmlmZXN0ID0gYXN5bmMgZnVuY3Rpb24gaW5zZXJ0TWFuaWZlc3QgKG1hbmlmZXN0LCBzcmNBcGssIGRzdEFwaykge1xuICBsb2cuZGVidWcoYEluc2VydGluZyBtYW5pZmVzdCAnJHttYW5pZmVzdH0nLCBzcmM6ICcke3NyY0Fwa30nLCBkc3Q6ICcke2RzdEFwa30nYCk7XG4gIGF3YWl0IHppcC5hc3NlcnRWYWxpZFppcChzcmNBcGspO1xuICBhd2FpdCB1bnppcEZpbGUoYCR7bWFuaWZlc3R9LmFwa2ApO1xuICBjb25zdCBtYW5pZmVzdE5hbWUgPSBwYXRoLmJhc2VuYW1lKG1hbmlmZXN0KTtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmluaXRBYXB0KCk7XG4gICAgYXdhaXQgZnMuY29weUZpbGUoc3JjQXBrLCBkc3RBcGspO1xuICAgIGxvZy5kZWJ1ZygnTW92aW5nIG1hbmlmZXN0Jyk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0LCBbXG4gICAgICAgICdyZW1vdmUnLCBkc3RBcGssIG1hbmlmZXN0TmFtZVxuICAgICAgXSk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0LCBbXG4gICAgICAnYWRkJywgZHN0QXBrLCBtYW5pZmVzdE5hbWVcbiAgICBdLCB7Y3dkOiBwYXRoLmRpcm5hbWUobWFuaWZlc3QpfSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZGVidWcoJ0Nhbm5vdCBpbnNlcnQgbWFuaWZlc3QgdXNpbmcgYWFwdC4gRGVmYXVsdGluZyB0byB6aXAuICcgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Uuc3RkZXJyIHx8IGUubWVzc2FnZX1gKTtcbiAgICBjb25zdCB0bXBSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFVuZm9ydHVuYXRlbHkgTm9kZUpTIGRvZXMgbm90IHByb3ZpZGUgYW55IHJlbGlhYmxlIG1ldGhvZHNcbiAgICAgIC8vIHRvIHJlcGxhY2UgZmlsZXMgaW5zaWRlIHppcCBhcmNoaXZlcyB3aXRob3V0IGxvYWRpbmcgdGhlXG4gICAgICAvLyB3aG9sZSBhcmNoaXZlIGNvbnRlbnQgaW50byBSQU1cbiAgICAgIGxvZy5kZWJ1ZyhgRXh0cmFjdGluZyB0aGUgc291cmNlIGFwayBhdCAnJHtzcmNBcGt9J2ApO1xuICAgICAgYXdhaXQgemlwLmV4dHJhY3RBbGxUbyhzcmNBcGssIHRtcFJvb3QpO1xuICAgICAgbG9nLmRlYnVnKCdNb3ZpbmcgbWFuaWZlc3QnKTtcbiAgICAgIGF3YWl0IGZzLm12KG1hbmlmZXN0LCBwYXRoLnJlc29sdmUodG1wUm9vdCwgbWFuaWZlc3ROYW1lKSk7XG4gICAgICBsb2cuZGVidWcoYENvbGxlY3RpbmcgdGhlIGRlc3RpbmF0aW9uIGFwayBhdCAnJHtkc3RBcGt9J2ApO1xuICAgICAgYXdhaXQgemlwLnRvQXJjaGl2ZShkc3RBcGssIHtcbiAgICAgICAgY3dkOiB0bXBSb290LFxuICAgICAgfSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IGZzLnJpbXJhZih0bXBSb290KTtcbiAgICB9XG4gIH1cbiAgbG9nLmRlYnVnKGBNYW5pZmVzdCBpbnNlcnRpb24gaW50byAnJHtkc3RBcGt9JyBpcyBjb21wbGV0ZWRgKTtcbn07XG5cbi8qKlxuICogQ2hlY2sgd2hldGhlciBwYWNrYWdlIG1hbmlmZXN0IGNvbnRhaW5zIEludGVybmV0IHBlcm1pc3Npb25zLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byAuYXBrKHMpIHBhY2thZ2UuXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBtYW5pZmVzdCByZXF1aXJlcyBJbnRlcm5ldCBhY2Nlc3MgcGVybWlzc2lvbi5cbiAqL1xubWFuaWZlc3RNZXRob2RzLmhhc0ludGVybmV0UGVybWlzc2lvbkZyb21NYW5pZmVzdCA9IGFzeW5jIGZ1bmN0aW9uIGhhc0ludGVybmV0UGVybWlzc2lvbkZyb21NYW5pZmVzdCAoYXBwUGF0aCkge1xuICBjb25zdCBvcmlnaW5hbEFwcFBhdGggPSBhcHBQYXRoO1xuXG4gIGlmIChhcHBQYXRoLmVuZHNXaXRoKEFQS1NfRVhURU5TSU9OKSkge1xuICAgIGFwcFBhdGggPSBhd2FpdCB0aGlzLmV4dHJhY3RCYXNlQXBrKGFwcFBhdGgpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBDaGVja2luZyBpZiAnJHtvcmlnaW5hbEFwcFBhdGh9JyByZXF1aXJlcyBpbnRlcm5ldCBhY2Nlc3MgcGVybWlzc2lvbiBpbiB0aGUgbWFuaWZlc3RgKTtcbiAgY29uc3QgaW50ZXJuZXRQZXJtaXNzaW9uUGF0dGVybiA9IC9cXGJhbmRyb2lkXFwucGVybWlzc2lvblxcLklOVEVSTkVUXFxiLztcbiAgdHJ5IHtcbiAgICBjb25zdCBhcGthbmFseXplclBhdGggPSBhd2FpdCBnZXRBcGthbmFseXplckZvck9zKHRoaXMpO1xuICAgIGNvbnN0IGFyZ3MgPSBbJ21hbmlmZXN0JywgJ3Blcm1pc3Npb25zJywgYXBwUGF0aF07XG4gICAgbG9nLmRlYnVnKGBTdGFydGluZyAnJHthcGthbmFseXplclBhdGh9JyB3aXRoIGFyZ3MgJHtKU09OLnN0cmluZ2lmeShhcmdzKX1gKTtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoYXBrYW5hbHl6ZXJQYXRoLCBhcmdzLCB7XG4gICAgICBzaGVsbDogdHJ1ZSxcbiAgICAgIGN3ZDogcGF0aC5kaXJuYW1lKGFwa2FuYWx5emVyUGF0aCksXG4gICAgfSk7XG4gICAgcmV0dXJuIGludGVybmV0UGVybWlzc2lvblBhdHRlcm4udGVzdChzdGRvdXQpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKCdDYW5ub3QgZ2V0IGFwayBwZXJtaXNzaW9ucyB1c2luZyBhcGthbmFseXplci4gRmFsbGluZyBiYWNrIHRvIGFhcHQuICcgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Uuc3RkZXJyIHx8IGUubWVzc2FnZX1gKTtcbiAgICBhd2FpdCB0aGlzLmluaXRBYXB0KCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLmFhcHQsIFsnZHVtcCcsICdiYWRnaW5nJywgYXBwUGF0aF0pO1xuICAgICAgcmV0dXJuIGludGVybmV0UGVybWlzc2lvblBhdHRlcm4udGVzdChzdGRvdXQpO1xuICAgIH0gY2F0Y2ggKGUxKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBjaGVjayBpZiAnJHtvcmlnaW5hbEFwcFBhdGh9JyByZXF1aXJlcyBpbnRlcm5ldCBhY2Nlc3MgcGVybWlzc2lvbi4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UxLnN0ZGVyciB8fCBlMS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQgbWFuaWZlc3RNZXRob2RzO1xuIl0sImZpbGUiOiJsaWIvdG9vbHMvYW5kcm9pZC1tYW5pZmVzdC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
